(()=>{"use strict";var e={154(e,t,a){a.d(t,{A:()=>i});const s=(e={},t)=>"checkbox"===e.type?!!t:t,n=(e,t={},a={})=>Object.prototype.hasOwnProperty.call(a,e)?s(t,a[e]):void 0!==t.default?s(t,t.default):s(t,"checkbox"!==t.type&&"");class i{constructor(e,t={},a={}){this.slug=e,this.descriptor=t||{},this.details=a||{}}getSlug(){return this.slug}getLabel(){return this.descriptor.label||this.slug}getDescription(){return this.descriptor.description||""}requiresAuth(){return!(!this.descriptor.requires_auth&&!this.descriptor.requiresAuth)}getDisplaySettings(e=null,t={}){const a={};if(Array.isArray(e)&&e.length>0)return e.forEach(e=>{a[e.key]={label:e.label,value:e.display_value||e.value}}),a;const s=this.details?.settings||{};return Object.entries(s).forEach(([e,s])=>{a[e]={label:s.label||e,value:n(e,s,t)}}),a}normalizeForForm(e={},t={}){const a={...e},s=t||this.details?.settings||{};return Object.entries(s).forEach(([t,s])=>{Object.prototype.hasOwnProperty.call(a,t)?"checkbox"===s.type&&(a[t]=!!a[t]):a[t]=n(t,s,e)}),a}sanitizeForAPI(e={},t={}){const a=t||this.details?.settings||{},s={};return Object.entries(e).forEach(([e,t])=>{const n=a[e];if(n)switch(n.type){case"checkbox":s[e]=!!t;break;case"select":""===t||isNaN(t)?s[e]=t:s[e]=parseInt(t,10);break;default:s[e]=t}else s[e]=t}),s}validate(e={}){return{valid:!0,errors:{}}}renderSettingsEditor(e={}){return null}}},848(e,t,a){a.d(t,{$P:()=>r,default:()=>l});var s=a(154);const n=new Map,i=new Map,r=(e,t)=>{n.set(e,t)},l=(e,t={},a={})=>{const r=`${e}:${JSON.stringify(a||{})}`;if(i.has(r))return i.get(r);const l=new(n.get(e)||n.get(t?.type)||s.A)(e,t,a);return i.set(r,l),l}}},t={};function a(s){var n=t[s];if(void 0!==n)return n.exports;var i=t[s]={exports:{}};return e[s](i,i.exports,a),i.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const s=window.wp.element,n=window.wp.domReady;var i=a.n(n);const r=window.React,l=window.ReactJSXRuntime;var o=r.createContext(void 0),c=e=>{const t=r.useContext(o);if(e)return e;if(!t)throw new Error("No QueryClient set, use QueryClientProvider to set one");return t},d=({client:e,children:t})=>(r.useEffect(()=>(e.mount(),()=>{e.unmount()}),[e]),(0,l.jsx)(o.Provider,{value:e,children:t})),u=function(){return null},h={setTimeout:(e,t)=>setTimeout(e,t),clearTimeout:e=>clearTimeout(e),setInterval:(e,t)=>setInterval(e,t),clearInterval:e=>clearInterval(e)},p=new class{#e=h;#t=!1;setTimeoutProvider(e){this.#e=e}setTimeout(e,t){return this.#e.setTimeout(e,t)}clearTimeout(e){this.#e.clearTimeout(e)}setInterval(e,t){return this.#e.setInterval(e,t)}clearInterval(e){this.#e.clearInterval(e)}},m="undefined"==typeof window||"Deno"in globalThis;function f(){}function y(e){return"number"==typeof e&&e>=0&&e!==1/0}function g(e,t){return Math.max(e+(t||0)-Date.now(),0)}function _(e,t){return"function"==typeof e?e(t):e}function v(e,t){return"function"==typeof e?e(t):e}function b(e,t){const{type:a="all",exact:s,fetchStatus:n,predicate:i,queryKey:r,stale:l}=e;if(r)if(s){if(t.queryHash!==w(r,t.options))return!1}else if(!C(t.queryKey,r))return!1;if("all"!==a){const e=t.isActive();if("active"===a&&!e)return!1;if("inactive"===a&&e)return!1}return!("boolean"==typeof l&&t.isStale()!==l||n&&n!==t.state.fetchStatus||i&&!i(t))}function x(e,t){const{exact:a,status:s,predicate:n,mutationKey:i}=e;if(i){if(!t.options.mutationKey)return!1;if(a){if(j(t.options.mutationKey)!==j(i))return!1}else if(!C(t.options.mutationKey,i))return!1}return!(s&&t.state.status!==s||n&&!n(t))}function w(e,t){return(t?.queryKeyHashFn||j)(e)}function j(e){return JSON.stringify(e,(e,t)=>D(t)?Object.keys(t).sort().reduce((e,a)=>(e[a]=t[a],e),{}):t)}function C(e,t){return e===t||typeof e==typeof t&&!(!e||!t||"object"!=typeof e||"object"!=typeof t)&&Object.keys(t).every(a=>C(e[a],t[a]))}var S=Object.prototype.hasOwnProperty;function N(e,t){if(e===t)return e;const a=O(e)&&O(t);if(!(a||D(e)&&D(t)))return t;const s=(a?e:Object.keys(e)).length,n=a?t:Object.keys(t),i=n.length,r=a?new Array(i):{};let l=0;for(let o=0;o<i;o++){const i=a?o:n[o],c=e[i],d=t[i];if(c===d){r[i]=c,(a?o<s:S.call(e,i))&&l++;continue}if(null===c||null===d||"object"!=typeof c||"object"!=typeof d){r[i]=d;continue}const u=N(c,d);r[i]=u,u===c&&l++}return s===i&&l===s?e:r}function I(e,t){if(!t||Object.keys(e).length!==Object.keys(t).length)return!1;for(const a in e)if(e[a]!==t[a])return!1;return!0}function O(e){return Array.isArray(e)&&e.length===Object.keys(e).length}function D(e){if(!k(e))return!1;const t=e.constructor;if(void 0===t)return!0;const a=t.prototype;return!!k(a)&&!!a.hasOwnProperty("isPrototypeOf")&&Object.getPrototypeOf(e)===Object.prototype}function k(e){return"[object Object]"===Object.prototype.toString.call(e)}function E(e,t,a){return"function"==typeof a.structuralSharing?a.structuralSharing(e,t):!1!==a.structuralSharing?N(e,t):t}function R(e,t,a=0){const s=[...e,t];return a&&s.length>a?s.slice(1):s}function A(e,t,a=0){const s=[t,...e];return a&&s.length>a?s.slice(0,-1):s}var F=Symbol();function P(e,t){return!e.queryFn&&t?.initialPromise?()=>t.initialPromise:e.queryFn&&e.queryFn!==F?e.queryFn:()=>Promise.reject(new Error(`Missing queryFn: '${e.queryHash}'`))}function T(e,t){return"function"==typeof e?e(...t):!!e}var q=function(e){setTimeout(e,0)},M=function(){let e=[],t=0,a=e=>{e()},s=e=>{e()},n=q;const i=s=>{t?e.push(s):n(()=>{a(s)})};return{batch:i=>{let r;t++;try{r=i()}finally{t--,t||(()=>{const t=e;e=[],t.length&&n(()=>{s(()=>{t.forEach(e=>{a(e)})})})})()}return r},batchCalls:e=>(...t)=>{i(()=>{e(...t)})},schedule:i,setNotifyFunction:e=>{a=e},setBatchNotifyFunction:e=>{s=e},setScheduler:e=>{n=e}}}(),Q=class{constructor(){this.listeners=new Set,this.subscribe=this.subscribe.bind(this)}subscribe(e){return this.listeners.add(e),this.onSubscribe(),()=>{this.listeners.delete(e),this.onUnsubscribe()}}hasListeners(){return this.listeners.size>0}onSubscribe(){}onUnsubscribe(){}},L=new class extends Q{#a;#s;#n;constructor(){super(),this.#n=e=>{if(!m&&window.addEventListener){const t=()=>e();return window.addEventListener("visibilitychange",t,!1),()=>{window.removeEventListener("visibilitychange",t)}}}}onSubscribe(){this.#s||this.setEventListener(this.#n)}onUnsubscribe(){this.hasListeners()||(this.#s?.(),this.#s=void 0)}setEventListener(e){this.#n=e,this.#s?.(),this.#s=e(e=>{"boolean"==typeof e?this.setFocused(e):this.onFocus()})}setFocused(e){this.#a!==e&&(this.#a=e,this.onFocus())}onFocus(){const e=this.isFocused();this.listeners.forEach(t=>{t(e)})}isFocused(){return"boolean"==typeof this.#a?this.#a:"hidden"!==globalThis.document?.visibilityState}},B=new class extends Q{#i=!0;#s;#n;constructor(){super(),this.#n=e=>{if(!m&&window.addEventListener){const t=()=>e(!0),a=()=>e(!1);return window.addEventListener("online",t,!1),window.addEventListener("offline",a,!1),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",a)}}}}onSubscribe(){this.#s||this.setEventListener(this.#n)}onUnsubscribe(){this.hasListeners()||(this.#s?.(),this.#s=void 0)}setEventListener(e){this.#n=e,this.#s?.(),this.#s=e(this.setOnline.bind(this))}setOnline(e){this.#i!==e&&(this.#i=e,this.listeners.forEach(t=>{t(e)}))}isOnline(){return this.#i}};function U(){let e,t;const a=new Promise((a,s)=>{e=a,t=s});function s(e){Object.assign(a,e),delete a.resolve,delete a.reject}return a.status="pending",a.catch(()=>{}),a.resolve=t=>{s({status:"fulfilled",value:t}),e(t)},a.reject=e=>{s({status:"rejected",reason:e}),t(e)},a}function K(e){return Math.min(1e3*2**e,3e4)}function z(e){return"online"!==(e??"online")||B.isOnline()}var H=class extends Error{constructor(e){super("CancelledError"),this.revert=e?.revert,this.silent=e?.silent}};function $(e){let t,a=!1,s=0;const n=U(),i=()=>"pending"!==n.status,r=()=>L.isFocused()&&("always"===e.networkMode||B.isOnline())&&e.canRun(),l=()=>z(e.networkMode)&&e.canRun(),o=e=>{i()||(t?.(),n.resolve(e))},c=e=>{i()||(t?.(),n.reject(e))},d=()=>new Promise(a=>{t=e=>{(i()||r())&&a(e)},e.onPause?.()}).then(()=>{t=void 0,i()||e.onContinue?.()}),u=()=>{if(i())return;let t;const n=0===s?e.initialPromise:void 0;try{t=n??e.fn()}catch(e){t=Promise.reject(e)}Promise.resolve(t).then(o).catch(t=>{if(i())return;const n=e.retry??(m?0:3),l=e.retryDelay??K,o="function"==typeof l?l(s,t):l,h=!0===n||"number"==typeof n&&s<n||"function"==typeof n&&n(s,t);var f;!a&&h?(s++,e.onFail?.(s,t),(f=o,new Promise(e=>{p.setTimeout(e,f)})).then(()=>r()?void 0:d()).then(()=>{a?c(t):u()})):c(t)})};return{promise:n,status:()=>n.status,cancel:t=>{if(!i()){const a=new H(t);c(a),e.onCancel?.(a)}},continue:()=>(t?.(),n),cancelRetry:()=>{a=!0},continueRetry:()=>{a=!1},canStart:l,start:()=>(l()?u():d().then(u),n)}}var G=class{#r;destroy(){this.clearGcTimeout()}scheduleGc(){this.clearGcTimeout(),y(this.gcTime)&&(this.#r=p.setTimeout(()=>{this.optionalRemove()},this.gcTime))}updateGcTime(e){this.gcTime=Math.max(this.gcTime||0,e??(m?1/0:3e5))}clearGcTimeout(){this.#r&&(p.clearTimeout(this.#r),this.#r=void 0)}},V=class extends G{#l;#o;#c;#d;#u;#h;#p;constructor(e){super(),this.#p=!1,this.#h=e.defaultOptions,this.setOptions(e.options),this.observers=[],this.#d=e.client,this.#c=this.#d.getQueryCache(),this.queryKey=e.queryKey,this.queryHash=e.queryHash,this.#l=Y(this.options),this.state=e.state??this.#l,this.scheduleGc()}get meta(){return this.options.meta}get promise(){return this.#u?.promise}setOptions(e){if(this.options={...this.#h,...e},this.updateGcTime(this.options.gcTime),this.state&&void 0===this.state.data){const e=Y(this.options);void 0!==e.data&&(this.setState(J(e.data,e.dataUpdatedAt)),this.#l=e)}}optionalRemove(){this.observers.length||"idle"!==this.state.fetchStatus||this.#c.remove(this)}setData(e,t){const a=E(this.state.data,e,this.options);return this.#m({data:a,type:"success",dataUpdatedAt:t?.updatedAt,manual:t?.manual}),a}setState(e,t){this.#m({type:"setState",state:e,setStateOptions:t})}cancel(e){const t=this.#u?.promise;return this.#u?.cancel(e),t?t.then(f).catch(f):Promise.resolve()}destroy(){super.destroy(),this.cancel({silent:!0})}reset(){this.destroy(),this.setState(this.#l)}isActive(){return this.observers.some(e=>!1!==v(e.options.enabled,this))}isDisabled(){return this.getObserversCount()>0?!this.isActive():this.options.queryFn===F||this.state.dataUpdateCount+this.state.errorUpdateCount===0}isStatic(){return this.getObserversCount()>0&&this.observers.some(e=>"static"===_(e.options.staleTime,this))}isStale(){return this.getObserversCount()>0?this.observers.some(e=>e.getCurrentResult().isStale):void 0===this.state.data||this.state.isInvalidated}isStaleByTime(e=0){return void 0===this.state.data||"static"!==e&&(!!this.state.isInvalidated||!g(this.state.dataUpdatedAt,e))}onFocus(){const e=this.observers.find(e=>e.shouldFetchOnWindowFocus());e?.refetch({cancelRefetch:!1}),this.#u?.continue()}onOnline(){const e=this.observers.find(e=>e.shouldFetchOnReconnect());e?.refetch({cancelRefetch:!1}),this.#u?.continue()}addObserver(e){this.observers.includes(e)||(this.observers.push(e),this.clearGcTimeout(),this.#c.notify({type:"observerAdded",query:this,observer:e}))}removeObserver(e){this.observers.includes(e)&&(this.observers=this.observers.filter(t=>t!==e),this.observers.length||(this.#u&&(this.#p?this.#u.cancel({revert:!0}):this.#u.cancelRetry()),this.scheduleGc()),this.#c.notify({type:"observerRemoved",query:this,observer:e}))}getObserversCount(){return this.observers.length}invalidate(){this.state.isInvalidated||this.#m({type:"invalidate"})}async fetch(e,t){if("idle"!==this.state.fetchStatus&&"rejected"!==this.#u?.status())if(void 0!==this.state.data&&t?.cancelRefetch)this.cancel({silent:!0});else if(this.#u)return this.#u.continueRetry(),this.#u.promise;if(e&&this.setOptions(e),!this.options.queryFn){const e=this.observers.find(e=>e.options.queryFn);e&&this.setOptions(e.options)}const a=new AbortController,s=e=>{Object.defineProperty(e,"signal",{enumerable:!0,get:()=>(this.#p=!0,a.signal)})},n=()=>{const e=P(this.options,t),a=(()=>{const e={client:this.#d,queryKey:this.queryKey,meta:this.meta};return s(e),e})();return this.#p=!1,this.options.persister?this.options.persister(e,a,this):e(a)},i=(()=>{const e={fetchOptions:t,options:this.options,queryKey:this.queryKey,client:this.#d,state:this.state,fetchFn:n};return s(e),e})();this.options.behavior?.onFetch(i,this),this.#o=this.state,"idle"!==this.state.fetchStatus&&this.state.fetchMeta===i.fetchOptions?.meta||this.#m({type:"fetch",meta:i.fetchOptions?.meta}),this.#u=$({initialPromise:t?.initialPromise,fn:i.fetchFn,onCancel:e=>{e instanceof H&&e.revert&&this.setState({...this.#o,fetchStatus:"idle"}),a.abort()},onFail:(e,t)=>{this.#m({type:"failed",failureCount:e,error:t})},onPause:()=>{this.#m({type:"pause"})},onContinue:()=>{this.#m({type:"continue"})},retry:i.options.retry,retryDelay:i.options.retryDelay,networkMode:i.options.networkMode,canRun:()=>!0});try{const e=await this.#u.start();if(void 0===e)throw new Error(`${this.queryHash} data is undefined`);return this.setData(e),this.#c.config.onSuccess?.(e,this),this.#c.config.onSettled?.(e,this.state.error,this),e}catch(e){if(e instanceof H){if(e.silent)return this.#u.promise;if(e.revert){if(void 0===this.state.data)throw e;return this.state.data}}throw this.#m({type:"error",error:e}),this.#c.config.onError?.(e,this),this.#c.config.onSettled?.(this.state.data,e,this),e}finally{this.scheduleGc()}}#m(e){this.state=(t=>{switch(e.type){case"failed":return{...t,fetchFailureCount:e.failureCount,fetchFailureReason:e.error};case"pause":return{...t,fetchStatus:"paused"};case"continue":return{...t,fetchStatus:"fetching"};case"fetch":return{...t,...W(t.data,this.options),fetchMeta:e.meta??null};case"success":const a={...t,...J(e.data,e.dataUpdatedAt),dataUpdateCount:t.dataUpdateCount+1,...!e.manual&&{fetchStatus:"idle",fetchFailureCount:0,fetchFailureReason:null}};return this.#o=e.manual?a:void 0,a;case"error":const s=e.error;return{...t,error:s,errorUpdateCount:t.errorUpdateCount+1,errorUpdatedAt:Date.now(),fetchFailureCount:t.fetchFailureCount+1,fetchFailureReason:s,fetchStatus:"idle",status:"error"};case"invalidate":return{...t,isInvalidated:!0};case"setState":return{...t,...e.state}}})(this.state),M.batch(()=>{this.observers.forEach(e=>{e.onQueryUpdate()}),this.#c.notify({query:this,type:"updated",action:e})})}};function W(e,t){return{fetchFailureCount:0,fetchFailureReason:null,fetchStatus:z(t.networkMode)?"fetching":"paused",...void 0===e&&{error:null,status:"pending"}}}function J(e,t){return{data:e,dataUpdatedAt:t??Date.now(),error:null,isInvalidated:!1,status:"success"}}function Y(e){const t="function"==typeof e.initialData?e.initialData():e.initialData,a=void 0!==t,s=a?"function"==typeof e.initialDataUpdatedAt?e.initialDataUpdatedAt():e.initialDataUpdatedAt:0;return{data:t,dataUpdateCount:0,dataUpdatedAt:a?s??Date.now():0,error:null,errorUpdateCount:0,errorUpdatedAt:0,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:null,isInvalidated:!1,status:a?"success":"pending",fetchStatus:"idle"}}var X=class extends Q{constructor(e={}){super(),this.config=e,this.#f=new Map}#f;build(e,t,a){const s=t.queryKey,n=t.queryHash??w(s,t);let i=this.get(n);return i||(i=new V({client:e,queryKey:s,queryHash:n,options:e.defaultQueryOptions(t),state:a,defaultOptions:e.getQueryDefaults(s)}),this.add(i)),i}add(e){this.#f.has(e.queryHash)||(this.#f.set(e.queryHash,e),this.notify({type:"added",query:e}))}remove(e){const t=this.#f.get(e.queryHash);t&&(e.destroy(),t===e&&this.#f.delete(e.queryHash),this.notify({type:"removed",query:e}))}clear(){M.batch(()=>{this.getAll().forEach(e=>{this.remove(e)})})}get(e){return this.#f.get(e)}getAll(){return[...this.#f.values()]}find(e){const t={exact:!0,...e};return this.getAll().find(e=>b(t,e))}findAll(e={}){const t=this.getAll();return Object.keys(e).length>0?t.filter(t=>b(e,t)):t}notify(e){M.batch(()=>{this.listeners.forEach(t=>{t(e)})})}onFocus(){M.batch(()=>{this.getAll().forEach(e=>{e.onFocus()})})}onOnline(){M.batch(()=>{this.getAll().forEach(e=>{e.onOnline()})})}},Z=class extends G{#d;#y;#g;#u;constructor(e){super(),this.#d=e.client,this.mutationId=e.mutationId,this.#g=e.mutationCache,this.#y=[],this.state=e.state||{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0},this.setOptions(e.options),this.scheduleGc()}setOptions(e){this.options=e,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(e){this.#y.includes(e)||(this.#y.push(e),this.clearGcTimeout(),this.#g.notify({type:"observerAdded",mutation:this,observer:e}))}removeObserver(e){this.#y=this.#y.filter(t=>t!==e),this.scheduleGc(),this.#g.notify({type:"observerRemoved",mutation:this,observer:e})}optionalRemove(){this.#y.length||("pending"===this.state.status?this.scheduleGc():this.#g.remove(this))}continue(){return this.#u?.continue()??this.execute(this.state.variables)}async execute(e){const t=()=>{this.#m({type:"continue"})},a={client:this.#d,meta:this.options.meta,mutationKey:this.options.mutationKey};this.#u=$({fn:()=>this.options.mutationFn?this.options.mutationFn(e,a):Promise.reject(new Error("No mutationFn found")),onFail:(e,t)=>{this.#m({type:"failed",failureCount:e,error:t})},onPause:()=>{this.#m({type:"pause"})},onContinue:t,retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>this.#g.canRun(this)});const s="pending"===this.state.status,n=!this.#u.canStart();try{if(s)t();else{this.#m({type:"pending",variables:e,isPaused:n}),await(this.#g.config.onMutate?.(e,this,a));const t=await(this.options.onMutate?.(e,a));t!==this.state.context&&this.#m({type:"pending",context:t,variables:e,isPaused:n})}const i=await this.#u.start();return await(this.#g.config.onSuccess?.(i,e,this.state.context,this,a)),await(this.options.onSuccess?.(i,e,this.state.context,a)),await(this.#g.config.onSettled?.(i,null,this.state.variables,this.state.context,this,a)),await(this.options.onSettled?.(i,null,e,this.state.context,a)),this.#m({type:"success",data:i}),i}catch(t){try{throw await(this.#g.config.onError?.(t,e,this.state.context,this,a)),await(this.options.onError?.(t,e,this.state.context,a)),await(this.#g.config.onSettled?.(void 0,t,this.state.variables,this.state.context,this,a)),await(this.options.onSettled?.(void 0,t,e,this.state.context,a)),t}finally{this.#m({type:"error",error:t})}}finally{this.#g.runNext(this)}}#m(e){this.state=(t=>{switch(e.type){case"failed":return{...t,failureCount:e.failureCount,failureReason:e.error};case"pause":return{...t,isPaused:!0};case"continue":return{...t,isPaused:!1};case"pending":return{...t,context:e.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:e.isPaused,status:"pending",variables:e.variables,submittedAt:Date.now()};case"success":return{...t,data:e.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...t,data:void 0,error:e.error,failureCount:t.failureCount+1,failureReason:e.error,isPaused:!1,status:"error"}}})(this.state),M.batch(()=>{this.#y.forEach(t=>{t.onMutationUpdate(e)}),this.#g.notify({mutation:this,type:"updated",action:e})})}},ee=class extends Q{constructor(e={}){super(),this.config=e,this.#_=new Set,this.#v=new Map,this.#b=0}#_;#v;#b;build(e,t,a){const s=new Z({client:e,mutationCache:this,mutationId:++this.#b,options:e.defaultMutationOptions(t),state:a});return this.add(s),s}add(e){this.#_.add(e);const t=te(e);if("string"==typeof t){const a=this.#v.get(t);a?a.push(e):this.#v.set(t,[e])}this.notify({type:"added",mutation:e})}remove(e){if(this.#_.delete(e)){const t=te(e);if("string"==typeof t){const a=this.#v.get(t);if(a)if(a.length>1){const t=a.indexOf(e);-1!==t&&a.splice(t,1)}else a[0]===e&&this.#v.delete(t)}}this.notify({type:"removed",mutation:e})}canRun(e){const t=te(e);if("string"==typeof t){const a=this.#v.get(t),s=a?.find(e=>"pending"===e.state.status);return!s||s===e}return!0}runNext(e){const t=te(e);if("string"==typeof t){const a=this.#v.get(t)?.find(t=>t!==e&&t.state.isPaused);return a?.continue()??Promise.resolve()}return Promise.resolve()}clear(){M.batch(()=>{this.#_.forEach(e=>{this.notify({type:"removed",mutation:e})}),this.#_.clear(),this.#v.clear()})}getAll(){return Array.from(this.#_)}find(e){const t={exact:!0,...e};return this.getAll().find(e=>x(t,e))}findAll(e={}){return this.getAll().filter(t=>x(e,t))}notify(e){M.batch(()=>{this.listeners.forEach(t=>{t(e)})})}resumePausedMutations(){const e=this.getAll().filter(e=>e.state.isPaused);return M.batch(()=>Promise.all(e.map(e=>e.continue().catch(f))))}};function te(e){return e.options.scope?.id}function ae(e){return{onFetch:(t,a)=>{const s=t.options,n=t.fetchOptions?.meta?.fetchMore?.direction,i=t.state.data?.pages||[],r=t.state.data?.pageParams||[];let l={pages:[],pageParams:[]},o=0;const c=async()=>{let a=!1;const c=P(t.options,t.fetchOptions),d=async(e,s,n)=>{if(a)return Promise.reject();if(null==s&&e.pages.length)return Promise.resolve(e);const i=(()=>{const e={client:t.client,queryKey:t.queryKey,pageParam:s,direction:n?"backward":"forward",meta:t.options.meta};var i;return i=e,Object.defineProperty(i,"signal",{enumerable:!0,get:()=>(t.signal.aborted?a=!0:t.signal.addEventListener("abort",()=>{a=!0}),t.signal)}),e})(),r=await c(i),{maxPages:l}=t.options,o=n?A:R;return{pages:o(e.pages,r,l),pageParams:o(e.pageParams,s,l)}};if(n&&i.length){const e="backward"===n,t={pages:i,pageParams:r},a=(e?ne:se)(s,t);l=await d(t,a,e)}else{const t=e??i.length;do{const e=0===o?r[0]??s.initialPageParam:se(s,l);if(o>0&&null==e)break;l=await d(l,e),o++}while(o<t)}return l};t.options.persister?t.fetchFn=()=>t.options.persister?.(c,{client:t.client,queryKey:t.queryKey,meta:t.options.meta,signal:t.signal},a):t.fetchFn=c}}}function se(e,{pages:t,pageParams:a}){const s=t.length-1;return t.length>0?e.getNextPageParam(t[s],t,a[s],a):void 0}function ne(e,{pages:t,pageParams:a}){return t.length>0?e.getPreviousPageParam?.(t[0],t,a[0],a):void 0}const ie=new class{#x;#g;#h;#w;#j;#C;#S;#N;constructor(e={}){this.#x=e.queryCache||new X,this.#g=e.mutationCache||new ee,this.#h=e.defaultOptions||{},this.#w=new Map,this.#j=new Map,this.#C=0}mount(){this.#C++,1===this.#C&&(this.#S=L.subscribe(async e=>{e&&(await this.resumePausedMutations(),this.#x.onFocus())}),this.#N=B.subscribe(async e=>{e&&(await this.resumePausedMutations(),this.#x.onOnline())}))}unmount(){this.#C--,0===this.#C&&(this.#S?.(),this.#S=void 0,this.#N?.(),this.#N=void 0)}isFetching(e){return this.#x.findAll({...e,fetchStatus:"fetching"}).length}isMutating(e){return this.#g.findAll({...e,status:"pending"}).length}getQueryData(e){const t=this.defaultQueryOptions({queryKey:e});return this.#x.get(t.queryHash)?.state.data}ensureQueryData(e){const t=this.defaultQueryOptions(e),a=this.#x.build(this,t),s=a.state.data;return void 0===s?this.fetchQuery(e):(e.revalidateIfStale&&a.isStaleByTime(_(t.staleTime,a))&&this.prefetchQuery(t),Promise.resolve(s))}getQueriesData(e){return this.#x.findAll(e).map(({queryKey:e,state:t})=>[e,t.data])}setQueryData(e,t,a){const s=this.defaultQueryOptions({queryKey:e}),n=this.#x.get(s.queryHash),i=n?.state.data,r=function(e,t){return"function"==typeof e?e(t):e}(t,i);if(void 0!==r)return this.#x.build(this,s).setData(r,{...a,manual:!0})}setQueriesData(e,t,a){return M.batch(()=>this.#x.findAll(e).map(({queryKey:e})=>[e,this.setQueryData(e,t,a)]))}getQueryState(e){const t=this.defaultQueryOptions({queryKey:e});return this.#x.get(t.queryHash)?.state}removeQueries(e){const t=this.#x;M.batch(()=>{t.findAll(e).forEach(e=>{t.remove(e)})})}resetQueries(e,t){const a=this.#x;return M.batch(()=>(a.findAll(e).forEach(e=>{e.reset()}),this.refetchQueries({type:"active",...e},t)))}cancelQueries(e,t={}){const a={revert:!0,...t},s=M.batch(()=>this.#x.findAll(e).map(e=>e.cancel(a)));return Promise.all(s).then(f).catch(f)}invalidateQueries(e,t={}){return M.batch(()=>(this.#x.findAll(e).forEach(e=>{e.invalidate()}),"none"===e?.refetchType?Promise.resolve():this.refetchQueries({...e,type:e?.refetchType??e?.type??"active"},t)))}refetchQueries(e,t={}){const a={...t,cancelRefetch:t.cancelRefetch??!0},s=M.batch(()=>this.#x.findAll(e).filter(e=>!e.isDisabled()&&!e.isStatic()).map(e=>{let t=e.fetch(void 0,a);return a.throwOnError||(t=t.catch(f)),"paused"===e.state.fetchStatus?Promise.resolve():t}));return Promise.all(s).then(f)}fetchQuery(e){const t=this.defaultQueryOptions(e);void 0===t.retry&&(t.retry=!1);const a=this.#x.build(this,t);return a.isStaleByTime(_(t.staleTime,a))?a.fetch(t):Promise.resolve(a.state.data)}prefetchQuery(e){return this.fetchQuery(e).then(f).catch(f)}fetchInfiniteQuery(e){return e.behavior=ae(e.pages),this.fetchQuery(e)}prefetchInfiniteQuery(e){return this.fetchInfiniteQuery(e).then(f).catch(f)}ensureInfiniteQueryData(e){return e.behavior=ae(e.pages),this.ensureQueryData(e)}resumePausedMutations(){return B.isOnline()?this.#g.resumePausedMutations():Promise.resolve()}getQueryCache(){return this.#x}getMutationCache(){return this.#g}getDefaultOptions(){return this.#h}setDefaultOptions(e){this.#h=e}setQueryDefaults(e,t){this.#w.set(j(e),{queryKey:e,defaultOptions:t})}getQueryDefaults(e){const t=[...this.#w.values()],a={};return t.forEach(t=>{C(e,t.queryKey)&&Object.assign(a,t.defaultOptions)}),a}setMutationDefaults(e,t){this.#j.set(j(e),{mutationKey:e,defaultOptions:t})}getMutationDefaults(e){const t=[...this.#j.values()],a={};return t.forEach(t=>{C(e,t.mutationKey)&&Object.assign(a,t.defaultOptions)}),a}defaultQueryOptions(e){if(e._defaulted)return e;const t={...this.#h.queries,...this.getQueryDefaults(e.queryKey),...e,_defaulted:!0};return t.queryHash||(t.queryHash=w(t.queryKey,t)),void 0===t.refetchOnReconnect&&(t.refetchOnReconnect="always"!==t.networkMode),void 0===t.throwOnError&&(t.throwOnError=!!t.suspense),!t.networkMode&&t.persister&&(t.networkMode="offlineFirst"),t.queryFn===F&&(t.enabled=!1),t}defaultMutationOptions(e){return e?._defaulted?e:{...this.#h.mutations,...e?.mutationKey&&this.getMutationDefaults(e.mutationKey),...e,_defaulted:!0}}clear(){this.#x.clear(),this.#g.clear()}}({defaultOptions:{queries:{staleTime:3e5,gcTime:6e5,refetchOnWindowFocus:!0,retry:(e,t)=>!(t?.status>=400&&t?.status<500)&&e<3},mutations:{retry:!1}}}),re=window.wp.i18n,le=window.wp.components;var oe=class extends Q{constructor(e,t){super(),this.options=t,this.#d=e,this.#I=null,this.#O=U(),this.bindMethods(),this.setOptions(t)}#d;#D=void 0;#k=void 0;#E=void 0;#R;#A;#O;#I;#F;#P;#T;#q;#M;#Q;#L=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){1===this.listeners.size&&(this.#D.addObserver(this),ce(this.#D,this.options)?this.#B():this.updateResult(),this.#U())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return de(this.#D,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return de(this.#D,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#K(),this.#z(),this.#D.removeObserver(this)}setOptions(e){const t=this.options,a=this.#D;if(this.options=this.#d.defaultQueryOptions(e),void 0!==this.options.enabled&&"boolean"!=typeof this.options.enabled&&"function"!=typeof this.options.enabled&&"boolean"!=typeof v(this.options.enabled,this.#D))throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#H(),this.#D.setOptions(this.options),t._defaulted&&!I(this.options,t)&&this.#d.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#D,observer:this});const s=this.hasListeners();s&&ue(this.#D,a,this.options,t)&&this.#B(),this.updateResult(),!s||this.#D===a&&v(this.options.enabled,this.#D)===v(t.enabled,this.#D)&&_(this.options.staleTime,this.#D)===_(t.staleTime,this.#D)||this.#$();const n=this.#G();!s||this.#D===a&&v(this.options.enabled,this.#D)===v(t.enabled,this.#D)&&n===this.#Q||this.#V(n)}getOptimisticResult(e){const t=this.#d.getQueryCache().build(this.#d,e),a=this.createResult(t,e);return s=a,!I(this.getCurrentResult(),s)&&(this.#E=a,this.#A=this.options,this.#R=this.#D.state),a;var s}getCurrentResult(){return this.#E}trackResult(e,t){return new Proxy(e,{get:(e,a)=>(this.trackProp(a),t?.(a),"promise"===a&&(this.trackProp("data"),this.options.experimental_prefetchInRender||"pending"!==this.#O.status||this.#O.reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(e,a))})}trackProp(e){this.#L.add(e)}getCurrentQuery(){return this.#D}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const t=this.#d.defaultQueryOptions(e),a=this.#d.getQueryCache().build(this.#d,t);return a.fetch().then(()=>this.createResult(a,t))}fetch(e){return this.#B({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#E))}#B(e){this.#H();let t=this.#D.fetch(this.options,e);return e?.throwOnError||(t=t.catch(f)),t}#$(){this.#K();const e=_(this.options.staleTime,this.#D);if(m||this.#E.isStale||!y(e))return;const t=g(this.#E.dataUpdatedAt,e)+1;this.#q=p.setTimeout(()=>{this.#E.isStale||this.updateResult()},t)}#G(){return("function"==typeof this.options.refetchInterval?this.options.refetchInterval(this.#D):this.options.refetchInterval)??!1}#V(e){this.#z(),this.#Q=e,!m&&!1!==v(this.options.enabled,this.#D)&&y(this.#Q)&&0!==this.#Q&&(this.#M=p.setInterval(()=>{(this.options.refetchIntervalInBackground||L.isFocused())&&this.#B()},this.#Q))}#U(){this.#$(),this.#V(this.#G())}#K(){this.#q&&(p.clearTimeout(this.#q),this.#q=void 0)}#z(){this.#M&&(p.clearInterval(this.#M),this.#M=void 0)}createResult(e,t){const a=this.#D,s=this.options,n=this.#E,i=this.#R,r=this.#A,l=e!==a?e.state:this.#k,{state:o}=e;let c,d={...o},u=!1;if(t._optimisticResults){const n=this.hasListeners(),i=!n&&ce(e,t),r=n&&ue(e,a,t,s);(i||r)&&(d={...d,...W(o.data,e.options)}),"isRestoring"===t._optimisticResults&&(d.fetchStatus="idle")}let{error:h,errorUpdatedAt:p,status:m}=d;c=d.data;let f=!1;if(void 0!==t.placeholderData&&void 0===c&&"pending"===m){let e;n?.isPlaceholderData&&t.placeholderData===r?.placeholderData?(e=n.data,f=!0):e="function"==typeof t.placeholderData?t.placeholderData(this.#T?.state.data,this.#T):t.placeholderData,void 0!==e&&(m="success",c=E(n?.data,e,t),u=!0)}if(t.select&&void 0!==c&&!f)if(n&&c===i?.data&&t.select===this.#F)c=this.#P;else try{this.#F=t.select,c=t.select(c),c=E(n?.data,c,t),this.#P=c,this.#I=null}catch(e){this.#I=e}this.#I&&(h=this.#I,c=this.#P,p=Date.now(),m="error");const y="fetching"===d.fetchStatus,g="pending"===m,_="error"===m,b=g&&y,x=void 0!==c,w={status:m,fetchStatus:d.fetchStatus,isPending:g,isSuccess:"success"===m,isError:_,isInitialLoading:b,isLoading:b,data:c,dataUpdatedAt:d.dataUpdatedAt,error:h,errorUpdatedAt:p,failureCount:d.fetchFailureCount,failureReason:d.fetchFailureReason,errorUpdateCount:d.errorUpdateCount,isFetched:d.dataUpdateCount>0||d.errorUpdateCount>0,isFetchedAfterMount:d.dataUpdateCount>l.dataUpdateCount||d.errorUpdateCount>l.errorUpdateCount,isFetching:y,isRefetching:y&&!g,isLoadingError:_&&!x,isPaused:"paused"===d.fetchStatus,isPlaceholderData:u,isRefetchError:_&&x,isStale:he(e,t),refetch:this.refetch,promise:this.#O,isEnabled:!1!==v(t.enabled,e)};if(this.options.experimental_prefetchInRender){const t=e=>{"error"===w.status?e.reject(w.error):void 0!==w.data&&e.resolve(w.data)},s=()=>{const e=this.#O=w.promise=U();t(e)},n=this.#O;switch(n.status){case"pending":e.queryHash===a.queryHash&&t(n);break;case"fulfilled":"error"!==w.status&&w.data===n.value||s();break;case"rejected":"error"===w.status&&w.error===n.reason||s()}}return w}updateResult(){const e=this.#E,t=this.createResult(this.#D,this.options);this.#R=this.#D.state,this.#A=this.options,void 0!==this.#R.data&&(this.#T=this.#D),I(t,e)||(this.#E=t,this.#W({listeners:(()=>{if(!e)return!0;const{notifyOnChangeProps:t}=this.options,a="function"==typeof t?t():t;if("all"===a||!a&&!this.#L.size)return!0;const s=new Set(a??this.#L);return this.options.throwOnError&&s.add("error"),Object.keys(this.#E).some(t=>{const a=t;return this.#E[a]!==e[a]&&s.has(a)})})()}))}#H(){const e=this.#d.getQueryCache().build(this.#d,this.options);if(e===this.#D)return;const t=this.#D;this.#D=e,this.#k=e.state,this.hasListeners()&&(t?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#U()}#W(e){M.batch(()=>{e.listeners&&this.listeners.forEach(e=>{e(this.#E)}),this.#d.getQueryCache().notify({query:this.#D,type:"observerResultsUpdated"})})}};function ce(e,t){return function(e,t){return!1!==v(t.enabled,e)&&void 0===e.state.data&&!("error"===e.state.status&&!1===t.retryOnMount)}(e,t)||void 0!==e.state.data&&de(e,t,t.refetchOnMount)}function de(e,t,a){if(!1!==v(t.enabled,e)&&"static"!==_(t.staleTime,e)){const s="function"==typeof a?a(e):a;return"always"===s||!1!==s&&he(e,t)}return!1}function ue(e,t,a,s){return(e!==t||!1===v(s.enabled,e))&&(!a.suspense||"error"!==e.state.status)&&he(e,a)}function he(e,t){return!1!==v(t.enabled,e)&&e.isStaleByTime(_(t.staleTime,e))}var pe=r.createContext(function(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}()),me=r.createContext(!1),fe=(me.Provider,(e,t,a)=>t.fetchOptimistic(e).catch(()=>{a.clearReset()}));function ye(e,t){return function(e,t,a){const s=r.useContext(me),n=r.useContext(pe),i=c(a),l=i.defaultQueryOptions(e);i.getDefaultOptions().queries?._experimental_beforeQuery?.(l),l._optimisticResults=s?"isRestoring":"optimistic",(e=>{if(e.suspense){const t=1e3,a=e=>"static"===e?e:Math.max(e??t,t),s=e.staleTime;e.staleTime="function"==typeof s?(...e)=>a(s(...e)):a(s),"number"==typeof e.gcTime&&(e.gcTime=Math.max(e.gcTime,t))}})(l),((e,t)=>{(e.suspense||e.throwOnError||e.experimental_prefetchInRender)&&(t.isReset()||(e.retryOnMount=!1))})(l,n),(e=>{r.useEffect(()=>{e.clearReset()},[e])})(n);const o=!i.getQueryCache().get(l.queryHash),[d]=r.useState(()=>new t(i,l)),u=d.getOptimisticResult(l),h=!s&&!1!==e.subscribed;if(r.useSyncExternalStore(r.useCallback(e=>{const t=h?d.subscribe(M.batchCalls(e)):f;return d.updateResult(),t},[d,h]),()=>d.getCurrentResult(),()=>d.getCurrentResult()),r.useEffect(()=>{d.setOptions(l)},[l,d]),((e,t)=>e?.suspense&&t.isPending)(l,u))throw fe(l,d,n);if((({result:e,errorResetBoundary:t,throwOnError:a,query:s,suspense:n})=>e.isError&&!t.isReset()&&!e.isFetching&&s&&(n&&void 0===e.data||T(a,[e.error,s])))({result:u,errorResetBoundary:n,throwOnError:l.throwOnError,query:i.getQueryCache().get(l.queryHash),suspense:l.suspense}))throw u.error;if(i.getDefaultOptions().queries?._experimental_afterQuery?.(l,u),l.experimental_prefetchInRender&&!m&&((e,t)=>e.isLoading&&e.isFetching&&!t)(u,s)){const e=o?fe(l,d,n):i.getQueryCache().get(l.queryHash)?.promise;e?.catch(f).finally(()=>{d.updateResult()})}return l.notifyOnChangeProps?u:d.trackResult(u)}(e,oe,t)}var ge=class extends Q{#d;#E=void 0;#J;#Y;constructor(e,t){super(),this.#d=e,this.setOptions(t),this.bindMethods(),this.#X()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){const t=this.options;this.options=this.#d.defaultMutationOptions(e),I(this.options,t)||this.#d.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#J,observer:this}),t?.mutationKey&&this.options.mutationKey&&j(t.mutationKey)!==j(this.options.mutationKey)?this.reset():"pending"===this.#J?.state.status&&this.#J.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#J?.removeObserver(this)}onMutationUpdate(e){this.#X(),this.#W(e)}getCurrentResult(){return this.#E}reset(){this.#J?.removeObserver(this),this.#J=void 0,this.#X(),this.#W()}mutate(e,t){return this.#Y=t,this.#J?.removeObserver(this),this.#J=this.#d.getMutationCache().build(this.#d,this.options),this.#J.addObserver(this),this.#J.execute(e)}#X(){const e=this.#J?.state??{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0};this.#E={...e,isPending:"pending"===e.status,isSuccess:"success"===e.status,isError:"error"===e.status,isIdle:"idle"===e.status,mutate:this.mutate,reset:this.reset}}#W(e){M.batch(()=>{if(this.#Y&&this.hasListeners()){const t=this.#E.variables,a=this.#E.context,s={client:this.#d,meta:this.options.meta,mutationKey:this.options.mutationKey};"success"===e?.type?(this.#Y.onSuccess?.(e.data,t,a,s),this.#Y.onSettled?.(e.data,null,t,a,s)):"error"===e?.type&&(this.#Y.onError?.(e.error,t,a,s),this.#Y.onSettled?.(void 0,e.error,t,a,s))}this.listeners.forEach(e=>{e(this.#E)})})}};function _e(e,t){const a=c(t),[s]=r.useState(()=>new ge(a,e));r.useEffect(()=>{s.setOptions(e)},[s,e]);const n=r.useSyncExternalStore(r.useCallback(e=>s.subscribe(M.batchCalls(e)),[s]),()=>s.getCurrentResult(),()=>s.getCurrentResult()),i=r.useCallback((e,t)=>{s.mutate(e,t).catch(f)},[s]);if(n.error&&T(s.options.throwOnError,[n.error]))throw n.error;return{...n,mutate:i,mutateAsync:n.mutate}}const ve=window.wp.apiFetch;var be=a.n(ve);const xe=window.wp.url,we=async(e,t="GET",a=void 0,s={},n={})=>{const i=(()=>{const e=window.dataMachineConfig||{};return{restNamespace:e.restNamespace||"datamachine/v1",restNonce:e.restNonce||""}})(),r=(0,xe.addQueryArgs)(`/${i.restNamespace}${e}`,s);try{const e=await be()({path:r,method:t,data:a,headers:{"X-WP-Nonce":i.restNonce,...n.headers},...n});return{success:e.success,data:e.data,message:e.message||""}}catch(a){return console.error(`API Request Error [${t} ${e}]:`,a),{success:!1,data:null,message:a.message||"An error occurred"}}},je=(e,t={})=>we(e,"GET",void 0,t),Ce=(e,t)=>we(e,"POST",t),Se=(e,t)=>we(e,"PUT",t),Ne=(e,t)=>we(e,"PATCH",t),Ie=e=>we(e,"DELETE"),Oe=async e=>await Ce("/pipelines",{pipeline_name:e}),De=async e=>await Ie(`/pipelines/${e}`),ke=async(e,t,a,s,n=[],i="ai",r=null)=>await Se(`/pipelines/steps/${e}/config`,{step_type:i,pipeline_id:r,provider:a,model:s,system_prompt:t,enabled_tools:n}),Ee=async e=>await je(`/flows/${e}`),Re=async e=>await Ce("/execute",{flow_id:e}),Ae=(e,t)=>null!=e&&null!=t&&String(e)===String(t),Fe=(e,t)=>!(!Array.isArray(e)||null==t)&&e.some(e=>String(e)===String(t)),Pe=e=>null==e||""===e?null:String(e),Te=()=>ye({queryKey:["pipelines"],queryFn:async()=>{const e=await(async(e=null)=>await je("/pipelines",e?{pipeline_id:e}:{}))();return e.success?e.data.pipelines:[]}}),qe=(e,{pipelineId:t,flowId:a,flowStepId:s,patchStep:n})=>{((e,{pipelineId:t,flowId:a,patchFlow:s})=>{const n=Pe(a),i=Pe(t);n&&"function"==typeof s&&(e.setQueryData(["flows","single",n],e=>e?s(e):e),i&&e.setQueryData(["flows",i],(e=[])=>Array.isArray(e)?e.map(e=>Ae(e.flow_id,n)?s(e):e):e))})(e,{pipelineId:t,flowId:a,patchFlow:e=>{if(!e?.flow_config?.[s])return e;const t=e.flow_config[s]||{},a=n(t);return{...e,flow_config:{...e.flow_config,[s]:a}}}})},Me=()=>{const e=c();return _e({mutationFn:async({flowStepId:t,handlerSlug:s,settings:n,pipelineId:i,stepType:r,flowConfig:l={},pipelineStepConfig:o={}})=>{let c=n;try{const t=e.getQueryData(["handlers",s]),i=(e.getQueryData(["handlers"])||{})[s]||{};if(t){const{default:e}=await Promise.resolve().then(a.bind(a,848)),r=e(s,i,t);r&&"function"==typeof r.sanitizeForAPI&&(c=r.sanitizeForAPI(n,t.settings||{}))}}catch(e){}return(async(e,t,a={},s,n,i={},r={})=>await Se(`/flows/steps/${e}/handler`,{handler_slug:t,pipeline_id:s,step_type:n,flow_config:i,pipeline_step:r,settings:a}))(t,s,c,i,r,l,o)},onSuccess:(t,a)=>{if(!t?.success||!t?.data?.flow_id)return;const s=t.data.flow_id,n=t.data.flow_step_id,i=t.data.step_config,r=t.data.handler_settings_display;s&&n&&i&&qe(e,{pipelineId:a.pipelineId,flowId:s,flowStepId:n,patchStep:e=>({...e,...i,settings_display:r||e.settings_display})})}})},Qe=()=>ye({queryKey:["handlers"],queryFn:async()=>{const e=await(async(e=null)=>{const t=e?{step_type:e}:{};return await je("/handlers",t)})();return e.success?e.data:{}},staleTime:18e5}),Le=e=>ye({queryKey:["handlers",e],queryFn:async()=>{const t=await(async e=>await je(`/handlers/${e}`))(e);return t.success?t.data:null},enabled:!!e,staleTime:18e5}),Be=e=>{let t;const a=new Set,s=(e,s)=>{const n="function"==typeof e?e(t):e;if(!Object.is(n,t)){const e=t;t=(null!=s?s:"object"!=typeof n||null===n)?n:Object.assign({},t,n),a.forEach(a=>a(t,e))}},n=()=>t,i={setState:s,getState:n,getInitialState:()=>r,subscribe:e=>(a.add(e),()=>a.delete(e))},r=t=e(s,n,i);return i},Ue=e=>e,Ke=e=>{const t=(e=>e?Be(e):Be)(e),a=e=>function(e,t=Ue){const a=r.useSyncExternalStore(e.subscribe,r.useCallback(()=>t(e.getState()),[e,t]),r.useCallback(()=>t(e.getInitialState()),[e,t]));return r.useDebugValue(a),a}(t,e);return Object.assign(a,t),a};function ze(e,t){let a;try{a=e()}catch(e){return}return{getItem:e=>{var s;const n=e=>null===e?null:JSON.parse(e,null==t?void 0:t.reviver),i=null!=(s=a.getItem(e))?s:null;return i instanceof Promise?i.then(n):n(i)},setItem:(e,s)=>a.setItem(e,JSON.stringify(s,null==t?void 0:t.replacer)),removeItem:e=>a.removeItem(e)}}const He=e=>t=>{try{const a=e(t);return a instanceof Promise?a:{then:e=>He(e)(a),catch(e){return this}}}catch(e){return{then(e){return this},catch:t=>He(t)(e)}}},$e=(Ge=(e,t)=>({selectedPipelineId:null,setSelectedPipelineId:t=>{e(null!=t&&""!==t?{selectedPipelineId:Pe(t)}:{selectedPipelineId:null})},activeModal:null,modalData:null,openModal:(t,a=null)=>{e({activeModal:t,modalData:a})},closeModal:()=>{e({activeModal:null,modalData:null})},isChatOpen:!1,chatSessionId:null,toggleChat:()=>e(e=>({isChatOpen:!e.isChatOpen})),setChatOpen:t=>e({isChatOpen:t}),setChatSessionId:t=>e({chatSessionId:t}),clearChatSession:()=>e({chatSessionId:null}),getSelectedPipelineId:()=>t().selectedPipelineId,isModalOpen:e=>t().activeModal===e,selectNextPipeline:a=>{const s=t().selectedPipelineId;if(!a||0===a.length)return void e({selectedPipelineId:null});const n=Pe(s);n&&a.some(e=>Ae(e.pipeline_id,n))||e({selectedPipelineId:Pe(a[0].pipeline_id)})}}),Ve={name:"datamachine-ui-store",partialize:e=>({selectedPipelineId:e.selectedPipelineId,isChatOpen:e.isChatOpen,chatSessionId:e.chatSessionId}),version:2,merge:(e,t)=>({...t,...e})},(We=(e,t,a)=>{let s={storage:ze(()=>localStorage),partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...Ve},n=!1;const i=new Set,r=new Set;let l=s.storage;if(!l)return Ge((...t)=>{console.warn(`[zustand persist middleware] Unable to update item '${s.name}', the given storage is currently unavailable.`),e(...t)},t);const o=()=>{const e=s.partialize({...t()});return l.setItem(s.name,{state:e,version:s.version})},c=a.setState;a.setState=(e,t)=>(c(e,t),o());const d=Ge((...t)=>(e(...t),o()),t);let u;a.getInitialState=()=>d;const h=()=>{var a,c;if(!l)return;n=!1,i.forEach(e=>{var a;return e(null!=(a=t())?a:d)});const h=(null==(c=s.onRehydrateStorage)?void 0:c.call(s,null!=(a=t())?a:d))||void 0;return He(l.getItem.bind(l))(s.name).then(e=>{if(e){if("number"!=typeof e.version||e.version===s.version)return[!1,e.state];if(s.migrate){const t=s.migrate(e.state,e.version);return t instanceof Promise?t.then(e=>[!0,e]):[!0,t]}console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}return[!1,void 0]}).then(a=>{var n;const[i,r]=a;if(u=s.merge(r,null!=(n=t())?n:d),e(u,!0),i)return o()}).then(()=>{null==h||h(u,void 0),u=t(),n=!0,r.forEach(e=>e(u))}).catch(e=>{null==h||h(void 0,e)})};return a.persist={setOptions:e=>{s={...s,...e},e.storage&&(l=e.storage)},clearStorage:()=>{null==l||l.removeItem(s.name)},getOptions:()=>s,rehydrate:()=>h(),hasHydrated:()=>n,onHydrate:e=>(i.add(e),()=>{i.delete(e)}),onFinishHydration:e=>(r.add(e),()=>{r.delete(e)})},s.skipHydration||h(),u||d})?Ke(We):Ke);var Ge,Ve,We;const Je="step-selection",Ye="handler-selection",Xe="configure-step",Ze="handler-settings",et="flow-schedule",tt="import-export",at="oauth",st="context-files",nt=500;function it({pipelineId:e,pipelineName:t,onNameChange:a,onDelete:n,onOpenContextFiles:i}){const[r,o]=(0,s.useState)(t),d=(0,s.useRef)(null),u=(()=>{const e=c();return _e({mutationFn:De,onSuccess:()=>{e.invalidateQueries({queryKey:["pipelines"]})}})})();(0,s.useEffect)(()=>{o(t)},[t]);const h=(0,s.useCallback)(async s=>{if(s&&s!==t)try{const t=await(async(e,t)=>await Ne(`/pipelines/${e}`,{pipeline_name:t}))(e,s);t.success&&a&&a(s)}catch(e){console.error("Pipeline title save failed:",e)}},[e,t,a]),p=(0,s.useCallback)(e=>{o(e),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{h(e)},nt)},[h]),m=(0,s.useCallback)(async()=>{if(window.confirm((0,re.__)("Are you sure you want to delete this pipeline? This action cannot be undone.","datamachine")))try{await u.mutateAsync(e),n&&n(e)}catch(e){console.error("Pipeline deletion error:",e),alert((0,re.__)("An error occurred while deleting the pipeline","datamachine"))}},[e,n,u]);return(0,s.useEffect)(()=>()=>{d.current&&clearTimeout(d.current)},[]),(0,l.jsxs)("div",{className:"datamachine-pipeline-header",children:[(0,l.jsxs)("div",{className:"datamachine-header--absolute-top-right datamachine-header--flex-start",children:[(0,l.jsx)(le.Button,{variant:"secondary",onClick:i,icon:"media-document",label:(0,re.__)("Context Files","datamachine")}),(0,l.jsx)(le.Button,{isDestructive:!0,variant:"secondary",onClick:m,icon:"trash",label:(0,re.__)("Delete Pipeline","datamachine")})]}),(0,l.jsx)(le.TextControl,{value:r,onChange:p,placeholder:(0,re.__)("Pipeline name","datamachine"),className:"datamachine-pipeline-header__title-input"})]})}const rt=()=>ye({queryKey:["config","step-types"],queryFn:async()=>{const e=await(async()=>await je("/step-types"))();return e.success?e.data:{}},staleTime:1/0}),lt=()=>ye({queryKey:["config","tools"],queryFn:async()=>{const e=await(async()=>await je("/tools"))();return e.success?e.data:{}},staleTime:18e5});function ot({step:e,pipelineId:t,pipelineConfig:a,onDelete:n,onConfigure:i}){const{data:r={}}=rt(),o=!0===(r?.[e.step_type]||{}).has_pipeline_config,c="ai"===e.step_type?a[e.pipeline_step_id]:null,[d,u]=(0,s.useState)(c?.system_prompt||""),[h,p]=(0,s.useState)(!1),[m,f]=(0,s.useState)(null),y=(0,s.useRef)(null);(0,s.useEffect)(()=>{c&&u(c.system_prompt||"")},[c]);const g=(0,s.useCallback)(async a=>{if(!c)return;const s=c.system_prompt||"";if(a!==s){p(!0),f(null);try{const n=await ke(e.pipeline_step_id,a,c.provider,c.model,[],e.step_type,t);n.success||(f(n.message||(0,re.__)("Failed to update prompt","datamachine")),u(s))}catch(e){console.error("Prompt update error:",e),f(e.message||(0,re.__)("An error occurred","datamachine")),u(s)}finally{p(!1)}}},[t,e.pipeline_step_id,e.step_type,c]),_=(0,s.useCallback)(e=>{u(e),y.current&&clearTimeout(y.current),y.current=setTimeout(()=>{g(e)},nt)},[g]),v=(0,s.useCallback)(()=>{window.confirm((0,re.__)("Are you sure you want to remove this step?","datamachine"))&&n&&n(e.pipeline_step_id)},[e.pipeline_step_id,n]);return(0,s.useEffect)(()=>()=>{y.current&&clearTimeout(y.current)},[]),(0,l.jsx)(le.Card,{className:`datamachine-pipeline-step-card datamachine-step-type--${e.step_type}`,size:"small",children:(0,l.jsxs)(le.CardBody,{children:[m&&(0,l.jsx)(le.Notice,{status:"error",isDismissible:!0,onRemove:()=>f(null),children:m}),(0,l.jsx)("div",{className:"datamachine-step-card-header",children:(0,l.jsx)("strong",{children:r[e.step_type]?.label||e.step_type})}),c&&(0,l.jsxs)("div",{className:"datamachine-ai-config-display datamachine-step-card-ai-config",children:[(0,l.jsxs)("div",{className:"datamachine-step-card-ai-label",children:[(0,l.jsx)("strong",{children:(0,re.__)("AI Provider:","datamachine")})," ",c.provider||"Not configured"," | ",(0,l.jsx)("strong",{children:(0,re.__)("Model:","datamachine")})," ",c.model||"Not configured"]}),(0,l.jsx)(le.TextareaControl,{label:(0,re.__)("System Prompt","datamachine"),value:d,onChange:_,placeholder:(0,re.__)("Enter system prompt for AI processing...","datamachine"),rows:6,help:h?(0,re.__)("Saving...","datamachine"):null})]}),(0,l.jsxs)("div",{className:"datamachine-step-card-actions",children:[o&&(0,l.jsx)(le.Button,{variant:"secondary",size:"small",onClick:()=>i&&i(e),children:(0,re.__)("Configure","datamachine")}),(0,l.jsx)(le.Button,{variant:"secondary",size:"small",isDestructive:!0,onClick:v,children:(0,re.__)("Delete","datamachine")})]})]})})}function ct({pipelineId:e,onAddStep:t}){return(0,l.jsx)("div",{className:"datamachine-step-card--empty",children:(0,l.jsx)(le.Button,{variant:"secondary",onClick:()=>t&&t(e),children:(0,re.__)("Add Step","datamachine")})})}function dt(){return(0,l.jsx)("div",{className:"datamachine-data-flow-arrow",children:(0,l.jsx)("svg",{width:"40",height:"20",viewBox:"0 0 40 20",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:(0,l.jsx)("path",{d:"M0 10 L30 10 L25 5 M30 10 L25 15",stroke:"#8c8f94",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})}function ut({pipelineId:e,pipelineConfig:t,onStepAdded:a,onStepRemoved:n,onStepConfigured:i}){const r=(0,s.useMemo)(()=>t&&"object"==typeof t?Object.values(t).sort((e,t)=>(e.execution_order||0)-(t.execution_order||0)):[],[t]),[o,c]=(0,s.useState)(null);return 0===r.length?(0,l.jsxs)("div",{className:"datamachine-pipeline-steps-empty datamachine-steps-empty-state",children:[(0,l.jsx)("p",{className:"datamachine-steps-empty-text",children:(0,re.__)("No steps configured. Add your first step to get started.","datamachine")}),(0,l.jsx)(ct,{pipelineId:e,onAddStep:a})]}):(0,l.jsx)("div",{className:"datamachine-pipeline-steps datamachine-steps-container",children:(()=>{const s=[];return r.forEach((a,d)=>{s.push((0,l.jsx)("div",{draggable:!0,onDragStart:()=>c(d),onDragOver:e=>e.preventDefault(),onDrop:()=>(async t=>{if(null===o||o===t)return void c(null);const a=[...r],[s]=a.splice(o,1);a.splice(t,0,s);try{await(async(e,t)=>{const a=t.map((e,t)=>({pipeline_step_id:e.pipeline_step_id,execution_order:t}));return await Se(`/pipelines/${e}/steps/reorder`,{step_order:a})})(e,a)}catch(e){console.error("Failed to reorder steps:",e)}c(null)})(d),className:"datamachine-step-card-draggable "+(o===d?"datamachine-step-dragging":""),children:(0,l.jsx)(ot,{step:a,pipelineId:e,pipelineConfig:t,onDelete:n,onConfigure:i})},a.pipeline_step_id)),d<r.length-1&&s.push((0,l.jsx)(dt,{},`arrow-${d}`))}),r.length>0&&s.push((0,l.jsx)(dt,{},"arrow-empty")),s.push((0,l.jsx)("div",{className:"datamachine-step-card-draggable",children:(0,l.jsx)(ct,{pipelineId:e,onAddStep:a})},"empty-card")),s})()})}function ht({flowId:e,flowName:t,onNameChange:a,onDelete:n,onDuplicate:i,onRun:r,onSchedule:o,runSuccess:d=!1}){const[u,h]=(0,s.useState)(t),p=(0,s.useRef)(null),m=(()=>{const e=c();return _e({mutationFn:({flowId:e,name:t})=>(async(e,t)=>await Ne(`/flows/${e}`,{flow_name:t}))(e,t),onSuccess:t=>{t?.success&&t?.data&&((e,t)=>{if(!t?.flow_id)return;const a=Pe(t.flow_id),s=Pe(t.pipeline_id);a&&(e.setQueryData(["flows","single",a],t),s&&e.setQueryData(["flows",s],(e=[])=>Array.isArray(e)?e.map(e=>Ae(e.flow_id,t.flow_id)?t:e):e))})(e,t.data)}})})();(0,s.useEffect)(()=>{h(t)},[t]);const f=(0,s.useCallback)(async s=>{if(s&&s!==t)try{const t=await m.mutateAsync({flowId:e,name:s});t?.success&&a&&a(e,s)}catch(e){console.error("Flow title save failed:",e)}},[e,t,a,m]),y=(0,s.useCallback)(e=>{h(e),p.current&&clearTimeout(p.current),p.current=setTimeout(()=>{f(e)},nt)},[f]),g=(0,s.useCallback)(()=>{window.confirm((0,re.__)("Are you sure you want to delete this flow?","datamachine"))&&n&&n(e)},[e,n]);return(0,s.useEffect)(()=>()=>{p.current&&clearTimeout(p.current)},[]),(0,l.jsxs)("div",{className:"datamachine-flow-header",children:[(0,l.jsxs)("div",{className:"datamachine-flow-header__content",children:[(0,l.jsx)(le.TextControl,{value:u,onChange:y,placeholder:(0,re.__)("Flow name","datamachine"),className:"datamachine-flow-header__title-input"}),(0,l.jsx)("div",{className:"datamachine-flow-header__primary-actions",children:(0,l.jsx)(le.Button,{variant:"primary",onClick:()=>r&&r(e),disabled:d,children:d?(0,re.__)("Queued","datamachine"):(0,re.__)("Run Now","datamachine")})})]}),(0,l.jsxs)("div",{className:"datamachine-flow-header__secondary-actions",children:[(0,l.jsx)(le.Button,{variant:"secondary",onClick:()=>o&&o(e),children:(0,re.__)("Schedule","datamachine")}),(0,l.jsx)(le.Button,{variant:"secondary",onClick:()=>i&&i(e),children:(0,re.__)("Duplicate","datamachine")}),(0,l.jsx)(le.Button,{variant:"secondary",isDestructive:!0,onClick:g,icon:"trash"})]})]})}function pt({handlerSlug:e,settingsDisplay:t,onConfigure:a}){const{data:s={}}=Qe();if(!e)return(0,l.jsxs)("div",{className:"datamachine-flow-step-handler datamachine-flow-step-handler--empty datamachine-handler-warning",children:[(0,l.jsx)("p",{className:"datamachine-handler-warning-text",children:(0,re.__)("No handler configured","datamachine")}),(0,l.jsx)(le.Button,{variant:"secondary",size:"small",onClick:a,children:(0,re.__)("Configure Handler","datamachine")})]});const n=Array.isArray(t)?t.reduce((e,t)=>{var a;return e[t.key]={label:t.label,value:null!==(a=t.display_value)&&void 0!==a?a:t.value},e},{}):{},i=Object.keys(n).length>0,r=s[e]?.label||e;return(0,l.jsxs)("div",{className:"datamachine-flow-step-handler datamachine-handler-container",children:[(0,l.jsx)("div",{className:"datamachine-handler-tag datamachine-handler-badge",children:r}),i&&(0,l.jsx)("div",{className:"datamachine-handler-settings-display",children:Object.entries(n).map(([e,t])=>(0,l.jsxs)("div",{className:"datamachine-handler-settings-entry",children:[(0,l.jsxs)("strong",{children:[t.label,":"]})," ",t.value]},e))}),(0,l.jsx)(le.Button,{variant:"secondary",size:"small",onClick:a,children:(0,re.__)("Configure","datamachine")})]})}function mt({flowId:e,pipelineId:t,flowStepId:a,flowStepConfig:n,pipelineStep:i,pipelineConfig:r,onConfigure:o}){const{data:d={}}=rt(),u=d[i.step_type]||{},h="ai"===i.step_type,p=h?r[i.pipeline_step_id]:null,[m,f]=(0,s.useState)(n.user_message||""),[y,g]=(0,s.useState)(!1),[_,v]=(0,s.useState)(null),b=(0,s.useRef)(null),x=(()=>{const e=c();return _e({mutationFn:({flowStepId:e,message:t})=>(async(e,t)=>await Ne(`/flows/steps/${e}/user-message`,{user_message:t}))(e,t),onMutate:async({pipelineId:t,flowId:a,flowStepId:s,message:n})=>{const i={pipelineId:t,flowId:a,flowStepId:s,patchStep:e=>({...e,user_message:n})},r=Pe(a),l=Pe(t),o=r?e.getQueryData(["flows","single",r]):void 0,c=l?e.getQueryData(["flows",l]):void 0;return qe(e,i),{previousSingle:o,previousList:c}},onError:(t,{pipelineId:a,flowId:s},n)=>{const i=Pe(s),r=Pe(a);i&&n?.previousSingle&&e.setQueryData(["flows","single",i],n.previousSingle),r&&n?.previousList&&e.setQueryData(["flows",r],n.previousList)}})})();(0,s.useEffect)(()=>{f(n.user_message||"")},[n.user_message]);const w=(0,s.useCallback)(async s=>{if(!h)return;const i=n.user_message||"";if(s!==i){g(!0),v(null);try{const n=await x.mutateAsync({pipelineId:t,flowId:e,flowStepId:a,message:s});n?.success||(v(n?.message||(0,re.__)("Failed to update user message","datamachine")),f(i))}catch(e){console.error("User message update error:",e),v(e.message||(0,re.__)("An error occurred","datamachine")),f(i)}finally{g(!1)}}},[e,t,a,n.user_message,h,x]),j=(0,s.useCallback)(e=>{f(e),b.current&&clearTimeout(b.current),b.current=setTimeout(()=>{w(e)},nt)},[w]);return(0,s.useEffect)(()=>()=>{b.current&&clearTimeout(b.current)},[]),(0,l.jsx)(le.Card,{className:`datamachine-flow-step-card datamachine-step-type--${i.step_type}`,size:"small",children:(0,l.jsxs)(le.CardBody,{children:[_&&(0,l.jsx)(le.Notice,{status:"error",isDismissible:!0,onRemove:()=>v(null),children:_}),(0,l.jsxs)("div",{className:"datamachine-step-content",children:[(0,l.jsx)("div",{className:"datamachine-step-header-row",children:(0,l.jsx)("strong",{children:u.label||i.step_type})}),h&&p&&(0,l.jsxs)("div",{className:"datamachine-ai-config-display",children:[(0,l.jsxs)("div",{className:"datamachine-ai-provider-info",children:[(0,l.jsx)("strong",{children:(0,re.__)("AI Provider:","datamachine")})," ",p.provider||"Not configured"," | ",(0,l.jsx)("strong",{children:(0,re.__)("Model:","datamachine")})," ",p.model||"Not configured"]}),(0,l.jsx)(le.TextareaControl,{label:(0,re.__)("User Message","datamachine"),value:m,onChange:j,placeholder:(0,re.__)("Enter user message for AI processing","datamachine"),rows:4,help:y?(0,re.__)("Saving","datamachine"):null})]}),!1!==(d[i.step_type]||{}).uses_handler?(0,l.jsx)(pt,{handlerSlug:n.handler_slug,handlerConfig:n.handler_config||{},settingsDisplay:n.settings_display||[],stepType:i.step_type,onConfigure:()=>o&&o(a)}):null]})]})})}function ft({flowId:e,pipelineId:t,flowConfig:a,pipelineConfig:n,onStepConfigured:i}){const r=(0,s.useMemo)(()=>{if(!a||!n||"object"!=typeof n)return[];const e=Object.entries(a).map(([e,t])=>({flowStepId:e,...t})).sort((e,t)=>(e.execution_order||0)-(t.execution_order||0)),t=Object.values(n);return e.map(e=>{const a=t.find(t=>Ae(t.pipeline_step_id,e.pipeline_step_id));return{flowStepId:e.flowStepId,flowStepConfig:e,pipelineStep:a||{pipeline_step_id:e.pipeline_step_id,step_type:e.step_type,label:"Unknown Step"}}})},[a,n]);return 0===r.length?(0,l.jsx)("div",{className:"datamachine-flow-steps--empty",children:(0,l.jsx)("p",{children:(0,re.__)("No steps configured for this flow.","datamachine")})}):(0,l.jsx)("div",{className:"datamachine-flow-steps",children:(()=>{const a=[];return r.forEach((s,o)=>{a.push((0,l.jsx)("div",{className:"datamachine-flow-step-container",children:(0,l.jsx)(mt,{flowId:e,pipelineId:t,flowStepId:s.flowStepId,flowStepConfig:s.flowStepConfig,pipelineStep:s.pipelineStep,pipelineConfig:n,onConfigure:i})},s.flowStepId)),o<r.length-1&&a.push((0,l.jsx)(dt,{},`arrow-${o}`))}),a})()})}function yt({flowId:e,scheduling:t}){const{interval:a,last_run_display:s,next_run_display:n}=t||{},i=a&&"manual"!==a?a:(0,re.__)("Manual","datamachine");return(0,l.jsxs)("div",{className:"datamachine-flow-footer",children:[(0,l.jsxs)("div",{className:"datamachine-flow-meta-item datamachine-flow-meta-item--id",children:[(0,l.jsx)("strong",{children:(0,re.__)("Flow ID:","datamachine")})," ","#",e]}),(0,l.jsxs)("div",{className:"datamachine-flow-meta-item",children:[(0,l.jsx)("strong",{children:(0,re.__)("Schedule:","datamachine")})," ",i]}),(0,l.jsxs)("div",{className:"datamachine-flow-meta-item",children:[(0,l.jsx)("strong",{children:(0,re.__)("Last Run:","datamachine")})," ",s||(0,re.__)("Never","datamachine")]}),a&&"manual"!==a&&(0,l.jsxs)("div",{className:"datamachine-flow-meta-item",children:[(0,l.jsx)("strong",{children:(0,re.__)("Next Run:","datamachine")})," ",n||(0,re.__)("Never","datamachine")]})]})}function gt(e){const{flow:t,pipelineConfig:a,onFlowDeleted:s,onFlowDuplicated:n}=e;return(0,l.jsx)(_t,{flow:t,pipelineConfig:a,onFlowDeleted:s,onFlowDuplicated:n})}function _t(e){const{flow:t,pipelineConfig:a,onFlowDeleted:n,onFlowDuplicated:i}=e,r=(()=>{const e=c();return _e({mutationFn:({flowId:e})=>(async e=>await Ie(`/flows/${e}`))(e),onSuccess:(t,{flowId:a,pipelineId:s})=>{if(!t?.success)return;const n=Pe(a),i=Pe(s);n&&e.removeQueries({queryKey:["flows","single",n]}),i&&e.setQueryData(["flows",i],(e=[])=>Array.isArray(e)?e.filter(e=>!Ae(e.flow_id,n)):e)}})})(),o=(()=>{const e=c();return _e({mutationFn:({flowId:e})=>(async e=>await Ce(`/flows/${e}/duplicate`))(e),onSuccess:(t,{pipelineId:a})=>{if(!t?.success)return;const s=Pe(a);s&&e.invalidateQueries({queryKey:["flows",s]})}})})(),d=_e({mutationFn:Re}),u=c(),{openModal:h}=$e(),[p,m]=(0,s.useState)(!1),[f,y]=(0,s.useState)(null),g=(0,s.useRef)(0),_=(0,s.useRef)(null);(0,s.useEffect)(()=>()=>{g.current+=1,_.current&&clearTimeout(_.current)},[]);const v=t,b=(0,s.useCallback)(()=>{},[]),x=(0,s.useCallback)(async e=>{try{await r.mutateAsync({flowId:e,pipelineId:v.pipeline_id}),n&&n(e)}catch(e){console.error("Flow deletion error:",e),alert((0,re.__)("An error occurred while deleting the flow","datamachine"))}},[r,n,v.pipeline_id]),w=(0,s.useCallback)(async e=>{try{await o.mutateAsync({flowId:e,pipelineId:v.pipeline_id}),i&&i(e)}catch(e){console.error("Flow duplication error:",e),alert((0,re.__)("An error occurred while duplicating the flow","datamachine"))}},[o,i,v.pipeline_id]),j=(0,s.useCallback)(e=>new Promise(t=>setTimeout(t,e)),[]),C=(0,s.useCallback)(async(e,t,a,s)=>{const n=[500,1e3,2e3,4e3,8e3];for(const i of n){if(await j(i),g.current!==s)return;try{const s=await Ee(e);if(!s?.success||!s?.data)continue;const n=s.data;if(u.setQueryData(["flows","single",e],n),t&&u.setQueryData(["flows",t],(t=[])=>Array.isArray(t)?t.map(t=>Ae(t.flow_id,e)?n:t):t),n.last_run&&n.last_run!==a)return void y(null)}catch(e){continue}}},[u,j]),S=(0,s.useCallback)(async e=>{const t=g.current+1;g.current=t,y((0,re.__)("Queued","datamachine"));try{await d.mutateAsync(e),m(!0),_.current=setTimeout(()=>{m(!1)},2e3),C(e,v.pipeline_id,v.last_run,t)}catch(e){y(null),console.error("Flow execution error:",e),alert((0,re.__)("An error occurred while running the flow","datamachine"))}},[v.last_run,v.pipeline_id,C,d]),N=(0,s.useCallback)(e=>{h(et,{flowId:e,flowName:v.flow_name,currentInterval:v.scheduling_config?.interval||"manual"})},[v.flow_name,v.scheduling_config,h]),I=(0,s.useCallback)(e=>{const t=v.flow_config?.[e]||{},s=t.pipeline_step_id,n=Object.values(a).find(e=>Ae(e.pipeline_step_id,s)),i={flowStepId:e,handlerSlug:t.handler_slug||"",stepType:n?.step_type||t.step_type,pipelineId:v.pipeline_id,flowId:v.flow_id,currentSettings:t.handler_config||{}};t.handler_slug?h(Ze,i):h(Ye,{stepType:i.stepType,flowStepId:i.flowStepId,pipelineId:i.pipelineId,flowId:i.flowId})},[v.flow_config,v.pipeline_id,v.flow_id,a,h]);return v?(0,l.jsx)(le.Card,{className:"datamachine-flow-card datamachine-flow-instance-card",size:"large",children:(0,l.jsxs)(le.CardBody,{children:[(0,l.jsx)(ht,{flowId:v.flow_id,flowName:v.flow_name,onNameChange:b,onDelete:x,onDuplicate:w,onRun:S,onSchedule:N,runSuccess:p}),(0,l.jsx)(le.CardDivider,{}),(0,l.jsx)(ft,{flowId:v.flow_id,pipelineId:v.pipeline_id,flowConfig:v.flow_config||{},pipelineConfig:a,onStepConfigured:I}),(0,l.jsx)(le.CardDivider,{}),(0,l.jsx)(yt,{flowId:v.flow_id,scheduling:{interval:v.scheduling_config?.interval,last_run_display:f||v.last_run_display,next_run_display:v.next_run_display}})]})}):null}function vt({pipelineId:e,onAddFlow:t}){return(0,l.jsx)("div",{className:"datamachine-flow-card--empty",children:(0,l.jsx)(le.Button,{variant:"secondary",onClick:()=>t&&t(e),children:(0,re.__)("Add Flow","datamachine")})})}function bt({pipelineId:e,flows:t,pipelineConfig:a}){const n=(()=>{const e=c();return _e({mutationFn:({pipelineId:e,flowName:t})=>(async(e,t)=>await Ce("/flows",{pipeline_id:e,flow_name:t}))(e,t),onSuccess:(t,{pipelineId:a})=>{const s=Pe(a);e.invalidateQueries({queryKey:["flows",s]})}})})(),i=(0,s.useCallback)(async e=>{try{const t=(0,re.__)("New Flow","datamachine");await n.mutateAsync({pipelineId:e,flowName:t})}catch(e){alert((0,re.__)("An error occurred while creating the flow","datamachine"))}},[n]),r=(0,s.useCallback)(()=>{},[]),o=(0,s.useCallback)(()=>{},[]);return t&&0!==t.length?(0,l.jsxs)("div",{className:"datamachine-flows-section",children:[(0,l.jsx)("div",{className:"datamachine-flows-section__header",children:(0,l.jsxs)("h3",{className:"datamachine-flows-section__title",children:[(0,re.__)("Flows","datamachine")," ",(0,l.jsxs)("span",{className:"datamachine-flows-section__count",children:["(",t.length,")"]})]})}),(0,l.jsxs)("div",{className:"datamachine-flows-list",children:[t.map(e=>(0,l.jsx)(gt,{flow:e,pipelineConfig:a,onFlowDeleted:r,onFlowDuplicated:o},e.flow_id)),(0,l.jsx)(vt,{pipelineId:e,onAddFlow:i})]})]}):(0,l.jsxs)("div",{className:"datamachine-flows-section datamachine-flows-section--empty",children:[(0,l.jsx)("h3",{className:"datamachine-flows-section__title",children:(0,re.__)("Flows","datamachine")}),(0,l.jsx)("p",{className:"datamachine-color--text-muted",children:(0,re.__)("No flows configured. Add your first flow to get started.","datamachine")}),(0,l.jsx)(vt,{pipelineId:e,onAddFlow:i})]})}function xt({pipeline:e,flows:t}){const a=(()=>{const e=c();return _e({mutationFn:({pipelineId:e,stepId:t})=>(async(e,t)=>await Ie(`/pipelines/${e}/steps/${t}`))(e,t),onSuccess:(t,{pipelineId:a})=>{e.invalidateQueries({queryKey:["pipelines"]}),e.invalidateQueries({queryKey:["flows",a]})}})})(),{openModal:n}=$e();if(!e)return null;const i=(0,s.useCallback)(e=>{},[]),r=(0,s.useCallback)(e=>{},[]),o=(0,s.useCallback)(t=>{const a=(e.pipeline_steps||[]).length+1;n(Je,{pipelineId:t,nextExecutionOrder:a})},[e.pipeline_steps,n]),d=(0,s.useCallback)(async t=>{try{await a.mutateAsync({pipelineId:e.pipeline_id,stepId:t})}catch(e){console.error("Step deletion error:",e),alert((0,re.__)("An error occurred while deleting the step","datamachine"))}},[e.pipeline_id,a]),u=(0,s.useCallback)(t=>{const a=e.pipeline_config?.[t.pipeline_step_id]||{};n(Xe,{pipelineId:e.pipeline_id,pipelineStepId:t.pipeline_step_id,stepType:t.step_type,currentConfig:a})},[e.pipeline_id,e.pipeline_config,n]),h=(0,s.useCallback)(()=>{n(st,{pipelineId:e.pipeline_id})},[e.pipeline_id,n]);return(0,l.jsx)(le.Card,{className:"datamachine-pipeline-card",size:"large",children:(0,l.jsxs)(le.CardBody,{children:[(0,l.jsx)(it,{pipelineId:e.pipeline_id,pipelineName:e.pipeline_name,onNameChange:i,onDelete:r,onOpenContextFiles:h}),(0,l.jsx)(le.CardDivider,{}),(0,l.jsx)(ut,{pipelineId:e.pipeline_id,pipelineConfig:e.pipeline_config||{},onStepAdded:o,onStepRemoved:d,onStepConfigured:u}),(0,l.jsx)(le.CardDivider,{}),(0,l.jsx)(bt,{pipelineId:e.pipeline_id,flows:t,pipelineConfig:e.pipeline_config||{}})]})})}function wt(){const{data:e=[],isLoading:t}=Te(),{selectedPipelineId:a,setSelectedPipelineId:s}=$e();if(t||0===e.length)return null;const n=e.map(e=>({label:e.pipeline_name||(0,re.__)("Untitled Pipeline","datamachine"),value:String(e.pipeline_id)}));return(0,l.jsx)("div",{className:"datamachine-pipeline-selector-wrapper datamachine-spacing--margin-bottom-20",children:(0,l.jsx)(le.SelectControl,{label:(0,re.__)("Select Pipeline","datamachine"),value:a||n[0]?.value||"",options:n,onChange:e=>{s(e)},className:"datamachine-pipeline-selector"})})}const jt=(e,t)=>{switch(t.type){case"UPDATE_FIELD":return{...e,data:{...e.data,[t.field]:t.value},error:null};case"UPDATE_DATA":return{...e,data:{...e.data,...t.payload},error:null};case"RESET_DATA":return{...e,data:t.payload,error:null,success:null};case"SET_SUBMITTING":return{...e,isSubmitting:t.payload};case"SET_ERROR":return{...e,error:t.payload};case"SET_SUCCESS":return{...e,success:t.payload};case"RESET_ALL":return{data:t.payload||{},isSubmitting:!1,error:null,success:null};default:return e}},Ct=({initialData:e={},validate:t,onSubmit:a}={})=>{const[n,i]=(0,s.useReducer)(jt,{data:e,isSubmitting:!1,error:null,success:null}),r=(0,s.useRef)(t),l=(0,s.useRef)(a);r.current=t,l.current=a;const o=(0,s.useCallback)((e,t)=>{i({type:"UPDATE_FIELD",field:e,value:t})},[]),c=(0,s.useCallback)(e=>{i({type:"UPDATE_DATA",payload:e})},[]),d=(0,s.useCallback)(e=>{i({type:"RESET_DATA",payload:e})},[]),u=(0,s.useCallback)(e=>{i({type:"RESET_ALL",payload:e})},[]),h=(0,s.useCallback)(e=>{i({type:"SET_ERROR",payload:e})},[]),p=(0,s.useCallback)(e=>{i({type:"SET_SUCCESS",payload:e})},[]),m=(0,s.useCallback)(async()=>{if(!n.isSubmitting){if(i({type:"SET_ERROR",payload:null}),i({type:"SET_SUCCESS",payload:null}),r.current){const e=r.current(n.data);if(e)return void i({type:"SET_ERROR",payload:e})}i({type:"SET_SUBMITTING",payload:!0});try{const e=await l.current(n.data);return i({type:"SET_SUCCESS",payload:e||!0}),e}catch(e){throw i({type:"SET_ERROR",payload:e.message||"An error occurred"}),e}finally{i({type:"SET_SUBMITTING",payload:!1})}}},[n.isSubmitting,n.data]);return{data:n.data,isSubmitting:n.isSubmitting,error:n.error,success:n.success,updateField:o,updateData:c,reset:d,resetAll:u,submit:m,setError:h,setSuccess:p}},St=()=>{const[e,t]=(0,s.useState)(!1),[a,n]=(0,s.useState)(null),[i,r]=(0,s.useState)(null),l=(0,s.useCallback)(async a=>{if(!e){n(null),r(null),t(!0);try{const e=await a();return r(e||!0),e}catch(e){throw n(e.message||"An error occurred"),e}finally{t(!1)}}},[e]),o=(0,s.useCallback)(()=>{t(!1),n(null),r(null)},[]);return{isLoading:e,error:a,success:i,execute:l,reset:o,setError:n,setSuccess:r}};function Nt({onClose:e,pipelineId:t,nextExecutionOrder:a,onSuccess:s}){const{data:n={}}=rt(),{data:i={}}=Qe(),r=(()=>{const e=c();return _e({mutationFn:({pipelineId:e,stepType:t,executionOrder:a})=>(async(e,t,a)=>await Ce(`/pipelines/${e}/steps`,{step_type:t,execution_order:a,label:`${t.charAt(0).toUpperCase()+t.slice(1)} Step`}))(e,t,a),onSuccess:(t,{pipelineId:a})=>{e.invalidateQueries({queryKey:["pipelines"]}),e.invalidateQueries({queryKey:["flows",a]})}})})(),o=St();return(0,l.jsx)(le.Modal,{title:(0,re.__)("Add Pipeline Step","datamachine"),onRequestClose:e,className:"datamachine-step-selection-modal",children:(0,l.jsxs)("div",{className:"datamachine-modal-content",children:[o.error&&(0,l.jsx)("div",{className:"datamachine-modal-error notice notice-error",children:(0,l.jsx)("p",{children:o.error})}),(0,l.jsx)("p",{className:"datamachine-modal-header-text",children:(0,re.__)("Select the type of step you want to add to your pipeline:","datamachine")}),(0,l.jsx)("div",{className:"datamachine-modal-grid-2col",children:Object.entries(n).map(([c,d])=>{const u=(e=>Object.values(i).filter(t=>t.type===e).length)(c);return(0,l.jsxs)("button",{type:"button",className:"datamachine-modal-card",onClick:()=>(n=>{o.execute(async()=>{await r.mutateAsync({pipelineId:t,stepType:n,executionOrder:a}),s&&s(),e()})})(c),disabled:o.isLoading,children:[(0,l.jsx)("strong",{children:n[c]?.label||c}),(0,l.jsx)("p",{children:d.description||""}),"ai"!==c&&u>0&&(0,l.jsxs)("span",{className:"datamachine-modal-card-meta",children:[u," ",1===u?(0,re.__)("handler","datamachine"):(0,re.__)("handlers","datamachine")," ",(0,re.__)("available","datamachine")]})]},c)})}),(0,l.jsx)("div",{className:"datamachine-modal-info-box",children:(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:(0,re.__)("Tip:","datamachine")})," ",(0,re.__)("Steps execute in order. You can configure each step after adding it.","datamachine")]})}),(0,l.jsx)("div",{className:"datamachine-modal-actions",children:(0,l.jsx)(le.Button,{variant:"secondary",onClick:e,disabled:o.isLoading,children:(0,re.__)("Cancel","datamachine")})})]})})}function It({toolId:e,label:t,description:a,checked:s,configured:n,globallyEnabled:i=!0,onChange:r,disabled:o=!1}){const c=o||!i;return(0,l.jsx)("div",{className:"datamachine-tool-checkbox-simple",children:(0,l.jsx)(le.CheckboxControl,{checked:s,onChange:r,disabled:c,__nextHasNoMarginBottom:!0,label:(0,l.jsxs)("div",{className:"datamachine-tool-label-content",children:[(0,l.jsx)("strong",{className:"datamachine-tool-label-title",children:t}),i?a?(0,l.jsx)("p",{className:"datamachine-tool-label-description",children:a}):null:(0,l.jsx)("p",{className:"datamachine-tool-label-description datamachine-global-disabled-text",children:"Disabled globally in Settings"})]})})})}function Ot({unconfiguredTools:e=[]}){return 0===e.length?null:(0,l.jsxs)("div",{className:"datamachine-warning-box datamachine-warning-flex-container",children:[(0,l.jsx)("span",{className:"datamachine-warning-icon",children:""}),(0,l.jsxs)("div",{className:"datamachine-warning-content",children:[(0,l.jsx)("p",{className:"datamachine-warning-title",children:(0,re.__)("Configuration Required","datamachine")}),(0,l.jsx)("p",{className:"datamachine-warning-description",children:(0,re.__)("The following tools require configuration before use:","datamachine")}),(0,l.jsx)("ul",{className:"datamachine-warning-list",children:e.map((e,t)=>(0,l.jsx)("li",{children:e},t))})]})]})}function Dt({selectedTools:e=[],onSelectionChange:t}){const{data:a,isLoading:n}=lt(),i=Object.entries(a||{}).map(([e,t])=>({toolId:e,label:t.label||e,description:t.description||"",configured:t.configured||!1,globallyEnabled:!1!==t.globally_enabled})),r=(0,s.useMemo)(()=>i.filter(t=>e.includes(t.toolId)&&!t.configured).map(e=>e.label),[e,i]);return n?(0,l.jsx)("div",{className:"datamachine-modal-loading-state datamachine-tools-spacing--mt-16",children:(0,re.__)("Loading AI tools...","datamachine")}):0===i.length?null:(0,l.jsxs)("div",{className:"datamachine-tools-spacing--mt-16",children:[(0,l.jsx)("label",{className:"datamachine-section-header",children:(0,re.__)("AI Tools","datamachine")}),(0,l.jsx)("p",{className:"datamachine-warning-description datamachine-ai-tools-description",children:(0,re.__)("Select the tools you want to enable for this AI step:","datamachine")}),(0,l.jsx)("div",{className:"datamachine-ai-tools-grid",children:i.map(a=>(0,l.jsx)(It,{toolId:a.toolId,label:a.label,description:a.description,checked:e.includes(a.toolId),configured:a.configured,globallyEnabled:a.globallyEnabled,onChange:()=>(a=>{const s=e.includes(a)?e.filter(e=>e!==a):[...e,a];t&&t(s)})(a.toolId)},a.toolId))}),(0,l.jsx)(Ot,{unconfiguredTools:r})]})}function kt({onClose:e,pipelineId:t,pipelineStepId:a,stepType:n,currentConfig:i,onSuccess:r}){const[o,d]=(0,s.useState)(i?.enabled_tools||[]),u=(()=>{const e=c();return _e({mutationFn:({stepId:e,prompt:t,provider:a,model:s,enabledTools:n,stepType:i,pipelineId:r})=>ke(e,t,a,s,n,i,r),onSuccess:(t,{pipelineId:a})=>{e.invalidateQueries({queryKey:["pipelines"]}),e.invalidateQueries({queryKey:["flows",a]})}})})(),h=(0,s.useMemo)(()=>JSON.stringify({provider:i?.provider,model:i?.model,system_prompt:i?.system_prompt,enabled_tools:i?.enabled_tools}),[i?.provider,i?.model,i?.system_prompt,i?.enabled_tools]),p=Ct({initialData:{provider:i?.provider||"",model:i?.model||"",systemPrompt:i?.system_prompt||""},validate:e=>e.provider?e.model?null:(0,re.__)("Please select an AI model","datamachine"):(0,re.__)("Please select an AI provider","datamachine"),onSubmit:async s=>{const i=await u.mutateAsync({stepId:a,prompt:s.systemPrompt,provider:s.provider,model:s.model,enabledTools:o,stepType:n,pipelineId:t});if(!i.success)throw new Error(i.message||(0,re.__)("Failed to update configuration","datamachine"));e()}}),{data:m,isLoading:f}=ye({queryKey:["config","providers"],queryFn:async()=>{const e=await(async()=>await je("/providers"))();return e.success?e.data:{}},staleTime:18e5}),y=m?.providers||{},g=m?.defaults||{provider:"",model:""},{data:_,isLoading:v}=lt();(0,s.useEffect)(()=>{if(!f&&!v){if(p.reset({provider:i?.provider||g.provider,model:i?.model||g.model,systemPrompt:i?.system_prompt||""}),!i?.enabled_tools&&_){const e=Object.entries(_).filter(([e,t])=>t.globally_enabled).map(([e])=>e);d(e)}else i?.enabled_tools&&d(i.enabled_tools);p.setError(null)}},[h,g.provider,g.model,_,f,v]);const b=(0,s.useMemo)(()=>{const e=[{value:"",label:(0,re.__)("Select Provider...","datamachine")}];return Object.entries(y).forEach(([t,a])=>{e.push({value:t,label:a.label||t})}),e},[y]),x=(0,s.useMemo)(()=>{if(!p.data.provider||!y[p.data.provider])return[{value:"",label:(0,re.__)("Select provider first...","datamachine")}];const e=[{value:"",label:(0,re.__)("Select Model...","datamachine")}],t=y[p.data.provider];return t.models&&(Array.isArray(t.models)?t.models.forEach(t=>{e.push({value:t.id,label:t.name||t.id})}):"object"==typeof t.models&&Object.entries(t.models).forEach(([t,a])=>{e.push({value:t,label:a||t})})),e},[p.data.provider,y]);return(0,l.jsx)(le.Modal,{title:(0,re.__)("Configure AI Step","datamachine"),onRequestClose:e,className:"datamachine-configure-step-modal",children:(0,l.jsxs)("div",{className:"datamachine-modal-content",children:[p.error&&(0,l.jsx)("div",{className:"datamachine-modal-error notice notice-error",children:(0,l.jsx)("p",{children:p.error})}),(0,l.jsx)(le.SelectControl,{label:(0,re.__)("AI Provider","datamachine"),value:p.data.provider,options:b,onChange:e=>{p.updateData({...p.data,provider:e,model:""})},disabled:f||v,help:(0,re.__)("Choose the AI provider for this step.","datamachine")}),(0,l.jsx)(le.SelectControl,{label:(0,re.__)("AI Model","datamachine"),value:p.data.model,options:x,onChange:e=>p.updateField("model",e),disabled:f||v||!p.data.provider,help:(0,re.__)("Choose the AI model to use.","datamachine")}),(0,l.jsx)(Dt,{selectedTools:o,onSelectionChange:d}),(0,l.jsx)("div",{className:"datamachine-form-field-wrapper",children:(0,l.jsx)(le.TextareaControl,{label:(0,re.__)("System Prompt","datamachine"),value:p.data.systemPrompt,onChange:e=>p.updateField("systemPrompt",e),placeholder:(0,re.__)("Enter system prompt for AI processing...","datamachine"),rows:8,help:(0,re.__)("Optional: Provide instructions for the AI to follow during processing.","datamachine")})}),(0,l.jsx)("div",{className:"datamachine-modal-info-box datamachine-modal-info-box--note",children:(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:(0,re.__)("Note:","datamachine")})," ",(0,re.__)("The system prompt is shared across all flows using this pipeline. To add flow-specific instructions, use the user message field in the flow step card.","datamachine")]})}),(0,l.jsxs)("div",{className:"datamachine-modal-actions",children:[(0,l.jsx)(le.Button,{variant:"secondary",onClick:e,disabled:p.isSubmitting,children:(0,re.__)("Cancel","datamachine")}),(0,l.jsx)(le.Button,{variant:"primary",onClick:p.submit,disabled:p.isSubmitting||!p.data.provider||!p.data.model,isBusy:p.isSubmitting,children:p.isSubmitting?(0,re.__)("Saving...","datamachine"):(0,re.__)("Save Configuration","datamachine")})]})]})})}function Et({onClose:e,flowId:t,flowName:a,currentInterval:n,onSuccess:i}){const r=(()=>{const e=c();return _e({mutationFn:({flowId:e,schedulingConfig:t})=>(async(e,t)=>await Ne(`/flows/${e}`,{scheduling_config:t}))(e,t),onSuccess:(t,{flowId:a})=>{if(!t?.success||!t?.data)return;const s=Pe(a),n=t.data,i=n.pipeline_id,r=Pe(i);s&&e.setQueryData(["flows","single",s],n),r&&e.setQueryData(["flows",r],(e=[])=>Array.isArray(e)?e.map(e=>Ae(e.flow_id,s)?n:e):e)}})})(),o=Ct({initialData:{selectedInterval:n||"manual"},onSubmit:async a=>{try{await r.mutateAsync({flowId:t,schedulingConfig:{interval:a.selectedInterval}}),i&&i(),e()}catch(e){throw new Error(e.message||"Failed to update schedule")}}}),d=St(),[u,h]=(0,s.useState)([]);return(0,s.useEffect)(()=>{0===u.length&&d.execute(async()=>{const e=await(async()=>await je("/settings/scheduling-intervals"))();if(!e.success||!e.data)throw h([]),new Error((0,re.__)("Failed to load scheduling intervals. Please refresh the page and try again.","datamachine"));h(e.data)})},[u.length,d]),(0,l.jsx)(le.Modal,{title:(0,re.__)("Schedule Flow","datamachine"),onRequestClose:e,className:"datamachine-flow-schedule-modal",children:(0,l.jsxs)("div",{className:"datamachine-modal-content",children:[(o.error||d.error)&&(0,l.jsx)("div",{className:"datamachine-modal-error notice notice-error",children:(0,l.jsx)("p",{children:o.error||d.error})}),(0,l.jsxs)("div",{className:"datamachine-modal-spacing--mb-20",children:[(0,l.jsx)("strong",{children:(0,re.__)("Flow:","datamachine")})," ",a]}),(0,l.jsx)(le.SelectControl,{label:(0,re.__)("Schedule Interval","datamachine"),value:o.data.selectedInterval,options:u,onChange:e=>o.updateField("selectedInterval",e),disabled:d.isLoading||0===u.length,help:(0,re.__)("Choose how often this flow should run automatically.","datamachine")}),"manual"===o.data.selectedInterval&&(0,l.jsx)("div",{className:"datamachine-modal-info-box datamachine-modal-info-box--highlight",children:(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:(0,re.__)("Manual Mode:","datamachine")})," ",(0,re.__)('Flow will only run when triggered manually via the "Run Now" button.',"datamachine")]})}),"manual"!==o.data.selectedInterval&&(0,l.jsx)("div",{className:"datamachine-modal-info-box datamachine-modal-info-box--note",children:(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:(0,re.__)("Automatic Scheduling:","datamachine")})," ",(0,re.__)("Flow will run automatically based on the selected interval. You can still trigger it manually anytime.","datamachine")]})}),(0,l.jsxs)("div",{className:"datamachine-modal-actions",children:[(0,l.jsx)(le.Button,{variant:"secondary",onClick:e,disabled:o.isSubmitting,children:(0,re.__)("Cancel","datamachine")}),(0,l.jsx)(le.Button,{variant:"primary",onClick:()=>{o.submit()},disabled:o.isSubmitting||0===u.length,isBusy:o.isSubmitting,children:o.isSubmitting?(0,re.__)("Saving...","datamachine"):(0,re.__)("Save Schedule","datamachine")})]})]})})}var Rt=a(848),At=a(154);function Ft({onFileSelected:e,allowedTypes:t=["pdf","csv","txt","json"],maxSizeMB:a=10,disabled:n=!1,uploadText:i=null}){const[r,o]=(0,s.useState)(!1),[c,d]=(0,s.useState)(null),u=(0,s.useRef)(null),h=()=>t.map(e=>e.toUpperCase()).join(", "),p=s=>{const n=s.name.split(".").pop().toLowerCase();if(!t.includes(n))return void d((0,re.__)(`Please select a valid file. Allowed types: ${h()}`,"datamachine"));const i=1024*a*1024;s.size>i?d((0,re.__)(`File size exceeds ${a}MB limit.`,"datamachine")):e&&(e(s),d(null))},m=()=>{u.current&&u.current.click()},f=(0,re.__)("Drag and drop file here","datamachine");return(0,l.jsxs)("div",{children:[(0,l.jsxs)("div",{onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),n||o(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),o(!1)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDrop:e=>{if(e.preventDefault(),e.stopPropagation(),o(!1),n)return;const t=e.dataTransfer.files;t.length>0&&p(t[0])},className:"datamachine-dropzone "+(r?"datamachine-dropzone--dragging":""),onClick:n?void 0:m,children:[(0,l.jsx)("div",{className:"datamachine-dropzone-icon",children:""}),(0,l.jsx)("p",{className:"datamachine-dropzone-title",children:i||f}),(0,l.jsx)("p",{className:"datamachine-dropzone-helper",children:(0,re.__)(`Allowed: ${h()} (max ${a}MB)`,"datamachine")}),(0,l.jsx)("p",{className:"datamachine-dropzone-or",children:(0,re.__)("or","datamachine")}),(0,l.jsx)(le.Button,{variant:"secondary",onClick:m,disabled:n,children:(0,re.__)("Browse Files","datamachine")}),(0,l.jsx)("input",{ref:u,type:"file",accept:t.map(e=>`.${e}`).join(","),onChange:e=>{const t=e.target.files;t.length>0&&p(t[0])},className:"datamachine-hidden",disabled:n})]}),c&&(0,l.jsx)("div",{className:"datamachine-dropzone-error",children:c})]})}function Pt({onFileUploaded:e}){const t=(()=>{const[e,t]=(0,s.useState)(!1),[a,n]=(0,s.useState)(null),[i,r]=(0,s.useState)(null),l=(0,s.useCallback)(async a=>{if(!e){n(null),r(null),t(!0);try{const e=await a();return r(e||!0),e}catch(e){throw n(e.message||"Upload failed"),e}finally{t(!1)}}},[e]),o=(0,s.useCallback)(()=>{t(!1),n(null),r(null)},[]);return{isUploading:e,error:a,success:i,upload:l,reset:o,setError:n,setSuccess:r}})();return(0,l.jsxs)("div",{children:[t.error&&(0,l.jsx)(le.Notice,{status:"error",isDismissible:!0,onRemove:()=>t.setError(null),children:(0,l.jsx)("p",{children:t.error})}),t.success&&(0,l.jsx)(le.Notice,{status:"success",isDismissible:!0,onRemove:()=>t.reset(),children:(0,l.jsx)("p",{children:t.success})}),(0,l.jsx)(Ft,{onFileSelected:a=>{t.upload(async()=>(await new Promise(e=>setTimeout(e,1e3)),e&&e({file_name:a.name,file_size:a.size,status:"pending"}),(0,re.__)("File uploaded successfully!","datamachine")))},allowedTypes:["pdf","csv","txt","json","jpg","jpeg","png","gif"],maxSizeMB:Math.round((window.dataMachineConfig?.maxUploadSize||10485760)/1048576),disabled:t.isUploading,uploadText:t.isUploading?(0,re.__)("Uploading...","datamachine"):null})]})}function Tt({files:e=[]}){const t=e=>{const t={processed:{label:(0,re.__)("Processed","datamachine"),icon:""},pending:{label:(0,re.__)("Pending","datamachine"),icon:""}},a=t[e]||t.pending,s=`datamachine-status-badge datamachine-status-badge--${e||"pending"}`;return(0,l.jsxs)("span",{className:s,children:[(0,l.jsx)("span",{children:a.icon}),a.label]})};return 0===e.length?(0,l.jsx)("div",{className:"datamachine-modal-empty-state datamachine-modal-empty-state--bordered",children:(0,l.jsx)("p",{className:"datamachine-text--margin-reset",children:(0,re.__)("No files uploaded yet.","datamachine")})}):(0,l.jsx)("div",{className:"datamachine-table-container datamachine-table-container--small",children:(0,l.jsxs)("table",{className:"datamachine-pipeline-table",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{className:"datamachine-table-sticky-header",children:[(0,l.jsx)("th",{children:(0,re.__)("File Name","datamachine")}),(0,l.jsx)("th",{className:"datamachine-table-cell--center datamachine-table-col--compact",children:(0,re.__)("Status","datamachine")})]})}),(0,l.jsx)("tbody",{children:e.map((e,a)=>(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{className:"datamachine-table-cell--medium",children:e.file_name}),(0,l.jsx)("td",{className:"datamachine-table-cell--center",children:t(e.status)})]},a))})]})})}function qt({checked:e,onChange:t}){return(0,l.jsx)("div",{className:"datamachine-auto-cleanup-option",children:(0,l.jsx)(le.CheckboxControl,{label:(0,re.__)("Automatically delete files after processing","datamachine"),checked:e,onChange:t,help:(0,re.__)("Files will be removed from the handler after successful processing. Disable to keep files for multiple uses.","datamachine")})})}function Mt({currentSettings:e={},onSettingsChange:t}){const[a,n]=(0,s.useState)(e.files||[]),[i,r]=(0,s.useState)(!1!==e.auto_cleanup);return(0,s.useEffect)(()=>{t&&t({files:a,auto_cleanup:i})},[a,i,t]),(0,l.jsxs)("div",{className:"datamachine-files-handler-settings",children:[(0,l.jsxs)("div",{className:"datamachine-files-section",children:[(0,l.jsx)("h4",{className:"datamachine-files-section-title",children:(0,re.__)("Upload Files","datamachine")}),(0,l.jsx)("p",{className:"datamachine-files-section-description",children:(0,re.__)("Upload files to be processed by this flow. Each file will be processed individually.","datamachine")})]}),(0,l.jsx)(Pt,{onFileUploaded:e=>{n(t=>[...t,e])}}),(0,l.jsxs)("div",{className:"datamachine-files-section datamachine-files-section-spacing--mt-24",children:[(0,l.jsx)("h4",{className:"datamachine-files-section-title",children:(0,re.__)("Uploaded Files","datamachine")}),(0,l.jsx)("p",{className:"datamachine-files-section-description",children:(0,re.__)("Files will be processed in order when the flow runs.","datamachine")})]}),(0,l.jsx)(Tt,{files:a}),(0,l.jsx)(qt,{checked:i,onChange:e=>{r(e)}}),(0,l.jsx)("div",{className:"datamachine-modal-info-box datamachine-modal-info-box--highlight datamachine-modal-spacing--mt-16",children:(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:(0,re.__)("Note:","datamachine")})," ",(0,re.__)("Files are stored specifically for this flow. Each uploaded file will create a separate processing job when the flow runs.","datamachine")]})})]})}class Qt extends At.A{constructor(e,t={},a={}){super(e,t,a)}sanitizeForAPI(e={}){const t={...e};return Array.isArray(t.files)&&(t.files=t.files.map(e=>"string"==typeof e?e:e.id||e.file_id||e.name)),super.sanitizeForAPI(t)}renderSettingsEditor(e={}){return Mt?(0,l.jsx)(Mt,{...e}):null}}(0,Rt.$P)("files",Qt);const Lt=(0,r.createContext)(null),Bt=({children:e})=>{const{data:t={}}=Qe(),a=(0,r.useMemo)(()=>{const e=new Map;return Object.entries(t).forEach(([t,a])=>{const s=(0,Rt.default)(t,a,{});e.set(t,{model:s,descriptor:a})}),e},[t]);return(0,l.jsx)(Lt.Provider,{value:{handlers:t,handlerModels:a,getModel:(e,a={})=>{const s=t[e]||{};return(0,Rt.default)(e,s,a)}},children:e})},Ut=()=>(0,r.useContext)(Lt);function Kt({onClose:e,stepType:t,onSelectHandler:a,handlers:n}){const[i,r]=(0,s.useState)(null),{handlers:o,getModel:c}=Ut()||{},d=Object.entries(o||n).filter(([,e])=>e.type===t);return(0,l.jsx)(le.Modal,{title:(0,re.__)("Select Handler","datamachine"),onRequestClose:e,className:"datamachine-handler-selection-modal",children:(0,l.jsxs)("div",{className:"datamachine-modal-content",children:[(0,l.jsx)("p",{className:"datamachine-modal-header-text",children:(0,re.__)("Choose the handler for this step:","datamachine")}),0===d.length&&(0,l.jsx)("div",{className:"datamachine-modal-empty-state datamachine-modal-empty-state--bordered",children:(0,l.jsx)("p",{className:"datamachine-text--margin-reset",children:(0,re.__)("No handlers available for this step type.","datamachine")})}),d.length>0&&(0,l.jsx)("div",{className:"datamachine-modal-grid-2col",children:d.map(([e,t])=>{const s=c?c(e,null):null,n=s?s.getLabel():t.label||e,i=s?s.getDescription():t.description||"",o=s?s.requiresAuth():t.requires_auth||t.requiresAuth;return(0,l.jsxs)("button",{type:"button",className:"datamachine-modal-card",onClick:()=>(async e=>{if(a){r(null);try{await a(e)}catch(e){console.error("Handler selection error:",e),r(e?.message||"An error occurred while assigning the handler.")}}})(e),children:[(0,l.jsx)("strong",{children:n}),(0,l.jsx)("p",{children:i}),o&&(0,l.jsx)("span",{className:"datamachine-modal-badge",children:(0,re.__)("Requires Auth","datamachine")})]},e)})}),i&&(0,l.jsx)("div",{className:"datamachine-modal-error",children:(0,l.jsx)(le.Notice,{status:"error",isDismissible:!1,children:(0,l.jsx)("p",{children:i})})}),(0,l.jsx)("div",{className:"datamachine-modal-actions",children:(0,l.jsx)(le.Button,{variant:"secondary",onClick:e,children:(0,re.__)("Cancel","datamachine")})})]})})}const zt=window.wp.hooks;function Ht({fieldKey:e,fieldConfig:t={},value:a,onChange:s,onBatchChange:n,handlerSlug:i}){var r,o;const c=t.label||e,d=t.description||"",u=void 0!==a?a:null!==(r=null!==(o=t.current_value)&&void 0!==o?o:t.default)&&void 0!==r?r:"",h=t=>{"function"==typeof s&&s(e,t)},p="datamachine-handler-field",m=(0,zt.applyFilters)("datamachine.handlerSettings.fieldComponent",null,t.type,e,i);if(m)return(0,l.jsx)(m,{fieldKey:e,fieldConfig:t,value:u,onChange:s,onBatchChange:n,handlerSlug:i});switch(t.type){case"info":return(0,l.jsx)("div",{className:p,children:(0,l.jsxs)(le.Notice,{status:"info",isDismissible:!1,children:[(0,l.jsx)("strong",{children:c}),(0,l.jsx)("p",{dangerouslySetInnerHTML:{__html:d}})]})});case"textarea":return(0,l.jsx)("div",{className:p,children:(0,l.jsx)(le.TextareaControl,{label:c,value:u,onChange:h,rows:t.rows||4,help:d,placeholder:t.placeholder})});case"select":return(0,l.jsx)("div",{className:p,children:(0,l.jsx)(le.SelectControl,{label:c,value:u,options:(t.options||[]).map(e=>"separator"===e.value?{...e,disabled:!0}:e),onChange:h,help:d})});case"checkbox":return(0,l.jsx)("div",{className:p,children:(0,l.jsx)(le.CheckboxControl,{label:c,checked:!!u,onChange:h,help:d})});default:return(0,l.jsx)("div",{className:p,children:(0,l.jsx)(le.TextControl,{label:c,value:u,onChange:h,help:d,placeholder:t.placeholder})})}}function $t({onClose:e,flowStepId:t,handlerSlug:a,stepType:n,pipelineId:i,flowId:o,currentSettings:c,onSuccess:d,onChangeHandler:u,onOAuthConnect:h,handlers:p,handlerDetails:m}){const f=null==m,y=Me(),[g,_]=(0,s.useState)({}),[v,b]=(0,s.useState)(!1),x=(0,s.useRef)(null),w=function(e){const{getModel:t}=Ut()||{},{data:a}=Le(e);return(0,r.useMemo)(()=>e&&t?t(e,a||{}):null,[e,t,a])}(a),j=Ct({initialData:c||{},onSubmit:async s=>{const r=w?w.sanitizeForAPI(s,g):s,l=await y.mutateAsync({flowStepId:t,handlerSlug:a,settings:r,pipelineId:i,stepType:n});if(!l||!l.success){const e=l?.message||(0,re.__)("Failed to update handler settings","datamachine");throw new Error(e)}d&&d(),e()}});(0,s.useEffect)(()=>{m?.settings&&_(m.settings)},[m]),(0,s.useEffect)(()=>{(async()=>{let e=c||{};const t=JSON.stringify(c||{});if(x.current!==t){b(!0);try{e=await(0,zt.applyFilters)("datamachine.handlerSettings.init",Promise.resolve(e),a,m?.settings||{}),x.current=t}catch(e){console.error("Handler settings enrichment failed:",e)}if(b(!1),w){const t=w.normalizeForForm(e,m?.settings||{});j.reset(t)}else j.reset(e)}})()},[c,w,m]);const C=p[a]||{},S=async(e,t)=>{j.updateField(e,t);try{const s=await(0,zt.applyFilters)("datamachine.handlerSettings.fieldChange",Promise.resolve({}),e,t,a,{...j.data,[e]:t});s&&Object.keys(s).length>0&&j.updateData(s)}catch(e){console.error("Handler settings field change enrichment failed:",e)}};return(0,l.jsx)(le.Modal,{title:C.label?(0,re.sprintf)((0,re.__)("Configure %s Settings","datamachine"),C.label):(0,re.__)("Configure Handler Settings","datamachine"),onRequestClose:e,className:"datamachine-handler-settings-modal",children:(0,l.jsxs)("div",{className:"datamachine-modal-content",children:[j.error&&(0,l.jsx)("div",{className:"datamachine-modal-error notice notice-error",children:(0,l.jsx)("p",{children:j.error})}),(0,l.jsxs)("div",{className:"datamachine-modal-section",children:[(0,l.jsxs)("div",{className:"datamachine-modal-header-section",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:(0,re.__)("Handler:","datamachine")})," ",C.label||a]}),(0,l.jsx)(le.Button,{variant:"secondary",size:"small",onClick:u,children:(0,re.__)("Change Handler","datamachine")})]}),C.requires_auth&&(0,l.jsx)("div",{className:"datamachine-modal-handler-display",children:C.is_authenticated?(0,l.jsxs)("div",{className:"datamachine-auth-status datamachine-auth-status--connected",children:[(0,l.jsx)("span",{className:"dashicons dashicons-yes-alt"}),(0,l.jsx)("span",{children:C.account_details?.username?(0,re.sprintf)((0,re.__)("Connected as %s","datamachine"),C.account_details.username):(0,re.__)("Account Connected","datamachine")}),(0,l.jsx)(le.Button,{variant:"link",size:"small",onClick:()=>{h&&h(a,C)},children:(0,re.__)("Manage Connection","datamachine")})]}):(0,l.jsx)(le.Button,{variant:"secondary",onClick:()=>{h&&h(a,C)},children:(0,re.__)("Connect Account","datamachine")})})]}),(f||v)&&(0,l.jsx)("div",{className:"datamachine-modal-loading-state",children:(0,l.jsx)("p",{className:"datamachine-modal-loading-text",children:(0,re.__)("Loading handler settings...","datamachine")})}),(()=>{if(f)return null;const e=w?.renderSettingsEditor?.({currentSettings:j.data,onSettingsChange:j.updateData,handlerDetails:m});return e||(0,l.jsxs)(l.Fragment,{children:[0===Object.keys(g).length&&(0,l.jsx)("div",{className:"datamachine-modal-no-config",children:(0,l.jsx)("p",{children:(0,re.__)("No configuration options available for this handler.","datamachine")})}),Object.keys(g).length>0&&(0,l.jsx)("div",{className:"datamachine-handler-settings-fields",children:Object.entries(g).map(([e,t])=>{var s,n;return(0,l.jsx)(Ht,{fieldKey:e,fieldConfig:t,value:void 0!==j.data?.[e]?j.data[e]:null!==(s=null!==(n=t.default)&&void 0!==n?n:t.current_value)&&void 0!==s?s:"",onChange:S,onBatchChange:j.updateData,handlerSlug:a},e)})})]})})(),(0,l.jsxs)("div",{className:"datamachine-modal-actions",children:[(0,l.jsx)(le.Button,{variant:"secondary",onClick:e,disabled:j.isSubmitting,children:(0,re.__)("Cancel","datamachine")}),(0,l.jsx)(le.Button,{variant:"primary",onClick:j.submit,disabled:j.isSubmitting,isBusy:j.isSubmitting,children:j.isSubmitting?(0,re.__)("Saving...","datamachine"):(0,re.__)("Save Settings","datamachine")})]})]})})}function Gt({pipelines:e,selectedIds:t,onSelectionChange:a}){const s=e.length>0&&t.length===e.length;return(0,l.jsx)("div",{className:"datamachine-pipeline-table-wrapper",children:(0,l.jsxs)("table",{className:"datamachine-pipeline-table",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{className:"datamachine-pipeline-table-header",children:[(0,l.jsx)("th",{className:"datamachine-table-col--40",children:(0,l.jsx)(le.CheckboxControl,{checked:s,onChange:()=>{t.length===e.length?a([]):a(e.map(e=>Pe(e.pipeline_id)))},__nextHasNoMarginBottom:!0})}),(0,l.jsx)("th",{children:(0,re.__)("Pipeline Name","datamachine")}),(0,l.jsx)("th",{className:"datamachine-table-col--100",children:(0,re.__)("Steps","datamachine")}),(0,l.jsx)("th",{className:"datamachine-table-col--100",children:(0,re.__)("Flows","datamachine")})]})}),(0,l.jsxs)("tbody",{children:[0===e.length&&(0,l.jsx)("tr",{children:(0,l.jsx)("td",{colSpan:"4",className:"datamachine-pipeline-table-empty",children:(0,re.__)("No pipelines available","datamachine")})}),e.map(e=>{const s=Object.keys(e.pipeline_config||{}).length,n=e.flows?.length||0,i=Fe(t,e.pipeline_id),r=i?"datamachine-pipeline-table-row datamachine-pipeline-table-row--selected":"datamachine-pipeline-table-row";return(0,l.jsxs)("tr",{className:r,children:[(0,l.jsx)("td",{children:(0,l.jsx)(le.CheckboxControl,{checked:i,onChange:()=>(e=>{const s=Pe(e),n=Fe(t,e)?t.filter(t=>!Ae(t,e)):[...t,s];a(n)})(e.pipeline_id),__nextHasNoMarginBottom:!0})}),(0,l.jsx)("td",{className:"datamachine-pipeline-table-name",children:e.pipeline_name}),(0,l.jsx)("td",{className:"datamachine-pipeline-table-meta",children:s}),(0,l.jsx)("td",{className:"datamachine-pipeline-table-meta",children:n})]},e.pipeline_id)})]})]})})}function Vt({pipelines:e,onClose:t}){const[a,n]=(0,s.useState)([]),i=St();return(0,l.jsxs)("div",{className:"datamachine-export-tab",children:[i.error&&(0,l.jsx)(le.Notice,{status:"error",isDismissible:!0,onRemove:()=>i.setError(null),children:(0,l.jsx)("p",{children:i.error})}),i.success&&(0,l.jsx)(le.Notice,{status:"success",isDismissible:!0,onRemove:()=>i.reset(),children:(0,l.jsx)("p",{children:i.success})}),(0,l.jsx)("p",{className:"datamachine-import-export-description",children:(0,re.__)("Select the pipelines you want to export to CSV:","datamachine")}),(0,l.jsx)(Gt,{pipelines:e,selectedIds:a,onSelectionChange:n}),(0,l.jsxs)("div",{className:"datamachine-tab-actions",children:[(0,l.jsx)(le.Button,{variant:"secondary",onClick:t,disabled:i.isLoading,children:(0,re.__)("Cancel","datamachine")}),(0,l.jsx)(le.Button,{variant:"primary",onClick:()=>{0!==a.length?i.execute(async()=>{const e=await(async e=>await je("/pipelines",{format:"csv",ids:e.join(",")}))(a);if(e.success&&e.data.csv_content){const t=new Blob([e.data.csv_content],{type:"text/csv"}),a=URL.createObjectURL(t),s=document.createElement("a");return s.href=a,s.download=`datamachine-pipelines-${Date.now()}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a),n([]),(0,re.__)("Pipelines exported successfully!","datamachine")}throw new Error(e.message||(0,re.__)("Failed to export pipelines","datamachine"))}):i.setError((0,re.__)("Please select at least one pipeline to export.","datamachine"))},disabled:i.isLoading||0===a.length,isBusy:i.isLoading,children:i.isLoading?(0,re.__)("Exporting...","datamachine"):(0,re.__)("Export Selected","datamachine")})]})]})}function Wt({onFileSelected:e,fileName:t,disabled:a=!1}){const n=(0,s.useRef)(null),i=(()=>{const[e,t]=(0,s.useState)(!1),[a,n]=(0,s.useState)(null);return{isDragging:e,error:a,handleDragEnter:(0,s.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),t(!0)},[]),handleDragLeave:(0,s.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),t(!1)},[]),handleDragOver:(0,s.useCallback)(e=>{e.preventDefault(),e.stopPropagation()},[]),handleDrop:(0,s.useCallback)((e,a)=>{e.preventDefault(),e.stopPropagation(),t(!1),n(null);const s=Array.from(e.dataTransfer.files);if(0!==s.length)try{a(s)}catch(e){n(e.message||"File processing failed")}},[]),reset:(0,s.useCallback)(()=>{t(!1),n(null)},[]),setError:n}})(),r=t=>{if(!t.name.endsWith(".csv")&&"text/csv"!==t.type)return void i.setError((0,re.__)("Please select a valid CSV file.","datamachine"));const a=window.dataMachineConfig?.maxUploadSize||10485760;if(t.size>a){const e=Math.round(a/1048576);return void i.setError((0,re.__)(`File size exceeds ${e}MB limit.`,"datamachine"))}const s=new FileReader;s.onload=a=>{const s=a.target.result;e&&(e(s,t.name),i.setError(null))},s.onerror=()=>{i.setError((0,re.__)("Failed to read file.","datamachine"))},s.readAsText(t)},o=()=>{n.current&&n.current.click()},c=["datamachine-csv-dropzone",i.isDragging&&"datamachine-csv-dropzone--dragging",a&&"datamachine-csv-dropzone--disabled"].filter(Boolean).join(" ");return(0,l.jsxs)("div",{children:[(0,l.jsxs)("div",{className:c,onDragEnter:i.handleDragEnter,onDragLeave:i.handleDragLeave,onDragOver:i.handleDragOver,onDrop:i.handleDrop.bind(null,e=>{e.length>0&&r(e[0])}),onClick:a?void 0:o,children:[(0,l.jsx)("div",{className:"datamachine-csv-dropzone__icon",children:""}),(0,l.jsx)("p",{className:"datamachine-csv-dropzone__title",children:t?(0,re.__)("File selected","datamachine"):(0,re.__)("Drag and drop CSV file here","datamachine")}),(0,l.jsx)("p",{className:"datamachine-csv-dropzone__divider",children:(0,re.__)("or","datamachine")}),(0,l.jsx)(le.Button,{variant:"secondary",onClick:o,disabled:a,children:(0,re.__)("Browse Files","datamachine")}),(0,l.jsx)("input",{ref:n,type:"file",accept:".csv,text/csv",onChange:e=>{const t=e.target.files;t.length>0&&r(t[0])},className:"datamachine-hidden",disabled:a})]}),i.error&&(0,l.jsx)("div",{className:"datamachine-csv-dropzone__error",children:i.error})]})}function Jt({onSuccess:e,onClose:t}){const[a,n]=(0,s.useState)(null),[i,r]=(0,s.useState)(""),o=St();return(0,l.jsxs)("div",{className:"datamachine-import-tab",children:[o.error&&(0,l.jsx)(le.Notice,{status:"error",isDismissible:!0,onRemove:()=>o.setError(null),children:(0,l.jsx)("p",{children:o.error})}),o.success&&(0,l.jsx)(le.Notice,{status:"success",isDismissible:!0,onRemove:()=>o.reset(),children:(0,l.jsx)("p",{children:o.success})}),(0,l.jsx)("p",{className:"datamachine-import-export-description",children:(0,re.__)("Upload a CSV file to import pipelines:","datamachine")}),(0,l.jsx)(Wt,{onFileSelected:(e,t)=>{n(e),r(t),o.setError(null),o.reset()},fileName:i,disabled:o.isLoading}),i&&(0,l.jsxs)("div",{className:"datamachine-file-selected-display",children:[(0,l.jsxs)("span",{className:"datamachine-file-selected-label",children:[(0,re.__)("Selected:","datamachine")," ",i]}),(0,l.jsx)(le.Button,{variant:"link",onClick:()=>{n(null),r(""),o.setError(null),o.reset()},disabled:o.isLoading,className:"datamachine-button--destructive",children:(0,re.__)("Clear","datamachine")})]}),(0,l.jsxs)("div",{className:"datamachine-tab-actions",children:[(0,l.jsx)(le.Button,{variant:"secondary",onClick:t,disabled:o.isLoading,children:(0,re.__)("Cancel","datamachine")}),(0,l.jsx)(le.Button,{variant:"primary",onClick:()=>{a?o.execute(async()=>{const t=await(async e=>await Ce("/pipelines",{batch_import:!0,format:"csv",data:e}))(a);if(t.success){const a=t.data.created_count||0,s=a>0?(0,re.__)(`Successfully imported ${a} pipeline(s)!`,"datamachine"):(0,re.__)("Import completed!","datamachine");return n(null),r(""),setTimeout(()=>{e&&e()},1500),s}throw new Error(t.message||(0,re.__)("Failed to import pipelines","datamachine"))}):o.setError((0,re.__)("Please select a CSV file to import.","datamachine"))},disabled:o.isLoading||!a,isBusy:o.isLoading,children:o.isLoading?(0,re.__)("Importing...","datamachine"):(0,re.__)("Import Pipelines","datamachine")})]})]})}function Yt({onClose:e,pipelines:t=[],onSuccess:a}){const s=[{name:"export",title:(0,re.__)("Export","datamachine"),className:"datamachine-import-export-tab"},{name:"import",title:(0,re.__)("Import","datamachine"),className:"datamachine-import-export-tab"}],n=()=>{a&&a(),e()};return(0,l.jsx)(le.Modal,{title:(0,re.__)("Import / Export Pipelines","datamachine"),onRequestClose:e,className:"datamachine-import-export-modal",children:(0,l.jsx)("div",{className:"datamachine-modal-content",children:(0,l.jsx)(le.TabPanel,{className:"datamachine-import-export-tabs",activeClass:"is-active",tabs:s,children:a=>(0,l.jsxs)("div",{className:"datamachine-tab-content",children:["export"===a.name&&(0,l.jsx)(Vt,{pipelines:t,onClose:e}),"import"===a.name&&(0,l.jsx)(Jt,{onSuccess:n,onClose:e})]})})})})}function Xt({connected:e}){const t=e?{label:(0,re.__)("Connected","datamachine"),icon:""}:{label:(0,re.__)("Not Connected","datamachine"),icon:""},a=e?"datamachine-connection-status datamachine-connection-status--connected":"datamachine-connection-status datamachine-connection-status--disconnected",s=e?"datamachine-connection-status__icon datamachine-connection-status__icon--connected":"datamachine-connection-status__icon datamachine-connection-status__icon--disconnected",n=e?"datamachine-connection-status__label--connected":"datamachine-connection-status__label--disconnected";return(0,l.jsxs)("div",{className:a,children:[(0,l.jsx)("span",{className:s,children:t.icon}),(0,l.jsx)("span",{className:n,children:t.label})]})}function Zt({account:e}){if(!e||0===Object.keys(e).length)return null;const t=e.username||e.name||e.screen_name||null,a=e.email||null,s=e.id||e.user_id||null;return(0,l.jsxs)("div",{className:"datamachine-account-details-box",children:[(0,l.jsx)("h4",{className:"datamachine-account-details-title",children:(0,re.__)("Connected Account","datamachine")}),(0,l.jsxs)("div",{className:"datamachine-account-details-content",children:[t&&(0,l.jsxs)("div",{className:"datamachine-account-details-field",children:[(0,l.jsx)("strong",{children:(0,re.__)("Username:","datamachine")})," ",t]}),a&&(0,l.jsxs)("div",{className:"datamachine-account-details-field",children:[(0,l.jsx)("strong",{children:(0,re.__)("Email:","datamachine")})," ",a]}),s&&(0,l.jsxs)("div",{className:"datamachine-account-details-field",children:[(0,l.jsx)("strong",{children:(0,re.__)("Account ID:","datamachine")})," ",s]}),Object.entries(e).map(([e,t])=>["username","name","screen_name","email","id","user_id"].includes(e)||"object"==typeof t||"function"==typeof t?null:(0,l.jsxs)("div",{className:"datamachine-account-details-field",children:[(0,l.jsxs)("strong",{children:[e,":"]})," ",String(t)]},e))]})]})}function ea({config:e={},onChange:t,fields:a=[]}){const s=[{key:"api_key",label:(0,re.__)("API Key","datamachine"),type:"text",required:!0},{key:"api_secret",label:(0,re.__)("API Secret","datamachine"),type:"password",required:!0}],n=Array.isArray(a)?a:Object.entries(a).map(([e,t])=>({...t,key:e})),i=n.length>0?n:s;return(0,l.jsxs)("div",{className:"datamachine-api-config-form",children:[(0,l.jsx)("p",{className:"datamachine-api-config-description",children:(0,re.__)("Enter your API credentials:","datamachine")}),i.map(a=>(0,l.jsx)(le.TextControl,{label:a.label,type:a.type||"text",value:e[a.key]||"",onChange:s=>((a,s)=>{t&&t({...e,[a]:s})})(a.key,s),placeholder:a.placeholder||"",help:a.help||"",required:a.required||!1},a.key))]})}function ta({handlerSlug:e,onSuccess:t,onError:a,disabled:n=!1}){const i=(0,s.useRef)(null),r=(0,s.useRef)(null),[o,c]=(0,s.useState)(!1);return(0,s.useEffect)(()=>()=>{r.current&&window.removeEventListener("message",r.current),i.current&&!i.current.closed&&i.current.close()},[]),(0,l.jsx)(le.Button,{variant:"primary",onClick:async()=>{i.current&&!i.current.closed&&i.current.close(),c(!0);try{const t=await wp.apiFetch({path:`/datamachine/v1/auth/${e}/oauth-url`});if(!t?.success||!t?.data?.oauth_url)throw new Error(t?.message||(0,re.__)("Failed to get authorization URL.","datamachine"));const a=t.data.oauth_url,s=600,n=700,r=window.screen.width/2-s/2,l=window.screen.height/2-n/2;i.current=window.open(a,"oauth-window",`width=${s},height=${n},left=${r},top=${l},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`)}catch(e){return a&&a(e?.message||(0,re.__)("Failed to initiate OAuth flow.","datamachine")),void c(!1)}c(!1),r.current=e=>{[window.location.origin].includes(e.origin)&&e.data&&"oauth_callback"===e.data.type&&(i.current&&!i.current.closed&&i.current.close(),e.data.success?t&&t(e.data.account):a&&a(e.data.error||(0,re.__)("OAuth authentication failed","datamachine")),window.removeEventListener("message",r.current))},window.addEventListener("message",r.current),i.current&&!i.current.closed||a&&a((0,re.__)("Popup was blocked. Please allow popups for this site.","datamachine"))},disabled:n||o,isBusy:o,children:o?(0,re.__)("Connecting...","datamachine"):(0,re.__)("Connect Account","datamachine")})}function aa({url:e}){return e?(0,l.jsxs)("div",{className:"datamachine-redirect-url-display",children:[(0,l.jsx)("p",{className:"datamachine-redirect-url-label",children:(0,re.__)("Redirect URL (configure in your app settings):","datamachine")}),(0,l.jsx)("code",{className:"datamachine-redirect-url-value",children:e})]}):null}function sa({onClose:e,onBackToSettings:t,handlerSlug:a,handlerInfo:n={},onSuccess:i}){const[r,o]=(0,s.useState)(!!n?.is_authenticated),[c,d]=(0,s.useState)(n?.account_details||null),[u,h]=(0,s.useState)(null),[p,m]=(0,s.useState)(null),[f,y]=(0,s.useState)(!1),[g,_]=(0,s.useState)(!1),v=n.auth_type||"oauth2",b=(0,s.useCallback)(async({silent:e=!1}={})=>{if(!a)return null;y(!0);try{const t=await wp.apiFetch({path:`/datamachine/v1/auth/${a}/status`});if(!t?.success)throw new Error(t?.message||(0,re.__)("Unable to load connection status.","datamachine"));const s=t.data||{},n=!!s.authenticated;return o(n),d(s.account_details||null),s.config_status&&!x.isDirty&&x.reset(s.config_status),s.error?h(s.error_message||(0,re.__)("Authentication failed. Please try again.","datamachine")):e||h(null),s}catch(t){throw e||h(t?.message||(0,re.__)("Unable to load connection status.","datamachine")),t}finally{y(!1)}},[a]),x=Ct({initialData:{},onSubmit:async e=>{try{if(await wp.apiFetch({path:`/datamachine/v1/auth/${a}`,method:"PUT",data:e}),"simple"===v){o(!0),d({...e}),m((0,re.__)("Connected successfully!","datamachine"));try{await b({silent:!0})}catch(e){console.warn("Auth status refresh failed:",e)}i&&i()}else m((0,re.__)("Configuration saved! You can now connect your account.","datamachine"))}catch(e){throw new Error(e.message||(0,re.__)("Failed to save configuration.","datamachine"))}}}),w=St();(0,s.useEffect)(()=>{o(!!n?.is_authenticated),d(n?.account_details||null)},[a,n]),(0,s.useEffect)(()=>{let e=!0;return(async()=>{try{await b({silent:!0})}catch(t){e&&console.warn("Unable to refresh auth status:",t)}})(),()=>{e=!1}},[a,b]);const j=g||!r||"simple"===v;return(0,l.jsx)(le.Modal,{title:n.label?(0,re.sprintf)((0,re.__)("Connect %s Account","datamachine"),n.label):(0,re.__)("Connect Account","datamachine"),onRequestClose:e,className:"datamachine-oauth-modal",children:(0,l.jsxs)("div",{className:"datamachine-modal-content",children:[(u||x.error||w.error)&&(0,l.jsx)("div",{className:"datamachine-modal-error notice notice-error",children:(0,l.jsx)("p",{children:u||x.error||w.error})}),(p||x.success||w.success)&&(0,l.jsx)(le.Notice,{status:"success",isDismissible:!0,onRemove:()=>{m(null),x.setSuccess(null),w.reset()},children:(0,l.jsx)("p",{children:p||x.success||w.success})}),(0,l.jsxs)("div",{className:"datamachine-modal-spacing--mb-20",children:[(0,l.jsxs)("div",{className:"datamachine-modal-header-section",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:(0,re.__)("Handler:","datamachine")})," ",n.label||a]}),(0,l.jsx)(Xt,{connected:r})]}),f&&(0,l.jsx)("p",{className:"description",children:(0,re.__)("Checking current connection status...","datamachine")}),(0,l.jsx)("p",{className:"datamachine-modal-text--info",children:"oauth2"===v?(0,re.__)('Click "Connect Account" to authorize access via OAuth.',"datamachine"):(0,re.__)("Enter your API credentials to connect.","datamachine")})]}),j&&(0,l.jsxs)(l.Fragment,{children:[("oauth2"===v||"oauth1"===v)&&n.callback_url&&(0,l.jsx)(aa,{url:n.callback_url}),n.auth_fields&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(ea,{config:x.data,onChange:x.updateData,fields:n.auth_fields}),(0,l.jsxs)("div",{className:"datamachine-modal-spacing--mt-16",children:[(0,l.jsx)(le.Button,{variant:"simple"===v?"primary":"secondary",onClick:()=>{x.submit()},disabled:x.isSubmitting,isBusy:x.isSubmitting,children:x.isSubmitting?(0,re.__)("Saving...","datamachine"):"simple"===v?(0,re.__)("Save Credentials","datamachine"):(0,re.__)("Save Configuration","datamachine")}),r&&(0,l.jsx)(le.Button,{variant:"link",onClick:()=>_(!1),className:"datamachine-modal-spacing--ml-10",children:(0,re.__)("Cancel","datamachine")})]}),"oauth2"===v&&(0,l.jsx)("div",{className:"datamachine-modal-spacing--mb-16 datamachine-modal-spacing--mt-16",children:(0,l.jsx)("hr",{})})]}),"oauth2"===v&&!r&&(0,l.jsx)("div",{className:"datamachine-modal-spacing--mb-16",children:(0,l.jsx)(ta,{handlerSlug:a,onSuccess:e=>{o(!0),e&&d(e),m((0,re.__)("Account connected successfully!","datamachine")),h(null),b({silent:!0}).catch(()=>{}),i&&i()},onError:e=>{h(e),m(null)},disabled:x.isSubmitting||w.isLoading||f})})]}),r&&!g&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(Zt,{account:c}),(0,l.jsxs)("div",{className:"datamachine-modal-spacing--mt-16",style:{display:"flex",gap:"10px"},children:[(0,l.jsx)(le.Button,{variant:"secondary",onClick:()=>{confirm((0,re.__)("Are you sure you want to disconnect this account? This will remove the access token but keep your API configuration.","datamachine"))&&w.execute(async()=>{const e=await wp.apiFetch({path:`/datamachine/v1/auth/${a}`,method:"DELETE"});if(!e?.success)throw new Error(e?.message||(0,re.__)("Failed to disconnect account.","datamachine"));o(!1),d(null),m(null),_(!0);try{await b({silent:!0})}catch(e){console.warn("Auth status refresh failed:",e)}return i&&i(),(0,re.__)("Account disconnected successfully!","datamachine")})},disabled:w.isLoading,isBusy:w.isLoading,className:"datamachine-button--destructive",children:w.isLoading?(0,re.__)("Disconnecting...","datamachine"):(0,re.__)("Disconnect Account","datamachine")}),("oauth2"===v||"oauth1"===v)&&(0,l.jsx)(le.Button,{variant:"secondary",onClick:()=>_(!0),children:(0,re.__)("Change API Configuration","datamachine")})]})]}),(0,l.jsxs)("div",{className:"datamachine-modal-actions",children:[t&&(0,l.jsx)(le.Button,{variant:"secondary",onClick:t,disabled:x.isSubmitting||w.isLoading,children:(0,re.__)("Back to Settings","datamachine")}),(0,l.jsx)(le.Button,{variant:"secondary",onClick:e,disabled:x.isSubmitting||w.isLoading,children:(0,re.__)("Close","datamachine")})]})]})})}function na({files:e=[],onDelete:t,isDeleting:a=!1}){const[n,i]=(0,s.useState)(null),r=e=>{const t=new Date(e);return t.toLocaleDateString()+" "+t.toLocaleTimeString()};return 0===e.length?(0,l.jsx)("div",{className:"datamachine-modal-empty-state datamachine-modal-empty-state--bordered",children:(0,l.jsx)("p",{className:"datamachine-text--margin-reset",children:(0,re.__)("No context files uploaded yet.","datamachine")})}):(0,l.jsx)("div",{className:"datamachine-table-container",children:(0,l.jsxs)("table",{className:"datamachine-pipeline-table",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{className:"datamachine-table-sticky-header",children:[(0,l.jsx)("th",{children:(0,re.__)("File Name","datamachine")}),(0,l.jsx)("th",{className:"datamachine-table-col--date",children:(0,re.__)("Uploaded","datamachine")}),(0,l.jsx)("th",{className:"datamachine-table-cell--center datamachine-table-col--compact",children:(0,re.__)("Actions","datamachine")})]})}),(0,l.jsx)("tbody",{children:e.map(e=>{const s=n===e.file_id;return(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{className:"datamachine-table-cell--medium",children:e.file_name}),(0,l.jsx)("td",{className:"datamachine-table-cell--muted datamachine-table-cell--small",children:r(e.uploaded_at)}),(0,l.jsx)("td",{className:"datamachine-table-cell--center",children:(0,l.jsx)(le.Button,{variant:"link",onClick:()=>(async e=>{i(e),t&&await t(e),i(null)})(e.file_id),disabled:a||s,isBusy:s,className:"datamachine-table-text-error",children:s?(0,re.__)("Deleting...","datamachine"):(0,re.__)("Delete","datamachine")})})]},e.file_id)})})]})})}function ia({pipelineId:e}){const[t,a]=(0,s.useState)([]),[n,i]=(0,s.useState)(!0),[r,o]=(0,s.useState)(!1),[c,d]=(0,s.useState)(!1),[u,h]=(0,s.useState)(null),[p,m]=(0,s.useState)(null),f=async()=>{i(!0),h(null);try{const t=await(async e=>await je("/files",{pipeline_id:e}))(e);t.success?a(t.data||[]):h(t.message||(0,re.__)("Failed to load context files","datamachine"))}catch(e){console.error("Load files error:",e),h(e.message||(0,re.__)("An error occurred while loading files","datamachine"))}finally{i(!1)}};return(0,s.useEffect)(()=>{e&&f()},[e]),(0,l.jsxs)("div",{className:"datamachine-pipeline-context-files",children:[(0,l.jsxs)("div",{className:"datamachine-context-files-wrapper",children:[(0,l.jsx)("h3",{style:{margin:"0 0 8px 0",fontSize:"16px",fontWeight:"600"},children:(0,re.__)("Context Files","datamachine")}),(0,l.jsx)("p",{className:"datamachine-context-files-helper",children:(0,re.__)("Upload files for AI context retrieval during pipeline execution.","datamachine")})]}),u&&(0,l.jsx)(le.Notice,{status:"error",isDismissible:!0,onRemove:()=>h(null),children:(0,l.jsx)("p",{children:u})}),p&&(0,l.jsx)(le.Notice,{status:"success",isDismissible:!0,onRemove:()=>m(null),children:(0,l.jsx)("p",{children:p})}),(0,l.jsx)("div",{className:"datamachine-context-files-section",children:(0,l.jsx)(Ft,{onFileSelected:async t=>{o(!0),h(null),m(null);try{const a=await(async(e,t)=>await(async(e,t,a={})=>{const s=new FormData;return s.append("file",t),Object.keys(a).forEach(e=>s.append(e,a[e])),we(e,"POST",void 0,{},{body:s})})("/files",t,{pipeline_id:e}))(e,t);a.success?(m((0,re.__)("File uploaded successfully!","datamachine")),await f()):h(a.message||(0,re.__)("Failed to upload file","datamachine"))}catch(e){console.error("Upload error:",e),h(e.message||(0,re.__)("An error occurred during upload","datamachine"))}finally{o(!1)}},allowedTypes:["pdf","csv","txt","json"],maxSizeMB:Math.round((window.dataMachineConfig?.maxUploadSize||10485760)/1048576),disabled:r||n,uploadText:r?(0,re.__)("Uploading...","datamachine"):null})}),n?(0,l.jsx)("div",{style:{textAlign:"center",padding:"20px",color:"#757575"},children:(0,re.__)("Loading files...","datamachine")}):(0,l.jsx)(na,{files:t,onDelete:async e=>{d(!0),h(null),m(null);try{const t=await(async e=>await Ie(`/files/${e}`))(e);t.success?(m((0,re.__)("File deleted successfully!","datamachine")),await f()):h(t.message||(0,re.__)("Failed to delete file","datamachine"))}catch(e){console.error("Delete error:",e),h(e.message||(0,re.__)("An error occurred during deletion","datamachine"))}finally{d(!1)}},isDeleting:c})]})}function ra({onClose:e,pipelineId:t}){return(0,l.jsx)(le.Modal,{title:(0,re.__)("Pipeline Context Files","datamachine"),onRequestClose:e,className:"datamachine-context-files-modal",children:(0,l.jsx)("div",{className:"datamachine-modal-content",children:(0,l.jsx)(ia,{pipelineId:t})})})}function la({activeModal:e,baseProps:t}){if(!e)return null;switch(e){case tt:return(0,l.jsx)(Yt,{...t});case Je:return(0,l.jsx)(Nt,{...t});case Xe:return(0,l.jsx)(kt,{...t});case et:return(0,l.jsx)(Et,{...t});case Ye:return(0,l.jsx)(Kt,{...t,handlers:t.handlers});case Ze:return(0,l.jsx)($t,{...t,handlerDetails:t.handlerDetails,onChangeHandler:t.onChangeHandler,onOAuthConnect:t.onOAuthConnect});case at:return(0,l.jsx)(sa,{...t});case st:return(0,l.jsx)(ra,{...t});default:return console.warn(`Unknown modal type: ${e}`),null}}function oa({pipelines:e,handlers:t,handlerDetails:a,pipelineConfig:s,flows:n,onModalSuccess:i,onHandlerSelected:r,onChangeHandler:o,onOAuthConnect:c,onBackToSettings:d}){var u;const{activeModal:h,modalData:p,closeModal:m}=$e();if(!h)return null;const f={onClose:m,...p,onSuccess:i,handlers:t,handlerDetails:null!==(u=p.handlerDetails)&&void 0!==u?u:a,onChangeHandler:o,onOAuthConnect:c,onBackToSettings:d,onSelectHandler:r};return(0,l.jsx)(Bt,{children:(0,l.jsx)(la,{activeModal:h,baseProps:f,modalData:p})})}const ca=window.wp.primitives;var da=(0,l.jsx)(ca.SVG,{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,l.jsx)(ca.Path,{d:"M18 4H6c-1.1 0-2 .9-2 2v12.9c0 .6.5 1.1 1.1 1.1.3 0 .5-.1.8-.3L8.5 17H18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm.5 11c0 .3-.2.5-.5.5H7.9l-2.4 2.4V6c0-.3.2-.5.5-.5h12c.3 0 .5.2.5.5v9z"})});function ua(){const{isChatOpen:e,toggleChat:t}=$e();return(0,l.jsx)(le.Button,{icon:da,onClick:t,label:e?(0,re.__)("Close chat","data-machine"):(0,re.__)("Open chat","data-machine"),className:"datamachine-chat-toggle "+(e?"is-active":""),isPressed:e})}var ha=(0,l.jsx)(ca.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,l.jsx)(ca.Path,{d:"m13.06 12 6.47-6.47-1.06-1.06L12 10.94 5.53 4.47 4.47 5.53 10.94 12l-6.47 6.47 1.06 1.06L12 13.06l6.47 6.47 1.06-1.06L13.06 12Z"})});const pa=["create_pipeline","add_pipeline_step","configure_pipeline_step"],ma=["create_pipeline","create_flow","update_flow","copy_flow","add_pipeline_step","configure_flow_steps"],fa=["authenticate_handler"];function ya({message:e}){const{role:t,content:a,tool_calls:s}=e,n="assistant"===t;if("user"!==t&&!n)return null;const i=s?.map(e=>e.function?.name||e.name).filter(Boolean)||[];return(0,l.jsxs)("div",{className:`datamachine-chat-message datamachine-chat-message--${t}`,children:[(0,l.jsx)("div",{className:"datamachine-chat-message__content",children:a}),n&&i.length>0&&(0,l.jsxs)("div",{className:"datamachine-chat-message__tools",children:[(0,re.__)("Used:","data-machine")," ",i.join(", ")]})]})}function ga({messages:e,isLoading:t}){const a=(0,s.useRef)(null);(0,s.useEffect)(()=>{a.current&&(a.current.scrollTop=a.current.scrollHeight)},[e,t]);const n=e.filter(e=>"user"===e.role||"assistant"===e.role);return(0,l.jsxs)("div",{className:"datamachine-chat-messages",ref:a,children:[0===n.length&&!t&&(0,l.jsx)("div",{className:"datamachine-chat-messages__empty",children:(0,re.__)("Ask me to create a pipeline, configure a flow, or help with your automations.","data-machine")}),n.map((e,t)=>(0,l.jsx)(ya,{message:e},t)),t&&(0,l.jsxs)("div",{className:"datamachine-chat-messages__typing",children:[(0,l.jsx)("span",{className:"datamachine-typing-dot"}),(0,l.jsx)("span",{className:"datamachine-typing-dot"}),(0,l.jsx)("span",{className:"datamachine-typing-dot"})]})]})}var _a=(0,l.jsx)(ca.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,l.jsx)(ca.Path,{d:"M12 3.9 6.5 9.5l1 1 3.8-3.7V20h1.5V6.8l3.7 3.7 1-1z"})});function va({onSend:e,disabled:t}){const[a,n]=(0,s.useState)(""),i=(0,s.useCallback)(()=>{const s=a.trim();s&&!t&&(e(s),n(""))},[a,t,e]),r=(0,s.useCallback)(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),i())},[i]);return(0,l.jsxs)("div",{className:"datamachine-chat-input",children:[(0,l.jsx)("textarea",{className:"datamachine-chat-input__textarea",value:a,onChange:e=>n(e.target.value),onKeyDown:r,placeholder:(0,re.__)("Ask me to build something...","data-machine"),disabled:t,rows:2}),(0,l.jsx)(le.Button,{icon:_a,onClick:i,disabled:t||!a.trim(),label:(0,re.__)("Send message","data-machine"),className:"datamachine-chat-input__send",variant:"primary"})]})}function ba(){const{toggleChat:e,chatSessionId:t,setChatSessionId:a,clearChatSession:n,selectedPipelineId:i}=$e(),[r,o]=(0,s.useState)([]),d=_e({mutationFn:async({message:e,sessionId:t,selectedPipelineId:a})=>{const s=await be()({path:"/datamachine/v1/chat",method:"POST",data:{message:e,session_id:t||void 0,selected_pipeline_id:a||void 0}});if(!s.success)throw new Error(s.message||"Chat request failed");return s.data}}),u=ye({queryKey:["chat-session",h=t],queryFn:async()=>{const e=await be()({path:`/datamachine/v1/chat/${h}`,method:"GET"});if(!e.success)throw new Error(e.message||"Failed to fetch session");return e.data},enabled:!!h,staleTime:1/0,retry:!1});var h;const{invalidateFromToolCalls:p}=function(){const e=c();return{invalidateFromToolCalls:(0,s.useCallback)((t,a)=>{if(!t?.length)return;let s=!1,n=!1;const i=new Set;for(const e of t){const t=e.name,r=e.parameters||{};if(pa.includes(t)&&(s=!0),ma.includes(t)){const e=r.pipeline_id||r.target_pipeline_id;e?i.add(Pe(e)):a&&i.add(Pe(a))}fa.includes(t)&&(n=!0)}s&&e.invalidateQueries({queryKey:["pipelines"]});for(const t of i)e.invalidateQueries({queryKey:["flows",t]});n&&e.invalidateQueries({queryKey:["handlers"]})},[e])}}();(0,s.useEffect)(()=>{u.data?.conversation&&o(u.data.conversation)},[u.data]),(0,s.useEffect)(()=>{u.error?.message?.includes("not found")&&(n(),o([]))},[u.error,n]);const m=(0,s.useCallback)(async e=>{const s={role:"user",content:e};o(e=>[...e,s]);try{const s=await d.mutateAsync({message:e,sessionId:t,selectedPipelineId:i});s.session_id&&s.session_id!==t&&a(s.session_id),s.conversation&&o(s.conversation),p(s.tool_calls,i)}catch(e){const t={role:"assistant",content:e.message||(0,re.__)("Something went wrong. Check the logs for details.","data-machine")};o(e=>[...e,t]),e.message?.includes("not found")&&n()}},[t,a,n,d,i,p]),f=(0,s.useCallback)(()=>{n(),o([])},[n]),y=d.isPending||u.isLoading;return(0,l.jsxs)("aside",{className:"datamachine-chat-sidebar",children:[(0,l.jsxs)("header",{className:"datamachine-chat-sidebar__header",children:[(0,l.jsx)("h2",{className:"datamachine-chat-sidebar__title",children:(0,re.__)("Chat","data-machine")}),(0,l.jsx)(le.Button,{icon:ha,onClick:e,label:(0,re.__)("Close chat","data-machine"),className:"datamachine-chat-sidebar__close"})]}),(0,l.jsx)("div",{className:"datamachine-chat-sidebar__actions",children:(0,l.jsx)(le.Button,{variant:"tertiary",onClick:f,className:"datamachine-chat-sidebar__new",disabled:y,children:(0,re.__)("New conversation","data-machine")})}),(0,l.jsx)(ga,{messages:r,isLoading:y}),(0,l.jsx)(va,{onSend:m,disabled:y})]})}function xa(){const{selectedPipelineId:e,setSelectedPipelineId:t,openModal:a,closeModal:n,activeModal:i,modalData:r,isChatOpen:o}=$e(),d=$e.persist.hasHydrated(),{data:u=[],isLoading:h,error:p}=Te(),{data:m=[],isLoading:f,error:y}=(e=>{const t=Pe(e);return ye({queryKey:["flows",t],queryFn:async()=>{const t=await(async e=>await je("/flows",{pipeline_id:e}))(e);return t.success?t.data.flows:[]},enabled:!!t})})(e),{data:g={}}=Qe(),_=i!==Ze||r?.handlerDetails?null:r?.handlerSlug,{data:v}=Le(_),b=((e={})=>{const t=c();return _e({mutationFn:Oe,onMutate:async e=>{await t.cancelQueries({queryKey:["pipelines"]});const a=t.getQueryData(["pipelines"]),s=`optimistic_${Date.now()}`;return t.setQueryData(["pipelines"],(t=[])=>[{pipeline_id:s,pipeline_name:e,pipeline_config:{}},...t]),{previousPipelines:a,optimisticPipelineId:s}},onError:(e,a,s)=>{s?.previousPipelines&&t.setQueryData(["pipelines"],s.previousPipelines)},onSuccess:(a,s,n)=>{const i=a?.data?.pipeline_data,r=a?.data?.pipeline_id;i&&n?.optimisticPipelineId&&t.setQueryData(["pipelines"],(e=[])=>e.map(e=>Ae(e.pipeline_id,n.optimisticPipelineId)?i:e)),t.invalidateQueries({queryKey:["pipelines"]}),e.onSuccess&&r&&e.onSuccess(r)}})})({onSuccess:e=>{t(e)}}),x=Me(),w=u?.find(t=>Ae(t.pipeline_id,e)),[j,C]=(0,s.useState)(!1),S=(0,s.useCallback)(()=>{n()},[n]),N=(0,s.useCallback)(async e=>{const t=await x.mutateAsync({flowStepId:r.flowStepId,handlerSlug:e,settings:{},pipelineId:r.pipelineId,stepType:r.stepType});if(!t||!t.success)throw new Error(t?.message||"Failed to assign handler to this flow step.");a(Ze,{...r,handlerSlug:e,currentSettings:t?.data?.step_config?.handler_config||{}})},[a,r,x]),I=(0,s.useCallback)(()=>{a(Ye,r)},[a,r]),O=(0,s.useCallback)((e,t)=>{a(at,{...r,handlerSlug:e,handlerInfo:t})},[a,r]),D=(0,s.useCallback)(()=>{a(Ze,r)},[a,r]);(0,s.useEffect)(()=>{d&&!h&&(u.length>0&&!e?t(u[0].pipeline_id):u.length>0&&e?u.some(t=>Ae(t.pipeline_id,e))||t(u[0].pipeline_id):0===u.length&&t(null))},[u,e,t,d,h]);const k=(0,s.useCallback)(async()=>{C(!0);try{await b.mutateAsync("New Pipeline")}catch(e){console.error("Error creating pipeline:",e)}finally{C(!1)}},[b]),E=w||u[0];return(0,l.jsxs)("div",{className:"datamachine-pipelines-layout",children:[(0,l.jsxs)("div",{className:"datamachine-pipelines-main",children:[(0,l.jsxs)("div",{className:"datamachine-header--flex-space-between",children:[(0,l.jsx)(le.Button,{variant:"primary",onClick:k,disabled:j,isBusy:j,children:(0,re.__)("Add New Pipeline","datamachine")}),(0,l.jsxs)("div",{className:"datamachine-header__right",children:[(0,l.jsx)(le.Button,{variant:"secondary",onClick:()=>a(tt),children:(0,re.__)("Import / Export","datamachine")}),(0,l.jsx)(ua,{})]})]}),h||f?(0,l.jsxs)("div",{className:"datamachine-pipelines-loading",children:[(0,l.jsx)(le.Spinner,{}),(0,l.jsx)("p",{children:(0,re.__)("Loading pipelines...","datamachine")})]}):p||y?(0,l.jsx)(le.Notice,{status:"error",isDismissible:!1,children:(0,l.jsx)("p",{children:p||y})}):0===u.length?(0,l.jsxs)("div",{className:"datamachine-empty-state",children:[(0,l.jsx)(le.Notice,{status:"info",isDismissible:!1,children:(0,l.jsx)("p",{children:(0,re.__)("No pipelines found. Create your first pipeline to get started, or ask the chat to help you build one.","datamachine")})}),(0,l.jsx)("div",{className:"datamachine-empty-state-actions",children:(0,l.jsx)(le.Button,{variant:"primary",onClick:k,disabled:j,isBusy:j,children:(0,re.__)("Create First Pipeline","datamachine")})})]}):!w&&e?(0,l.jsxs)("div",{className:"datamachine-pipelines-loading",children:[(0,l.jsx)(le.Spinner,{}),(0,l.jsx)("p",{children:(0,re.__)("Loading pipeline details...","datamachine")})]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(wt,{}),(0,l.jsx)(xt,{pipeline:E,flows:m}),(0,l.jsx)(oa,{pipelines:u,handlers:g,handlerDetails:v,pipelineConfig:w?.pipeline_config||{},flows:m,onModalSuccess:S,onHandlerSelected:N,onChangeHandler:I,onOAuthConnect:O,onBackToSettings:D})]})]}),o&&(0,l.jsx)(ba,{})]})}i()(()=>{const e=document.getElementById("datamachine-react-root");e?window.dataMachineConfig?(0,s.render)((0,l.jsxs)(d,{client:ie,children:[(0,l.jsx)(Bt,{children:(0,l.jsx)(xa,{})}),(0,l.jsx)(u,{initialIsOpen:!1})]}),e):console.error("Data Machine: Configuration not found"):console.error("Data Machine: React root element not found")})})();