(()=>{"use strict";var e={n:n=>{var t=n&&n.__esModule?()=>n.default:()=>n;return e.d(t,{a:t}),t},d:(n,t)=>{for(var a in t)e.o(t,a)&&!e.o(n,a)&&Object.defineProperty(n,a,{enumerable:!0,get:t[a]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)};const n=window.wp.element,t=window.wp.domReady;var a=e.n(t);const i=window.ReactJSXRuntime,l=(0,n.createContext)();function s({children:e}){const[t,a]=(0,n.useState)(null),[s,o]=(0,n.useState)([]),[r,d]=(0,n.useState)([]),[c,p]=(0,n.useState)(0),[h,u]=(0,n.useState)(null),[m,x]=(0,n.useState)(null);(0,n.useEffect)(()=>{t&&localStorage.setItem("datamachine_selected_pipeline",t)},[t]),(0,n.useEffect)(()=>{const e=localStorage.getItem("datamachine_selected_pipeline");e&&!t&&a(e)},[]),(0,n.useEffect)(()=>{const e=new URL(window.location).searchParams.get("selected_pipeline_id");e&&a(e)},[]),(0,n.useEffect)(()=>{if(t){const e=new URL(window.location);e.searchParams.set("selected_pipeline_id",t),window.history.replaceState(null,null,e)}},[t]);const f=(0,n.useCallback)(()=>{p(e=>e+1)},[]),g=(0,n.useCallback)((e,n=null)=>{u(e),x(n)},[]),_=(0,n.useCallback)(()=>{u(null),x(null)},[]),y={selectedPipelineId:t,setSelectedPipelineId:a,pipelines:s,setPipelines:o,flows:r,setFlows:d,refreshData:f,refreshTrigger:c,activeModal:h,modalData:m,openModal:g,closeModal:_};return(0,i.jsx)(l.Provider,{value:y,children:e})}function o(){const e=(0,n.useContext)(l);if(!e)throw new Error("usePipelineContext must be used within PipelineProvider");return e}const r=window.wp.i18n,d=window.wp.components,c=window.wp.apiFetch;var p=e.n(c);const h=()=>{const e=window.dataMachineConfig||{};return{restNamespace:e.restNamespace||"datamachine/v1",restNonce:e.restNonce||""}},u=async(e,n={})=>{const t=h();try{const a=await p()({path:`/${t.restNamespace}${e}`,method:n.method||"GET",data:n.data||void 0,headers:{"X-WP-Nonce":t.restNonce}});return{success:!0,data:a,message:a.message||""}}catch(e){return console.error("API Request Error:",e),{success:!1,data:null,message:e.message||"An error occurred"}}},m=async(e,n,t,a,i,l=[])=>await u(`/pipelines/${e}/steps/${n}/config`,{method:"PUT",data:{ai_provider:a,ai_model:i,system_prompt:t,enabled_tools:l}}),x=(e=null)=>{const[t,a]=(0,n.useState)([]),[i,l]=(0,n.useState)(!0),[s,o]=(0,n.useState)(null),[r,d]=(0,n.useState)(0),c=(0,n.useCallback)(async()=>{l(!0),o(null);try{const n=await(async(e=null)=>{const n=e?`/pipelines/${e}`:"/pipelines";return await u(n)})(e);if(n.success){const e=Array.isArray(n.data)?n.data:[n.data];a(e)}else o(n.message||"Failed to fetch pipelines")}catch(e){console.error("usePipelines error:",e),o(e.message||"An error occurred")}finally{l(!1)}},[e,r]),p=(0,n.useCallback)(()=>{d(e=>e+1)},[]);return(0,n.useEffect)(()=>{c()},[c]),{pipelines:t,loading:i,error:s,refetch:p}},f=[{value:"manual",label:"Manual only"},{value:"hourly",label:"Every hour"},{value:"twicedaily",label:"Twice daily"},{value:"daily",label:"Daily"},{value:"weekly",label:"Weekly"}],g="step-selection",_="handler-selection",y="configure-step",j="handler-settings",b="flow-schedule",w="import-export",v="oauth",C=500;function S({pipelineId:e,pipelineName:t,onNameChange:a,onDelete:l}){const[s,o]=(0,n.useState)(t),c=(0,n.useRef)(null);(0,n.useEffect)(()=>{o(t)},[t]);const p=(0,n.useCallback)(async n=>{if(n&&n!==t)try{const t=await(async(e,n)=>await u(`/pipelines/${e}`,{method:"PATCH",data:{pipeline_name:n}}))(e,n);t.success&&a&&a(n)}catch(e){console.error("Pipeline title save failed:",e)}},[e,t,a]),h=(0,n.useCallback)(e=>{o(e),c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{p(e)},C)},[p]),m=(0,n.useCallback)(async()=>{if(window.confirm((0,r.__)("Are you sure you want to delete this pipeline? This action cannot be undone.","datamachine")))try{const n=await(async e=>await u(`/pipelines/${e}`,{method:"DELETE"}))(e);n.success&&l&&l(e)}catch(e){console.error("Pipeline deletion error:",e)}},[e,l]);return(0,n.useEffect)(()=>()=>{c.current&&clearTimeout(c.current)},[]),(0,i.jsx)("div",{className:"datamachine-pipeline-header",children:(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[(0,i.jsx)("div",{style:{flex:1},children:(0,i.jsx)(d.TextControl,{value:s,onChange:h,placeholder:(0,r.__)("Pipeline name","datamachine"),className:"datamachine-pipeline-name-input",style:{fontSize:"20px",fontWeight:"600"}})}),(0,i.jsx)(d.Button,{isDestructive:!0,variant:"secondary",onClick:m,icon:"trash",label:(0,r.__)("Delete Pipeline","datamachine")})]})})}const k=e=>{if(!e||"0000-00-00 00:00:00"===e)return(0,r.__)("Never","datamachine");try{const n=new Date(e),t=new Date-n,a=Math.floor(t/6e4),i=Math.floor(t/36e5),l=Math.floor(t/864e5);return a<1?(0,r.__)("Just now","datamachine"):a<60?`${a} ${(0,r.__)("minutes ago","datamachine")}`:i<24?`${i} ${(0,r.__)("hours ago","datamachine")}`:l<7?`${l} ${(0,r.__)("days ago","datamachine")}`:n.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(n){return console.error("Date formatting error:",n),e}},T=e=>e?e.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "):"",N=e=>({fetch:{icon:"â­³",color:"#0073aa",label:(0,r.__)("Fetch","datamachine")},ai:{icon:"âœ¨",color:"#826eb4",label:(0,r.__)("AI Process","datamachine")},publish:{icon:"âœ”",color:"#46b450",label:(0,r.__)("Publish","datamachine")},update:{icon:"â™»",color:"#f0b849",label:(0,r.__)("Update","datamachine")}}[e]||{icon:"â€¢",color:"#999",label:T(e)});function B({stepType:e,size:n=24}){const t=N(e);return(0,i.jsx)("span",{className:`datamachine-step-icon datamachine-step-icon--${e}`,style:{fontSize:`${n}px`,color:t.color,lineHeight:1,display:"inline-block"},title:t.label,"aria-label":t.label,children:t.icon})}function A({step:e,pipelineId:t,pipelineConfig:a,onDelete:l,onConfigure:s}){const o="ai"===e.step_type?a[e.pipeline_step_id]:null,[c,p]=(0,n.useState)(o?.system_prompt||""),[h,u]=(0,n.useState)(!1),[x,f]=(0,n.useState)(null),g=(0,n.useRef)(null);(0,n.useEffect)(()=>{o&&p(o.system_prompt||"")},[o]);const _=(0,n.useCallback)(async n=>{if(!o)return;const a=o.system_prompt||"";if(n!==a){u(!0),f(null);try{const i=await m(t,e.pipeline_step_id,n,o.ai_provider,o.ai_model);i.success||(f(i.message||(0,r.__)("Failed to update prompt","datamachine")),p(a))}catch(e){console.error("Prompt update error:",e),f(e.message||(0,r.__)("An error occurred","datamachine")),p(a)}finally{u(!1)}}},[t,e.pipeline_step_id,o]),y=(0,n.useCallback)(e=>{p(e),g.current&&clearTimeout(g.current),g.current=setTimeout(()=>{_(e)},C)},[_]),j=(0,n.useCallback)(()=>{window.confirm((0,r.__)("Are you sure you want to remove this step?","datamachine"))&&l&&l(e.pipeline_step_id)},[e.pipeline_step_id,l]);return(0,n.useEffect)(()=>()=>{g.current&&clearTimeout(g.current)},[]),(0,i.jsx)(d.Card,{className:`datamachine-pipeline-step-card datamachine-step-type--${e.step_type}`,size:"small",children:(0,i.jsxs)(d.CardBody,{children:[x&&(0,i.jsx)(d.Notice,{status:"error",isDismissible:!0,onRemove:()=>f(null),children:x}),(0,i.jsxs)("div",{style:{marginBottom:"12px"},children:[(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"},children:[(0,i.jsx)(B,{stepType:e.step_type,size:20}),(0,i.jsx)("strong",{children:e.label||T(e.step_type)}),(0,i.jsxs)("span",{style:{color:"#757575",fontSize:"12px"},children:["(Order: ",e.execution_order,")"]})]}),o&&(0,i.jsxs)("div",{className:"datamachine-ai-config-display",style:{marginTop:"12px"},children:[(0,i.jsxs)("div",{style:{fontSize:"12px",color:"#757575",marginBottom:"8px"},children:[(0,i.jsx)("strong",{children:(0,r.__)("AI Provider:","datamachine")})," ",o.ai_provider||"Not configured"," | ",(0,i.jsx)("strong",{children:(0,r.__)("Model:","datamachine")})," ",o.ai_model||"Not configured"]}),(0,i.jsx)(d.TextareaControl,{label:(0,r.__)("System Prompt","datamachine"),value:c,onChange:y,placeholder:(0,r.__)("Enter system prompt for AI processing...","datamachine"),rows:6,help:h?(0,r.__)("Saving...","datamachine"):null})]})]}),(0,i.jsxs)("div",{style:{display:"flex",gap:"8px",justifyContent:"flex-end"},children:[(0,i.jsx)(d.Button,{variant:"secondary",size:"small",onClick:()=>s&&s(e),children:(0,r.__)("Configure","datamachine")}),(0,i.jsx)(d.Button,{variant:"secondary",size:"small",isDestructive:!0,onClick:j,children:(0,r.__)("Delete","datamachine")})]})]})})}function I({pipelineId:e,onAddStep:n}){return(0,i.jsxs)("div",{className:"datamachine-empty-step-card",style:{border:"2px dashed #dcdcde",borderRadius:"4px",padding:"40px 20px",textAlign:"center",backgroundColor:"#f9f9f9",minWidth:"200px"},children:[(0,i.jsx)("div",{style:{fontSize:"48px",color:"#c3c4c7",marginBottom:"16px"},children:"+"}),(0,i.jsx)(d.Button,{variant:"secondary",onClick:()=>n&&n(e),children:(0,r.__)("Add Step","datamachine")})]})}function D(){return(0,i.jsx)("div",{className:"datamachine-data-flow-arrow",style:{display:"flex",alignItems:"center",padding:"0 10px"},children:(0,i.jsx)("svg",{width:"40",height:"20",viewBox:"0 0 40 20",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:(0,i.jsx)("path",{d:"M0 10 L30 10 L25 5 M30 10 L25 15",stroke:"#8c8f94",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})}function z({pipelineId:e,steps:t,pipelineConfig:a,onStepAdded:l,onStepRemoved:s,onStepConfigured:o}){const d=(0,n.useMemo)(()=>t&&Array.isArray(t)?[...t].sort((e,n)=>(e.execution_order||0)-(n.execution_order||0)):[],[t]),[c,p]=(0,n.useState)(null);return 0===d.length?(0,i.jsxs)("div",{className:"datamachine-pipeline-steps-empty",style:{padding:"20px",textAlign:"center"},children:[(0,i.jsx)("p",{style:{color:"#757575",marginBottom:"16px"},children:(0,r.__)("No steps configured. Add your first step to get started.","datamachine")}),(0,i.jsx)(I,{pipelineId:e,onAddStep:l})]}):(0,i.jsxs)("div",{className:"datamachine-pipeline-steps",style:{display:"flex",alignItems:"stretch",gap:"0",overflowX:"auto",padding:"20px 0"},children:[d.map((n,t)=>(0,i.jsxs)("div",{style:{display:"flex",alignItems:"stretch"},draggable:!0,onDragStart:()=>p(t),onDragOver:e=>e.preventDefault(),onDrop:()=>(async n=>{if(null===c||c===n)return void p(null);const t=[...d],[a]=t.splice(c,1);t.splice(n,0,a);try{await(async(e,n)=>{const t=n.map((e,n)=>({pipeline_step_id:e.pipeline_step_id,execution_order:n}));return await u(`/pipelines/${e}/steps/reorder`,{method:"PUT",data:{step_order:t}})})(e,t)}catch(e){console.error("Failed to reorder steps:",e)}p(null)})(t),className:c===t?"datamachine-step-dragging":"",children:[(0,i.jsx)("div",{style:{flex:"0 0 auto",minWidth:"300px"},children:(0,i.jsx)(A,{step:n,pipelineId:e,pipelineConfig:a,onDelete:s,onConfigure:o})}),t<d.length-1&&(0,i.jsx)(D,{})]},n.pipeline_step_id)),(0,i.jsx)(D,{}),(0,i.jsx)("div",{style:{flex:"0 0 auto"},children:(0,i.jsx)(I,{pipelineId:e,onAddStep:l})})]})}function P({onFileSelected:e,allowedTypes:t=["pdf","csv","txt","json"],maxSizeMB:a=10,disabled:l=!1,uploadText:s=null}){const[o,c]=(0,n.useState)(!1),[p,h]=(0,n.useState)(null),u=(0,n.useRef)(null),m=()=>t.map(e=>e.toUpperCase()).join(", "),x=n=>{const i=n.name.split(".").pop().toLowerCase();if(!t.includes(i))return void h((0,r.__)(`Please select a valid file. Allowed types: ${m()}`,"datamachine"));const l=1024*a*1024;n.size>l?h((0,r.__)(`File size exceeds ${a}MB limit.`,"datamachine")):e&&(e(n),h(null))},f=()=>{u.current&&u.current.click()},g=(0,r.__)("Drag and drop file here","datamachine");return(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),l||c(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),c(!1)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDrop:e=>{if(e.preventDefault(),e.stopPropagation(),c(!1),l)return;const n=e.dataTransfer.files;n.length>0&&x(n[0])},style:{border:"2px dashed "+(o?"#0073aa":"#dcdcde"),borderRadius:"4px",padding:"40px 20px",textAlign:"center",background:o?"#f0f6fc":"#f9f9f9",transition:"all 0.2s",cursor:l?"not-allowed":"pointer",opacity:l?.6:1},onClick:l?void 0:f,children:[(0,i.jsx)("div",{style:{marginBottom:"16px",fontSize:"48px",color:"#757575"},children:"ðŸ“"}),(0,i.jsx)("p",{style:{margin:"0 0 8px 0",fontSize:"16px",fontWeight:"500"},children:s||g}),(0,i.jsx)("p",{style:{margin:"0 0 12px 0",color:"#757575",fontSize:"13px"},children:(0,r.__)(`Allowed: ${m()} (max ${a}MB)`,"datamachine")}),(0,i.jsx)("p",{style:{margin:"0 0 16px 0",color:"#757575",fontSize:"14px"},children:(0,r.__)("or","datamachine")}),(0,i.jsx)(d.Button,{variant:"secondary",onClick:f,disabled:l,children:(0,r.__)("Browse Files","datamachine")}),(0,i.jsx)("input",{ref:u,type:"file",accept:t.map(e=>`.${e}`).join(","),onChange:e=>{const n=e.target.files;n.length>0&&x(n[0])},style:{display:"none"},disabled:l})]}),p&&(0,i.jsx)("div",{style:{marginTop:"12px",padding:"8px 12px",background:"#fef7f7",border:"1px solid #dc3232",borderRadius:"4px",color:"#dc3232",fontSize:"13px"},children:p})]})}function R({files:e=[],onDelete:t,isDeleting:a=!1}){const[l,s]=(0,n.useState)(null),o=e=>{if(0===e)return"0 Bytes";const n=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,n)*100)/100+" "+["Bytes","KB","MB","GB"][n]},c=e=>{const n=new Date(e);return n.toLocaleDateString()+" "+n.toLocaleTimeString()};return 0===e.length?(0,i.jsx)("div",{style:{padding:"40px 20px",textAlign:"center",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"},children:(0,i.jsx)("p",{style:{margin:0,color:"#757575"},children:(0,r.__)("No context files uploaded yet.","datamachine")})}):(0,i.jsx)("div",{style:{border:"1px solid #dcdcde",borderRadius:"4px",maxHeight:"400px",overflowY:"auto"},children:(0,i.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse"},children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{style:{background:"#f9f9f9",borderBottom:"1px solid #dcdcde",position:"sticky",top:0,zIndex:1},children:[(0,i.jsx)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600"},children:(0,r.__)("File Name","datamachine")}),(0,i.jsx)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600",width:"100px"},children:(0,r.__)("Size","datamachine")}),(0,i.jsx)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600",width:"180px"},children:(0,r.__)("Uploaded","datamachine")}),(0,i.jsx)("th",{style:{padding:"12px 16px",textAlign:"center",fontWeight:"600",width:"100px"},children:(0,r.__)("Actions","datamachine")})]})}),(0,i.jsx)("tbody",{children:e.map(e=>{const n=l===e.file_id;return(0,i.jsxs)("tr",{style:{borderBottom:"1px solid #dcdcde"},children:[(0,i.jsx)("td",{style:{padding:"12px 16px",fontWeight:"500"},children:e.file_name}),(0,i.jsx)("td",{style:{padding:"12px 16px",color:"#757575"},children:o(e.file_size)}),(0,i.jsx)("td",{style:{padding:"12px 16px",color:"#757575",fontSize:"13px"},children:c(e.uploaded_at)}),(0,i.jsx)("td",{style:{padding:"12px 16px",textAlign:"center"},children:(0,i.jsx)(d.Button,{variant:"link",onClick:()=>(async e=>{s(e),t&&await t(e),s(null)})(e.file_id),disabled:a||n,isBusy:n,style:{color:"#dc3232"},children:n?(0,r.__)("Deleting...","datamachine"):(0,r.__)("Delete","datamachine")})})]},e.file_id)})})]})})}function F({pipelineId:e}){const[t,a]=(0,n.useState)([]),[l,s]=(0,n.useState)(!0),[o,c]=(0,n.useState)(!1),[p,m]=(0,n.useState)(!1),[x,f]=(0,n.useState)(null),[g,_]=(0,n.useState)(null),y=async()=>{s(!0),f(null);try{const n=await(async e=>await u(`/pipelines/${e}/context-files`))(e);n.success?a(n.data||[]):f(n.message||(0,r.__)("Failed to load context files","datamachine"))}catch(e){console.error("Load files error:",e),f(e.message||(0,r.__)("An error occurred while loading files","datamachine"))}finally{s(!1)}};return(0,n.useEffect)(()=>{e&&y()},[e]),(0,i.jsxs)("div",{className:"datamachine-pipeline-context-files",children:[(0,i.jsxs)("div",{style:{marginBottom:"16px"},children:[(0,i.jsx)("h3",{style:{margin:"0 0 8px 0",fontSize:"16px",fontWeight:"600"},children:(0,r.__)("Context Files","datamachine")}),(0,i.jsx)("p",{style:{margin:0,color:"#757575",fontSize:"13px"},children:(0,r.__)("Upload files for AI context retrieval during pipeline execution.","datamachine")})]}),x&&(0,i.jsx)(d.Notice,{status:"error",isDismissible:!0,onRemove:()=>f(null),children:(0,i.jsx)("p",{children:x})}),g&&(0,i.jsx)(d.Notice,{status:"success",isDismissible:!0,onRemove:()=>_(null),children:(0,i.jsx)("p",{children:g})}),(0,i.jsx)("div",{style:{marginBottom:"24px"},children:(0,i.jsx)(P,{onFileSelected:async n=>{c(!0),f(null),_(null);try{const t=await(async(e,n)=>{const t=h(),a=new FormData;a.append("file",n);try{const n=await fetch(`/wp-json/${t.restNamespace}/pipelines/${e}/context-files`,{method:"POST",headers:{"X-WP-Nonce":t.restNonce},body:a}),i=await n.json();if(!n.ok)throw new Error(i.message||"Upload failed");return{success:!0,data:i,message:i.message||""}}catch(e){return console.error("Upload error:",e),{success:!1,data:null,message:e.message||"An error occurred during upload"}}})(e,n);t.success?(_((0,r.__)("File uploaded successfully!","datamachine")),await y()):f(t.message||(0,r.__)("Failed to upload file","datamachine"))}catch(e){console.error("Upload error:",e),f(e.message||(0,r.__)("An error occurred during upload","datamachine"))}finally{c(!1)}},allowedTypes:["pdf","csv","txt","json"],maxSizeMB:10,disabled:o||l,uploadText:o?(0,r.__)("Uploading...","datamachine"):null})}),l?(0,i.jsx)("div",{style:{textAlign:"center",padding:"20px",color:"#757575"},children:(0,r.__)("Loading files...","datamachine")}):(0,i.jsx)(R,{files:t,onDelete:async n=>{m(!0),f(null),_(null);try{const t=await(async(e,n)=>await u(`/pipelines/${e}/context-files/${n}`,{method:"DELETE"}))(e,n);t.success?(_((0,r.__)("File deleted successfully!","datamachine")),await y()):f(t.message||(0,r.__)("Failed to delete file","datamachine"))}catch(e){console.error("Delete error:",e),f(e.message||(0,r.__)("An error occurred during deletion","datamachine"))}finally{m(!1)}},isDeleting:p})]})}function M({flowId:e,flowName:t,onNameChange:a,onDelete:l,onDuplicate:s,onRun:o,onSchedule:c}){const[p,h]=(0,n.useState)(t),m=(0,n.useRef)(null);(0,n.useEffect)(()=>{h(t)},[t]);const x=(0,n.useCallback)(async n=>{if(n&&n!==t)try{const t=await(async(e,n)=>await u(`/flows/${e}`,{method:"PATCH",data:{flow_name:n}}))(e,n);t.success&&a&&a(e,n)}catch(e){console.error("Flow title save failed:",e)}},[e,t,a]),f=(0,n.useCallback)(e=>{h(e),m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{x(e)},C)},[x]),g=(0,n.useCallback)(()=>{window.confirm((0,r.__)("Are you sure you want to delete this flow?","datamachine"))&&l&&l(e)},[e,l]);return(0,n.useEffect)(()=>()=>{m.current&&clearTimeout(m.current)},[]),(0,i.jsx)("div",{className:"datamachine-flow-header",children:(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"12px",marginBottom:"16px"},children:[(0,i.jsx)("div",{style:{flex:1},children:(0,i.jsx)(d.TextControl,{value:p,onChange:f,placeholder:(0,r.__)("Flow name...","datamachine"),style:{fontSize:"16px",fontWeight:"500"}})}),(0,i.jsxs)("div",{className:"datamachine-flow-actions",style:{display:"flex",gap:"8px"},children:[(0,i.jsx)(d.Button,{variant:"primary",onClick:()=>o&&o(e),children:(0,r.__)("Run Now","datamachine")}),(0,i.jsx)(d.Button,{variant:"secondary",onClick:()=>c&&c(e),children:(0,r.__)("Schedule","datamachine")}),(0,i.jsx)(d.Button,{variant:"secondary",onClick:()=>s&&s(e),children:(0,r.__)("Duplicate","datamachine")}),(0,i.jsx)(d.Button,{variant:"secondary",isDestructive:!0,onClick:g,icon:"trash"})]})]})})}function E({handlerSlug:e,handlerConfig:n,stepType:t,onConfigure:a}){if(!e)return(0,i.jsxs)("div",{className:"datamachine-flow-step-handler datamachine-flow-step-handler--empty",style:{padding:"12px",backgroundColor:"#fff3cd",border:"1px solid #ffc107",borderRadius:"4px",marginTop:"12px"},children:[(0,i.jsx)("p",{style:{margin:"0 0 8px 0",fontSize:"12px",color:"#856404"},children:(0,r.__)("No handler configured","datamachine")}),(0,i.jsx)(d.Button,{variant:"secondary",size:"small",onClick:a,children:(0,r.__)("Configure Handler","datamachine")})]});const l=n&&Object.keys(n).length>0;return(0,i.jsxs)("div",{className:"datamachine-flow-step-handler",style:{marginTop:"12px"},children:[(0,i.jsx)("div",{className:"datamachine-handler-tag",style:{display:"inline-block",padding:"4px 12px",backgroundColor:"#0073aa",color:"#ffffff",borderRadius:"3px",fontSize:"11px",fontWeight:"500",marginBottom:"8px"},children:T(e)}),l&&(0,i.jsx)("div",{className:"datamachine-handler-settings-display",style:{padding:"8px 12px",backgroundColor:"#f6f7f7",border:"1px solid #dcdcde",borderRadius:"4px",fontSize:"12px",marginBottom:"8px"},children:Object.entries(n).map(([e,n])=>(0,i.jsxs)("div",{style:{marginBottom:"4px"},children:[(0,i.jsxs)("strong",{children:[T(e),":"]})," ","object"==typeof n?JSON.stringify(n):String(n)]},e))}),(0,i.jsx)(d.Button,{variant:"secondary",size:"small",onClick:a,children:(0,r.__)("Configure","datamachine")})]})}function O({flowId:e,flowStepId:t,flowStepConfig:a,pipelineStep:l,pipelineConfig:s,onConfigure:o}){const c="ai"===l.step_type,p=c?s[l.pipeline_step_id]:null,[h,m]=(0,n.useState)(a.user_message||""),[x,f]=(0,n.useState)(!1),[g,_]=(0,n.useState)(null),y=(0,n.useRef)(null);(0,n.useEffect)(()=>{m(a.user_message||"")},[a.user_message]);const j=(0,n.useCallback)(async n=>{if(!c)return;const i=a.user_message||"";if(n!==i){f(!0),_(null);try{const a=await(async(e,n,t)=>await u(`/flows/${e}/steps/${n}/message`,{method:"PUT",data:{user_message:t}}))(e,t,n);a.success||(_(a.message||(0,r.__)("Failed to update user message","datamachine")),m(i))}catch(e){console.error("User message update error:",e),_(e.message||(0,r.__)("An error occurred","datamachine")),m(i)}finally{f(!1)}}},[e,t,a.user_message,c]),b=(0,n.useCallback)(e=>{m(e),y.current&&clearTimeout(y.current),y.current=setTimeout(()=>{j(e)},C)},[j]);return(0,n.useEffect)(()=>()=>{y.current&&clearTimeout(y.current)},[]),(0,i.jsx)(d.Card,{className:`datamachine-flow-step-card datamachine-step-type--${l.step_type}`,size:"small",children:(0,i.jsxs)(d.CardBody,{children:[g&&(0,i.jsx)(d.Notice,{status:"error",isDismissible:!0,onRemove:()=>_(null),children:g}),(0,i.jsxs)("div",{style:{marginBottom:"12px"},children:[(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"},children:[(0,i.jsx)(B,{stepType:l.step_type,size:20}),(0,i.jsx)("strong",{children:l.label||T(l.step_type)}),(0,i.jsxs)("span",{style:{color:"#757575",fontSize:"12px"},children:["(Order: ",a.execution_order,")"]})]}),c&&p&&(0,i.jsxs)("div",{className:"datamachine-ai-config-display",style:{marginTop:"12px"},children:[(0,i.jsxs)("div",{style:{fontSize:"12px",color:"#757575",marginBottom:"8px"},children:[(0,i.jsx)("strong",{children:(0,r.__)("AI Provider:","datamachine")})," ",p.ai_provider||"Not configured"," | ",(0,i.jsx)("strong",{children:(0,r.__)("Model:","datamachine")})," ",p.ai_model||"Not configured"]}),(0,i.jsx)(d.TextareaControl,{label:(0,r.__)("User Message","datamachine"),value:h,onChange:b,placeholder:(0,r.__)("Enter user message for AI processing...","datamachine"),rows:4,help:x?(0,r.__)("Saving...","datamachine"):null})]}),(0,i.jsx)(E,{handlerSlug:a.handler_slug,handlerConfig:a.handler_config||{},stepType:l.step_type,onConfigure:()=>o&&o(t)})]})]})})}function $({flowId:e,flowConfig:t,pipelineSteps:a,pipelineConfig:l,onStepConfigured:s}){const o=(0,n.useMemo)(()=>t&&a&&Array.isArray(a)?Object.entries(t).map(([e,n])=>({flowStepId:e,...n})).sort((e,n)=>(e.execution_order||0)-(n.execution_order||0)).map(e=>{const n=a.find(n=>n.pipeline_step_id===e.pipeline_step_id);return{flowStepId:e.flowStepId,flowStepConfig:e,pipelineStep:n||{pipeline_step_id:e.pipeline_step_id,step_type:e.step_type,label:"Unknown Step"}}}):[],[t,a]);return 0===o.length?(0,i.jsx)("div",{className:"datamachine-flow-steps-empty",style:{padding:"20px",textAlign:"center",backgroundColor:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"},children:(0,i.jsx)("p",{style:{color:"#757575",margin:0},children:(0,r.__)("No steps configured for this flow.","datamachine")})}):(0,i.jsx)("div",{className:"datamachine-flow-steps",style:{display:"flex",alignItems:"stretch",gap:"0",overflowX:"auto",padding:"20px 0"},children:o.map((n,t)=>(0,i.jsxs)("div",{style:{display:"flex",alignItems:"stretch"},children:[(0,i.jsx)("div",{style:{flex:"0 0 auto",minWidth:"300px"},children:(0,i.jsx)(O,{flowId:e,flowStepId:n.flowStepId,flowStepConfig:n.flowStepConfig,pipelineStep:n.pipelineStep,pipelineConfig:l,onConfigure:s})}),t<o.length-1&&(0,i.jsx)(D,{})]},n.flowStepId))})}function W({schedulingConfig:e}){const{interval:n,last_run_at:t,next_run_time:a}=e||{},l=n&&"manual"!==n?n:(0,r.__)("Manual","datamachine");return(0,i.jsxs)("div",{className:"datamachine-flow-footer",style:{display:"flex",gap:"20px",padding:"12px 16px",backgroundColor:"#f9f9f9",borderTop:"1px solid #dcdcde",fontSize:"12px",color:"#757575"},children:[(0,i.jsxs)("div",{className:"datamachine-flow-meta-item",children:[(0,i.jsx)("strong",{children:(0,r.__)("Schedule:","datamachine")})," ",l]}),(0,i.jsxs)("div",{className:"datamachine-flow-meta-item",children:[(0,i.jsx)("strong",{children:(0,r.__)("Last Run:","datamachine")})," ",k(t)]}),n&&"manual"!==n&&(0,i.jsxs)("div",{className:"datamachine-flow-meta-item",children:[(0,i.jsx)("strong",{children:(0,r.__)("Next Run:","datamachine")})," ",k(a)]})]})}function U({isOpen:e,onClose:t,pipelineId:a,nextExecutionOrder:l,onSuccess:s}){const[o,c]=(0,n.useState)(!1),[p,h]=(0,n.useState)(null);if(!e)return null;const m=window.dataMachineConfig?.stepTypes||{},x=window.dataMachineConfig?.handlers||{};return(0,i.jsx)(d.Modal,{title:(0,r.__)("Add Pipeline Step","datamachine"),onRequestClose:t,className:"datamachine-modal datamachine-step-selection-modal",style:{maxWidth:"600px"},children:(0,i.jsxs)("div",{className:"datamachine-modal-content",children:[p&&(0,i.jsx)("div",{className:"notice notice-error",style:{marginBottom:"16px"},children:(0,i.jsx)("p",{children:p})}),(0,i.jsx)("p",{style:{marginBottom:"20px",color:"#757575"},children:(0,r.__)("Select the type of step you want to add to your pipeline:","datamachine")}),(0,i.jsx)("div",{className:"datamachine-step-type-grid",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"16px"},children:Object.entries(m).map(([e,n])=>{const d=N(e),p=(e=>Object.values(x).filter(n=>n.type===e).length)(e);return(0,i.jsxs)("button",{type:"button",className:"datamachine-step-type-card",onClick:()=>(async e=>{c(!0),h(null);try{const n=await(async(e,n,t)=>await u(`/pipelines/${e}/steps`,{method:"POST",data:{step_type:n,execution_order:t,label:`${n.charAt(0).toUpperCase()+n.slice(1)} Step`}}))(a,e,l);n.success?(s&&s(),t()):h(n.message||(0,r.__)("Failed to add step","datamachine"))}catch(e){console.error("Step addition error:",e),h(e.message||(0,r.__)("An error occurred","datamachine"))}finally{c(!1)}})(e),disabled:o,style:{padding:"20px",border:"2px solid #dcdcde",borderRadius:"4px",background:"#ffffff",cursor:"pointer",textAlign:"left",transition:"all 0.2s",display:"flex",flexDirection:"column",gap:"8px"},onMouseEnter:e=>{e.currentTarget.style.borderColor=d.color,e.currentTarget.style.background="#f9f9f9"},onMouseLeave:e=>{e.currentTarget.style.borderColor="#dcdcde",e.currentTarget.style.background="#ffffff"},children:[(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,i.jsx)(B,{stepType:e,size:24}),(0,i.jsx)("strong",{style:{fontSize:"16px"},children:n.label||T(e)})]}),(0,i.jsx)("p",{style:{margin:0,fontSize:"13px",color:"#757575"},children:n.description||""}),"ai"!==e&&p>0&&(0,i.jsxs)("span",{style:{fontSize:"12px",color:"#757575"},children:[p," ",1===p?(0,r.__)("handler","datamachine"):(0,r.__)("handlers","datamachine")," ",(0,r.__)("available","datamachine")]})]},e)})}),(0,i.jsx)("div",{style:{marginTop:"24px",padding:"16px",background:"#f9f9f9",borderRadius:"4px"},children:(0,i.jsxs)("p",{style:{margin:0,fontSize:"12px",color:"#757575"},children:[(0,i.jsx)("strong",{children:(0,r.__)("Tip:","datamachine")})," ",(0,r.__)("Steps execute in order. You can configure each step after adding it.","datamachine")]})}),(0,i.jsx)("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:"20px",paddingTop:"20px",borderTop:"1px solid #dcdcde"},children:(0,i.jsx)(d.Button,{variant:"secondary",onClick:t,disabled:o,children:(0,r.__)("Cancel","datamachine")})})]})})}function L({toolId:e,label:n,description:t,checked:a,configured:l,onChange:s,disabled:o=!1}){return(0,i.jsx)("div",{style:{padding:"12px",border:"1px solid "+(a?"#0073aa":"#dcdcde"),borderRadius:"4px",background:a?"#f0f6fc":"#ffffff",transition:"all 0.2s"},children:(0,i.jsxs)("div",{style:{display:"flex",alignItems:"flex-start",gap:"8px"},children:[(0,i.jsx)(d.CheckboxControl,{checked:a,onChange:s,disabled:o,__nextHasNoMarginBottom:!0}),(0,i.jsxs)("div",{style:{flex:1},children:[(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"4px"},children:[(0,i.jsx)("span",{style:{fontWeight:"500",fontSize:"14px"},children:n}),a&&(0,i.jsx)("span",{style:{fontSize:"16px",lineHeight:"1"},title:l?"Configured":"Configuration required",children:l?"âœ…":"âš ï¸"})]}),t&&(0,i.jsx)("p",{style:{margin:0,fontSize:"12px",color:"#757575"},children:t})]})]})})}function H({unconfiguredTools:e=[]}){return 0===e.length?null:(0,i.jsxs)("div",{style:{marginTop:"12px",padding:"12px",background:"#fff8e5",border:"1px solid #f0b849",borderRadius:"4px",display:"flex",alignItems:"flex-start",gap:"8px"},children:[(0,i.jsx)("span",{style:{color:"#f0b849",fontSize:"18px",lineHeight:"1"},children:"âš ï¸"}),(0,i.jsxs)("div",{style:{flex:1},children:[(0,i.jsx)("p",{style:{margin:"0 0 4px 0",fontWeight:"500",fontSize:"13px"},children:(0,r.__)("Configuration Required","datamachine")}),(0,i.jsx)("p",{style:{margin:0,fontSize:"12px",color:"#757575"},children:(0,r.__)("The following tools require configuration before use:","datamachine")}),(0,i.jsx)("ul",{style:{margin:"8px 0 0 20px",fontSize:"12px",color:"#757575"},children:e.map((e,n)=>(0,i.jsx)("li",{children:e},n))})]})]})}function q({selectedTools:e=[],onSelectionChange:t}){const[a,l]=(0,n.useState)([]),[s,o]=(0,n.useState)([]);return(0,n.useEffect)(()=>{const e=window.dataMachineConfig?.aiTools||{},n=Object.entries(e).map(([e,n])=>({toolId:e,label:n.label||e,description:n.description||"",configured:n.configured||!1}));l(n)},[]),(0,n.useEffect)(()=>{const n=a.filter(n=>e.includes(n.toolId)&&!n.configured).map(e=>e.label);o(n)},[e,a]),0===a.length?null:(0,i.jsxs)("div",{style:{marginTop:"16px"},children:[(0,i.jsx)("label",{style:{display:"block",marginBottom:"8px",fontWeight:"500",fontSize:"14px"},children:(0,r.__)("AI Tools","datamachine")}),(0,i.jsx)("p",{style:{margin:"0 0 12px 0",fontSize:"12px",color:"#757575"},children:(0,r.__)("Select the tools you want to enable for this AI step:","datamachine")}),(0,i.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:"8px"},children:a.map(n=>(0,i.jsx)(L,{toolId:n.toolId,label:n.label,description:n.description,checked:e.includes(n.toolId),configured:n.configured,onChange:()=>(n=>{const a=e.includes(n)?e.filter(e=>e!==n):[...e,n];t&&t(a)})(n.toolId)},n.toolId))}),(0,i.jsx)(H,{unconfiguredTools:s})]})}function J({isOpen:e,onClose:t,pipelineId:a,pipelineStepId:l,stepType:s,currentConfig:o,onSuccess:c}){const[p,h]=(0,n.useState)(o?.ai_provider||""),[u,x]=(0,n.useState)(o?.ai_model||""),[f,g]=(0,n.useState)(o?.system_prompt||""),[_,y]=(0,n.useState)(o?.enabled_tools||[]),[j,b]=(0,n.useState)(!1),[w,v]=(0,n.useState)(null);if((0,n.useEffect)(()=>{e&&(h(o?.ai_provider||""),x(o?.ai_model||""),g(o?.system_prompt||""),y(o?.enabled_tools||[]),v(null))},[e,o]),!e)return null;const C=window.dataMachineConfig?.aiProviders||{},S=(0,n.useMemo)(()=>{const e=[{value:"",label:(0,r.__)("Select Provider...","datamachine")}];return Object.entries(C).forEach(([n,t])=>{e.push({value:n,label:t.label||n})}),e},[C]),k=(0,n.useMemo)(()=>{if(!p||!C[p])return[{value:"",label:(0,r.__)("Select provider first...","datamachine")}];const e=[{value:"",label:(0,r.__)("Select Model...","datamachine")}],n=C[p];return n.models&&Array.isArray(n.models)&&n.models.forEach(n=>{e.push({value:n.id,label:n.name||n.id})}),e},[p,C]),T=p!==(o?.ai_provider||"")||u!==(o?.ai_model||"")||f!==(o?.system_prompt||"")||JSON.stringify(_)!==JSON.stringify(o?.enabled_tools||[]);return(0,i.jsx)(d.Modal,{title:(0,r.__)("Configure AI Step","datamachine"),onRequestClose:t,className:"datamachine-modal datamachine-configure-step-modal",style:{maxWidth:"600px"},children:(0,i.jsxs)("div",{className:"datamachine-modal-content",children:[w&&(0,i.jsx)("div",{className:"notice notice-error",style:{marginBottom:"16px"},children:(0,i.jsx)("p",{children:w})}),(0,i.jsx)(d.SelectControl,{label:(0,r.__)("AI Provider","datamachine"),value:p,options:S,onChange:e=>{h(e),x("")},help:(0,r.__)("Choose the AI provider for this step.","datamachine")}),(0,i.jsx)(d.SelectControl,{label:(0,r.__)("AI Model","datamachine"),value:u,options:k,onChange:x,disabled:!p,help:(0,r.__)("Choose the AI model to use.","datamachine")}),(0,i.jsx)(q,{selectedTools:_,onSelectionChange:y}),(0,i.jsx)(d.TextareaControl,{label:(0,r.__)("System Prompt","datamachine"),value:f,onChange:g,placeholder:(0,r.__)("Enter system prompt for AI processing...","datamachine"),rows:8,help:(0,r.__)("Optional: Provide instructions for the AI to follow during processing.","datamachine")}),(0,i.jsx)("div",{style:{marginTop:"16px",padding:"12px",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"},children:(0,i.jsxs)("p",{style:{margin:0,fontSize:"12px",color:"#757575"},children:[(0,i.jsx)("strong",{children:(0,r.__)("Note:","datamachine")})," ",(0,r.__)("The system prompt is shared across all flows using this pipeline. To add flow-specific instructions, use the user message field in the flow step card.","datamachine")]})}),(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"},children:[(0,i.jsx)(d.Button,{variant:"secondary",onClick:t,disabled:j,children:(0,r.__)("Cancel","datamachine")}),(0,i.jsx)(d.Button,{variant:"primary",onClick:async()=>{if(p)if(u){b(!0),v(null);try{const e=await m(a,l,f,p,u,_);e.success?(c&&c(),t()):v(e.message||(0,r.__)("Failed to update configuration","datamachine"))}catch(e){console.error("Configuration update error:",e),v(e.message||(0,r.__)("An error occurred","datamachine"))}finally{b(!1)}}else v((0,r.__)("Please select an AI model","datamachine"));else v((0,r.__)("Please select an AI provider","datamachine"))},disabled:j||!T||!p||!u,isBusy:j,children:j?(0,r.__)("Saving...","datamachine"):(0,r.__)("Save Configuration","datamachine")})]})]})})}function V({isOpen:e,onClose:t,flowId:a,flowName:l,currentInterval:s,onSuccess:o}){const[c,p]=(0,n.useState)(s||"manual"),[h,m]=(0,n.useState)(!1),[x,g]=(0,n.useState)(null);if(!e)return null;const _=c!==(s||"manual");return(0,i.jsx)(d.Modal,{title:(0,r.__)("Schedule Flow","datamachine"),onRequestClose:t,className:"datamachine-modal datamachine-flow-schedule-modal",style:{maxWidth:"500px"},children:(0,i.jsxs)("div",{className:"datamachine-modal-content",children:[x&&(0,i.jsx)("div",{className:"notice notice-error",style:{marginBottom:"16px"},children:(0,i.jsx)("p",{children:x})}),(0,i.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,i.jsx)("strong",{children:(0,r.__)("Flow:","datamachine")})," ",l]}),(0,i.jsx)(d.SelectControl,{label:(0,r.__)("Schedule Interval","datamachine"),value:c,options:f,onChange:e=>p(e),help:(0,r.__)("Choose how often this flow should run automatically.","datamachine")}),"manual"===c&&(0,i.jsx)("div",{style:{marginTop:"16px",padding:"12px",background:"#f0f6fc",border:"1px solid #0073aa",borderRadius:"4px"},children:(0,i.jsxs)("p",{style:{margin:0,fontSize:"13px",color:"#0073aa"},children:[(0,i.jsx)("strong",{children:(0,r.__)("Manual Mode:","datamachine")})," ",(0,r.__)('Flow will only run when triggered manually via the "Run Now" button.',"datamachine")]})}),"manual"!==c&&(0,i.jsx)("div",{style:{marginTop:"16px",padding:"12px",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"},children:(0,i.jsxs)("p",{style:{margin:0,fontSize:"13px",color:"#757575"},children:[(0,i.jsx)("strong",{children:(0,r.__)("Automatic Scheduling:","datamachine")})," ",(0,r.__)("Flow will run automatically based on the selected interval. You can still trigger it manually anytime.","datamachine")]})}),(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"},children:[(0,i.jsx)(d.Button,{variant:"secondary",onClick:t,disabled:h,children:(0,r.__)("Cancel","datamachine")}),(0,i.jsx)(d.Button,{variant:"primary",onClick:async()=>{m(!0),g(null);try{const e=await(async(e,n)=>await u(`/flows/${e}/schedule`,{method:"PUT",data:n}))(a,{interval:c});e.success?(o&&o(),t()):g(e.message||(0,r.__)("Failed to update schedule","datamachine"))}catch(e){console.error("Schedule update error:",e),g(e.message||(0,r.__)("An error occurred","datamachine"))}finally{m(!1)}},disabled:h||!_,isBusy:h,children:h?(0,r.__)("Saving...","datamachine"):(0,r.__)("Save Schedule","datamachine")})]})]})})}function X({isOpen:e,onClose:n,stepType:t,onSelectHandler:a}){if(!e)return null;const l=window.dataMachineConfig?.handlers||{},s=Object.entries(l).filter(([e,n])=>n.type===t);return(0,i.jsx)(d.Modal,{title:(0,r.__)("Select Handler","datamachine"),onRequestClose:n,className:"datamachine-modal datamachine-handler-selection-modal",style:{maxWidth:"600px"},children:(0,i.jsxs)("div",{className:"datamachine-modal-content",children:[(0,i.jsx)("p",{style:{marginBottom:"20px",color:"#757575"},children:(0,r.__)("Choose the handler for this step:","datamachine")}),0===s.length&&(0,i.jsx)("div",{style:{padding:"40px 20px",textAlign:"center",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"},children:(0,i.jsx)("p",{style:{margin:0,color:"#757575"},children:(0,r.__)("No handlers available for this step type.","datamachine")})}),s.length>0&&(0,i.jsx)("div",{className:"datamachine-handler-grid",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"16px"},children:s.map(([e,t])=>(0,i.jsxs)("button",{type:"button",className:"datamachine-handler-card",onClick:()=>(a&&a(e),void n()),style:{padding:"20px",border:"2px solid #dcdcde",borderRadius:"4px",background:"#ffffff",cursor:"pointer",textAlign:"left",transition:"all 0.2s",display:"flex",flexDirection:"column",gap:"8px"},onMouseEnter:e=>{e.currentTarget.style.borderColor="#0073aa",e.currentTarget.style.background="#f9f9f9"},onMouseLeave:e=>{e.currentTarget.style.borderColor="#dcdcde",e.currentTarget.style.background="#ffffff"},children:[(0,i.jsx)("strong",{style:{fontSize:"16px"},children:t.label||T(e)}),(0,i.jsx)("p",{style:{margin:0,fontSize:"13px",color:"#757575"},children:t.description||""}),t.requires_auth&&(0,i.jsx)("span",{style:{display:"inline-block",padding:"2px 8px",background:"#f0b849",color:"#000",borderRadius:"3px",fontSize:"11px",fontWeight:"500"},children:(0,r.__)("Requires Auth","datamachine")})]},e))}),(0,i.jsx)("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"},children:(0,i.jsx)(d.Button,{variant:"secondary",onClick:n,children:(0,r.__)("Cancel","datamachine")})})]})})}function Y({onFileUploaded:e}){const[t,a]=(0,n.useState)(!1),[l,s]=(0,n.useState)(null),[o,c]=(0,n.useState)(null);return(0,i.jsxs)("div",{children:[l&&(0,i.jsx)(d.Notice,{status:"error",isDismissible:!0,onRemove:()=>s(null),children:(0,i.jsx)("p",{children:l})}),o&&(0,i.jsx)(d.Notice,{status:"success",isDismissible:!0,onRemove:()=>c(null),children:(0,i.jsx)("p",{children:o})}),(0,i.jsx)(P,{onFileSelected:async n=>{a(!0),s(null),c(null);try{await new Promise(e=>setTimeout(e,1e3)),e&&e({file_name:n.name,file_size:n.size,status:"pending"}),c((0,r.__)("File uploaded successfully!","datamachine"))}catch(e){console.error("Upload error:",e),s(e.message||(0,r.__)("An error occurred during upload","datamachine"))}finally{a(!1)}},allowedTypes:["pdf","csv","txt","json","jpg","jpeg","png","gif"],maxSizeMB:10,disabled:t,uploadText:t?(0,r.__)("Uploading...","datamachine"):null})]})}function G({files:e=[]}){const n=e=>{if(0===e)return"0 Bytes";const n=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,n)*100)/100+" "+["Bytes","KB","MB","GB"][n]},t=e=>{const n={processed:{label:(0,r.__)("Processed","datamachine"),color:"#46b450",icon:"âœ“"},pending:{label:(0,r.__)("Pending","datamachine"),color:"#f0b849",icon:"â—"}},t=n[e]||n.pending;return(0,i.jsxs)("span",{style:{display:"inline-flex",alignItems:"center",gap:"4px",padding:"4px 8px",background:`${t.color}20`,color:t.color,borderRadius:"3px",fontSize:"11px",fontWeight:"500"},children:[(0,i.jsx)("span",{children:t.icon}),t.label]})};return 0===e.length?(0,i.jsx)("div",{style:{padding:"40px 20px",textAlign:"center",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"},children:(0,i.jsx)("p",{style:{margin:0,color:"#757575"},children:(0,r.__)("No files uploaded yet.","datamachine")})}):(0,i.jsx)("div",{style:{border:"1px solid #dcdcde",borderRadius:"4px",maxHeight:"300px",overflowY:"auto"},children:(0,i.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse"},children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{style:{background:"#f9f9f9",borderBottom:"1px solid #dcdcde",position:"sticky",top:0,zIndex:1},children:[(0,i.jsx)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600"},children:(0,r.__)("File Name","datamachine")}),(0,i.jsx)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600",width:"100px"},children:(0,r.__)("Size","datamachine")}),(0,i.jsx)("th",{style:{padding:"12px 16px",textAlign:"center",fontWeight:"600",width:"120px"},children:(0,r.__)("Status","datamachine")})]})}),(0,i.jsx)("tbody",{children:e.map((e,a)=>(0,i.jsxs)("tr",{style:{borderBottom:"1px solid #dcdcde"},children:[(0,i.jsx)("td",{style:{padding:"12px 16px",fontWeight:"500"},children:e.file_name}),(0,i.jsx)("td",{style:{padding:"12px 16px",color:"#757575"},children:n(e.file_size)}),(0,i.jsx)("td",{style:{padding:"12px 16px",textAlign:"center"},children:t(e.status)})]},a))})]})})}function K({checked:e,onChange:n}){return(0,i.jsx)("div",{style:{marginTop:"16px",padding:"12px",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"},children:(0,i.jsx)(d.CheckboxControl,{label:(0,r.__)("Automatically delete files after processing","datamachine"),checked:e,onChange:n,help:(0,r.__)("Files will be removed from the handler after successful processing. Disable to keep files for multiple uses.","datamachine")})})}function Q({currentSettings:e={},onSettingsChange:t}){const[a,l]=(0,n.useState)(e.files||[]),[s,o]=(0,n.useState)(!1!==e.auto_cleanup);return(0,n.useEffect)(()=>{t&&t({files:a,auto_cleanup:s})},[a,s,t]),(0,i.jsxs)("div",{className:"datamachine-files-handler-settings",children:[(0,i.jsxs)("div",{style:{marginBottom:"16px"},children:[(0,i.jsx)("h4",{style:{margin:"0 0 8px 0",fontSize:"14px",fontWeight:"600"},children:(0,r.__)("Upload Files","datamachine")}),(0,i.jsx)("p",{style:{margin:"0 0 12px 0",fontSize:"12px",color:"#757575"},children:(0,r.__)("Upload files to be processed by this flow. Each file will be processed individually.","datamachine")})]}),(0,i.jsx)(Y,{onFileUploaded:e=>{l(n=>[...n,e])}}),(0,i.jsxs)("div",{style:{marginTop:"24px",marginBottom:"16px"},children:[(0,i.jsx)("h4",{style:{margin:"0 0 8px 0",fontSize:"14px",fontWeight:"600"},children:(0,r.__)("Uploaded Files","datamachine")}),(0,i.jsx)("p",{style:{margin:"0 0 12px 0",fontSize:"12px",color:"#757575"},children:(0,r.__)("Files will be processed in order when the flow runs.","datamachine")})]}),(0,i.jsx)(G,{files:a}),(0,i.jsx)(K,{checked:s,onChange:e=>{o(e)}}),(0,i.jsx)("div",{style:{marginTop:"16px",padding:"12px",background:"#f0f6fc",border:"1px solid #0073aa",borderRadius:"4px"},children:(0,i.jsxs)("p",{style:{margin:0,fontSize:"12px",color:"#0073aa"},children:[(0,i.jsx)("strong",{children:(0,r.__)("Note:","datamachine")})," ",(0,r.__)("Files are stored specifically for this flow. Each uploaded file will create a separate processing job when the flow runs.","datamachine")]})})]})}function Z({isOpen:e,onClose:t,flowStepId:a,handlerSlug:l,stepType:s,pipelineId:o,flowId:c,currentSettings:p,onSuccess:h,onChangeHandler:m,onOAuthConnect:x}){const[f,g]=(0,n.useState)(p||{}),[_,y]=(0,n.useState)(!1),[j,b]=(0,n.useState)(null);if((0,n.useEffect)(()=>{e&&(g(p||{}),b(null))},[e,p,l]),!e)return null;const w=(window.dataMachineConfig?.handlers||{})[l]||{},v=(e,n)=>{g(t=>({...t,[e]:n}))},C=(window.dataMachineConfig?.handlerSettings?.[l]||{}).fields||{};return(0,i.jsx)(d.Modal,{title:(0,r.__)("Configure Handler","datamachine"),onRequestClose:t,className:"datamachine-modal datamachine-handler-settings-modal",style:{maxWidth:"600px"},children:(0,i.jsxs)("div",{className:"datamachine-modal-content",children:[j&&(0,i.jsx)("div",{className:"notice notice-error",style:{marginBottom:"16px"},children:(0,i.jsx)("p",{children:j})}),(0,i.jsxs)("div",{style:{marginBottom:"20px",paddingBottom:"16px",borderBottom:"1px solid #dcdcde"},children:[(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:(0,r.__)("Handler:","datamachine")})," ",w.label||T(l)]}),(0,i.jsx)(d.Button,{variant:"secondary",size:"small",onClick:m,children:(0,r.__)("Change Handler","datamachine")})]}),w.requires_auth&&(0,i.jsx)("div",{style:{marginTop:"12px"},children:(0,i.jsx)(d.Button,{variant:"secondary",onClick:()=>{x&&x(l,w)},children:(0,r.__)("Connect Account","datamachine")})})]}),"files"===l?(0,i.jsx)(Q,{currentSettings:f,onSettingsChange:e=>g(n=>({...n,...e}))}):(0,i.jsxs)(i.Fragment,{children:[0===Object.keys(C).length&&(0,i.jsx)("div",{style:{padding:"20px",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px",textAlign:"center"},children:(0,i.jsx)("p",{style:{margin:0,color:"#757575"},children:(0,r.__)("No configuration options available for this handler.","datamachine")})}),Object.keys(C).length>0&&(0,i.jsx)("div",{className:"datamachine-handler-settings-fields",children:Object.entries(C).map(([e,n])=>((e,n)=>{const t=f[e]||n.default||"";switch(n.type){case"text":default:return(0,i.jsx)(d.TextControl,{label:n.label||T(e),value:t,onChange:n=>v(e,n),help:n.description},e);case"textarea":return(0,i.jsx)(d.TextareaControl,{label:n.label||T(e),value:t,onChange:n=>v(e,n),help:n.description,rows:n.rows||4},e);case"select":const a=n.options||[];return(0,i.jsx)(d.SelectControl,{label:n.label||T(e),value:t,options:a,onChange:n=>v(e,n),help:n.description},e);case"checkbox":return(0,i.jsx)(d.CheckboxControl,{label:n.label||T(e),checked:!!t,onChange:n=>v(e,n),help:n.description},e)}})(e,n))})]}),(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"},children:[(0,i.jsx)(d.Button,{variant:"secondary",onClick:t,disabled:_,children:(0,r.__)("Cancel","datamachine")}),(0,i.jsx)(d.Button,{variant:"primary",onClick:async()=>{y(!0),b(null);try{const e=await(async(e,n,t,a={})=>await u(`/flows/${e}/steps/${n}/handler`,{method:"PUT",data:{handler_slug:t,settings:a}}))(c,a,l,f);e.success?(h&&h(),t()):b(e.message||(0,r.__)("Failed to update handler settings","datamachine"))}catch(e){console.error("Handler settings update error:",e),b(e.message||(0,r.__)("An error occurred","datamachine"))}finally{y(!1)}},disabled:_,isBusy:_,children:_?(0,r.__)("Saving...","datamachine"):(0,r.__)("Save Settings","datamachine")})]})]})})}function ee({pipelines:e,selectedIds:n,onSelectionChange:t}){const a=e.length>0&&n.length===e.length;return(0,i.jsx)("div",{style:{border:"1px solid #dcdcde",borderRadius:"4px",maxHeight:"400px",overflowY:"auto"},children:(0,i.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse"},children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{style:{background:"#f9f9f9",borderBottom:"1px solid #dcdcde",position:"sticky",top:0,zIndex:1},children:[(0,i.jsx)("th",{style:{padding:"12px 16px",textAlign:"left",width:"40px"},children:(0,i.jsx)(d.CheckboxControl,{checked:a,onChange:()=>{n.length===e.length?t([]):t(e.map(e=>e.pipeline_id))},__nextHasNoMarginBottom:!0})}),(0,i.jsx)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600"},children:(0,r.__)("Pipeline Name","datamachine")}),(0,i.jsx)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600",width:"100px"},children:(0,r.__)("Steps","datamachine")}),(0,i.jsx)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600",width:"100px"},children:(0,r.__)("Flows","datamachine")})]})}),(0,i.jsxs)("tbody",{children:[0===e.length&&(0,i.jsx)("tr",{children:(0,i.jsx)("td",{colSpan:"4",style:{padding:"40px 20px",textAlign:"center",color:"#757575"},children:(0,r.__)("No pipelines available","datamachine")})}),e.map(e=>{const a=e.pipeline_steps?.length||0,l=e.flows?.length||0,s=n.includes(e.pipeline_id);return(0,i.jsxs)("tr",{style:{borderBottom:"1px solid #dcdcde",background:s?"#f0f6fc":"transparent",transition:"background 0.2s"},onMouseEnter:e=>{s||(e.currentTarget.style.background="#f9f9f9")},onMouseLeave:e=>{s||(e.currentTarget.style.background="transparent")},children:[(0,i.jsx)("td",{style:{padding:"12px 16px"},children:(0,i.jsx)(d.CheckboxControl,{checked:s,onChange:()=>(e=>{const a=n.includes(e)?n.filter(n=>n!==e):[...n,e];t(a)})(e.pipeline_id),__nextHasNoMarginBottom:!0})}),(0,i.jsx)("td",{style:{padding:"12px 16px",fontWeight:"500"},children:e.pipeline_name}),(0,i.jsx)("td",{style:{padding:"12px 16px",color:"#757575"},children:a}),(0,i.jsx)("td",{style:{padding:"12px 16px",color:"#757575"},children:l})]},e.pipeline_id)})]})]})})}function ne({pipelines:e,onClose:t}){const[a,l]=(0,n.useState)([]),[s,o]=(0,n.useState)(!1),[c,p]=(0,n.useState)(null),[h,m]=(0,n.useState)(null);return(0,i.jsxs)("div",{className:"datamachine-export-tab",children:[c&&(0,i.jsx)(d.Notice,{status:"error",isDismissible:!0,onRemove:()=>p(null),children:(0,i.jsx)("p",{children:c})}),h&&(0,i.jsx)(d.Notice,{status:"success",isDismissible:!0,onRemove:()=>m(null),children:(0,i.jsx)("p",{children:h})}),(0,i.jsx)("p",{style:{marginBottom:"20px",color:"#757575"},children:(0,r.__)("Select the pipelines you want to export to CSV:","datamachine")}),(0,i.jsx)(ee,{pipelines:e,selectedIds:a,onSelectionChange:l}),(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"},children:[(0,i.jsx)(d.Button,{variant:"secondary",onClick:t,disabled:s,children:(0,r.__)("Cancel","datamachine")}),(0,i.jsx)(d.Button,{variant:"primary",onClick:async()=>{if(0!==a.length){o(!0),p(null),m(null);try{const e=await(async e=>await u("/pipelines/export",{method:"POST",data:{pipeline_ids:e}}))(a);if(e.success&&e.data?.csv_content){const n=new Blob([e.data.csv_content],{type:"text/csv"}),t=URL.createObjectURL(n),a=document.createElement("a");a.href=t,a.download=`datamachine-pipelines-${Date.now()}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(t),m((0,r.__)("Pipelines exported successfully!","datamachine")),l([])}else p(e.message||(0,r.__)("Failed to export pipelines","datamachine"))}catch(e){console.error("Export error:",e),p(e.message||(0,r.__)("An error occurred during export","datamachine"))}finally{o(!1)}}else p((0,r.__)("Please select at least one pipeline to export.","datamachine"))},disabled:s||0===a.length,isBusy:s,children:s?(0,r.__)("Exporting...","datamachine"):(0,r.__)("Export Selected","datamachine")})]})]})}function te({onFileSelected:e,fileName:t,disabled:a=!1}){const[l,s]=(0,n.useState)(!1),[o,c]=(0,n.useState)(null),p=(0,n.useRef)(null),h=n=>{if(!n.name.endsWith(".csv")&&"text/csv"!==n.type)return void c((0,r.__)("Please select a valid CSV file.","datamachine"));if(n.size>10485760)return void c((0,r.__)("File size exceeds 10MB limit.","datamachine"));const t=new FileReader;t.onload=t=>{const a=t.target.result;e&&(e(a,n.name),c(null))},t.onerror=()=>{c((0,r.__)("Failed to read file.","datamachine"))},t.readAsText(n)},u=()=>{p.current&&p.current.click()};return(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),a||s(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),s(!1)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDrop:e=>{if(e.preventDefault(),e.stopPropagation(),s(!1),a)return;const n=e.dataTransfer.files;n.length>0&&h(n[0])},style:{border:"2px dashed "+(l?"#0073aa":"#dcdcde"),borderRadius:"4px",padding:"40px 20px",textAlign:"center",background:l?"#f0f6fc":"#f9f9f9",transition:"all 0.2s",cursor:a?"not-allowed":"pointer",opacity:a?.6:1},onClick:a?void 0:u,children:[(0,i.jsx)("div",{style:{marginBottom:"16px",fontSize:"48px",color:"#757575"},children:"ðŸ“„"}),(0,i.jsx)("p",{style:{margin:"0 0 12px 0",fontSize:"16px",fontWeight:"500"},children:t?(0,r.__)("File selected","datamachine"):(0,r.__)("Drag and drop CSV file here","datamachine")}),(0,i.jsx)("p",{style:{margin:"0 0 16px 0",color:"#757575",fontSize:"14px"},children:(0,r.__)("or","datamachine")}),(0,i.jsx)(d.Button,{variant:"secondary",onClick:u,disabled:a,children:(0,r.__)("Browse Files","datamachine")}),(0,i.jsx)("input",{ref:p,type:"file",accept:".csv,text/csv",onChange:e=>{const n=e.target.files;n.length>0&&h(n[0])},style:{display:"none"},disabled:a})]}),o&&(0,i.jsx)("div",{style:{marginTop:"12px",padding:"8px 12px",background:"#fef7f7",border:"1px solid #dc3232",borderRadius:"4px",color:"#dc3232",fontSize:"13px"},children:o})]})}function ae({onSuccess:e,onClose:t}){const[a,l]=(0,n.useState)(null),[s,o]=(0,n.useState)(""),[c,p]=(0,n.useState)(!1),[h,m]=(0,n.useState)(null),[x,f]=(0,n.useState)(null);return(0,i.jsxs)("div",{className:"datamachine-import-tab",children:[h&&(0,i.jsx)(d.Notice,{status:"error",isDismissible:!0,onRemove:()=>m(null),children:(0,i.jsx)("p",{children:h})}),x&&(0,i.jsx)(d.Notice,{status:"success",isDismissible:!0,onRemove:()=>f(null),children:(0,i.jsx)("p",{children:x})}),(0,i.jsx)("p",{style:{marginBottom:"20px",color:"#757575"},children:(0,r.__)("Upload a CSV file to import pipelines:","datamachine")}),(0,i.jsx)(te,{onFileSelected:(e,n)=>{l(e),o(n),m(null),f(null)},fileName:s,disabled:c}),s&&(0,i.jsxs)("div",{style:{marginTop:"16px",display:"flex",alignItems:"center",gap:"12px"},children:[(0,i.jsxs)("span",{style:{color:"#46b450",fontWeight:"500"},children:[(0,r.__)("Selected:","datamachine")," ",s]}),(0,i.jsx)(d.Button,{variant:"link",onClick:()=>{l(null),o(""),m(null),f(null)},disabled:c,style:{color:"#dc3232"},children:(0,r.__)("Clear","datamachine")})]}),(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"},children:[(0,i.jsx)(d.Button,{variant:"secondary",onClick:t,disabled:c,children:(0,r.__)("Cancel","datamachine")}),(0,i.jsx)(d.Button,{variant:"primary",onClick:async()=>{if(a){p(!0),m(null),f(null);try{const n=await(async e=>await u("/pipelines/import",{method:"POST",data:{csv_content:e}}))(a);if(n.success){const t=n.data?.created_count||0;f(t>0?(0,r.__)(`Successfully imported ${t} pipeline(s)!`,"datamachine"):(0,r.__)("Import completed!","datamachine")),l(null),o(""),setTimeout(()=>{e&&e()},1500)}else m(n.message||(0,r.__)("Failed to import pipelines","datamachine"))}catch(e){console.error("Import error:",e),m(e.message||(0,r.__)("An error occurred during import","datamachine"))}finally{p(!1)}}else m((0,r.__)("Please select a CSV file to import.","datamachine"))},disabled:c||!a,isBusy:c,children:c?(0,r.__)("Importing...","datamachine"):(0,r.__)("Import Pipelines","datamachine")})]})]})}function ie({isOpen:e,onClose:t,pipelines:a=[],onSuccess:l}){const[s,o]=(0,n.useState)("export");if(!e)return null;const c=[{name:"export",title:(0,r.__)("Export","datamachine"),className:"datamachine-import-export-tab"},{name:"import",title:(0,r.__)("Import","datamachine"),className:"datamachine-import-export-tab"}],p=()=>{l&&l(),t()};return(0,i.jsx)(d.Modal,{title:(0,r.__)("Import / Export Pipelines","datamachine"),onRequestClose:t,className:"datamachine-modal datamachine-import-export-modal",style:{maxWidth:"700px"},children:(0,i.jsx)("div",{className:"datamachine-modal-content",children:(0,i.jsx)(d.TabPanel,{className:"datamachine-import-export-tabs",activeClass:"is-active",tabs:c,onSelect:e=>o(e),children:e=>(0,i.jsxs)("div",{className:"datamachine-tab-content",children:["export"===e.name&&(0,i.jsx)(ne,{pipelines:a,onClose:t}),"import"===e.name&&(0,i.jsx)(ae,{onSuccess:p,onClose:t})]})})})})}function le({connected:e}){const n=e?{label:(0,r.__)("Connected","datamachine"),color:"#46b450",icon:"âœ“",background:"#e6f4ea"}:{label:(0,r.__)("Not Connected","datamachine"),color:"#dc3232",icon:"âœ—",background:"#fef7f7"};return(0,i.jsxs)("div",{style:{display:"inline-flex",alignItems:"center",gap:"6px",padding:"6px 12px",background:n.background,border:`1px solid ${n.color}`,borderRadius:"4px",fontSize:"13px",fontWeight:"500"},children:[(0,i.jsx)("span",{style:{color:n.color,fontSize:"16px",lineHeight:"1"},children:n.icon}),(0,i.jsx)("span",{style:{color:n.color},children:n.label})]})}function se({account:e}){if(!e||0===Object.keys(e).length)return null;const n=e.username||e.name||e.screen_name||null,t=e.email||null,a=e.id||e.user_id||null;return(0,i.jsxs)("div",{style:{marginTop:"16px",padding:"12px",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"},children:[(0,i.jsx)("h4",{style:{margin:"0 0 8px 0",fontSize:"13px",fontWeight:"600"},children:(0,r.__)("Connected Account","datamachine")}),(0,i.jsxs)("div",{style:{fontSize:"12px",color:"#555"},children:[n&&(0,i.jsxs)("div",{style:{marginBottom:"4px"},children:[(0,i.jsx)("strong",{children:(0,r.__)("Username:","datamachine")})," ",n]}),t&&(0,i.jsxs)("div",{style:{marginBottom:"4px"},children:[(0,i.jsx)("strong",{children:(0,r.__)("Email:","datamachine")})," ",t]}),a&&(0,i.jsxs)("div",{style:{marginBottom:"4px"},children:[(0,i.jsx)("strong",{children:(0,r.__)("Account ID:","datamachine")})," ",a]}),Object.entries(e).map(([e,n])=>["username","name","screen_name","email","id","user_id"].includes(e)||"object"==typeof n||"function"==typeof n?null:(0,i.jsxs)("div",{style:{marginBottom:"4px"},children:[(0,i.jsxs)("strong",{children:[e,":"]})," ",String(n)]},e))]})]})}function oe({config:e={},onChange:n,fields:t=[]}){const a=[{key:"api_key",label:(0,r.__)("API Key","datamachine"),type:"text",required:!0},{key:"api_secret",label:(0,r.__)("API Secret","datamachine"),type:"password",required:!0}],l=t.length>0?t:a;return(0,i.jsxs)("div",{className:"datamachine-api-config-form",children:[(0,i.jsx)("p",{style:{marginBottom:"16px",fontSize:"13px",color:"#757575"},children:(0,r.__)("Enter your API credentials:","datamachine")}),l.map(t=>(0,i.jsx)(d.TextControl,{label:t.label,type:t.type||"text",value:e[t.key]||"",onChange:a=>((t,a)=>{n&&n({...e,[t]:a})})(t.key,a),placeholder:t.placeholder||"",help:t.help||"",required:t.required||!1},t.key))]})}function re({oauthUrl:e,onSuccess:t,onError:a,disabled:l=!1}){const s=(0,n.useRef)(null),o=(0,n.useRef)(null);return(0,n.useEffect)(()=>()=>{o.current&&window.removeEventListener("message",o.current),s.current&&!s.current.closed&&s.current.close()},[]),(0,i.jsx)(d.Button,{variant:"primary",onClick:()=>{s.current&&!s.current.closed&&s.current.close();const n=window.screen.width/2-300,i=window.screen.height/2-350;s.current=window.open(e,"oauth-window",`width=600,height=700,left=${n},top=${i},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`),o.current=e=>{[window.location.origin].includes(e.origin)&&e.data&&"oauth_callback"===e.data.type&&(s.current&&!s.current.closed&&s.current.close(),e.data.success?t&&t(e.data.account):a&&a(e.data.error||(0,r.__)("OAuth authentication failed","datamachine")),window.removeEventListener("message",o.current))},window.addEventListener("message",o.current),s.current&&!s.current.closed||a&&a((0,r.__)("Popup was blocked. Please allow popups for this site.","datamachine"))},disabled:l,children:(0,r.__)("Connect Account","datamachine")})}function de({isOpen:e,onClose:t,handlerSlug:a,handlerInfo:l={},onSuccess:s}){const[o,c]=(0,n.useState)(!1),[p,h]=(0,n.useState)(null),[u,m]=(0,n.useState)({}),[x,f]=(0,n.useState)(!1),[g,_]=(0,n.useState)(null),[y,j]=(0,n.useState)(null),b=l.auth_type||"oauth2",w=l.oauth_url||`/datamachine-auth/${a}/`;return(0,n.useEffect)(()=>{if(e){const e=null;e&&(c(!0),h(e))}},[e]),e?(0,i.jsx)(d.Modal,{title:(0,r.__)("OAuth Authentication","datamachine"),onRequestClose:t,className:"datamachine-modal datamachine-oauth-modal",style:{maxWidth:"600px"},children:(0,i.jsxs)("div",{className:"datamachine-modal-content",children:[g&&(0,i.jsx)(d.Notice,{status:"error",isDismissible:!0,onRemove:()=>_(null),children:(0,i.jsx)("p",{children:g})}),y&&(0,i.jsx)(d.Notice,{status:"success",isDismissible:!0,onRemove:()=>j(null),children:(0,i.jsx)("p",{children:y})}),(0,i.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"},children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:(0,r.__)("Handler:","datamachine")})," ",l.label||a]}),(0,i.jsx)(le,{connected:o})]}),(0,i.jsx)("p",{style:{margin:0,fontSize:"13px",color:"#757575"},children:"oauth2"===b?(0,r.__)('Click "Connect Account" to authorize access via OAuth.',"datamachine"):(0,r.__)("Enter your API credentials to connect.","datamachine")})]}),!o&&(0,i.jsx)(i.Fragment,{children:"oauth2"===b?(0,i.jsx)("div",{style:{marginBottom:"16px"},children:(0,i.jsx)(re,{oauthUrl:w,onSuccess:e=>{c(!0),h(e),j((0,r.__)("Account connected successfully!","datamachine")),_(null),s&&s()},onError:e=>{_(e),j(null)},disabled:x})}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(oe,{config:u,onChange:m,fields:l.auth_fields||[]}),(0,i.jsx)("div",{style:{marginTop:"16px"},children:(0,i.jsx)(d.Button,{variant:"primary",onClick:async()=>{f(!0),_(null),j(null);try{await new Promise(e=>setTimeout(e,1e3)),c(!0),h({api_key:u.api_key}),j((0,r.__)("Credentials saved successfully!","datamachine")),s&&s()}catch(e){console.error("Save error:",e),_(e.message||(0,r.__)("Failed to save credentials","datamachine"))}finally{f(!1)}},disabled:x,isBusy:x,children:x?(0,r.__)("Saving...","datamachine"):(0,r.__)("Save Credentials","datamachine")})})]})}),o&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(se,{account:p}),(0,i.jsx)("div",{style:{marginTop:"16px"},children:(0,i.jsx)(d.Button,{variant:"secondary",onClick:async()=>{if(confirm((0,r.__)("Are you sure you want to disconnect this account?","datamachine"))){f(!0),_(null),j(null);try{await new Promise(e=>setTimeout(e,1e3)),c(!1),h(null),m({}),j((0,r.__)("Account disconnected successfully!","datamachine"))}catch(e){console.error("Disconnect error:",e),_(e.message||(0,r.__)("Failed to disconnect account","datamachine"))}finally{f(!1)}}},disabled:x,isBusy:x,style:{color:"#dc3232"},children:x?(0,r.__)("Disconnecting...","datamachine"):(0,r.__)("Disconnect Account","datamachine")})})]}),(0,i.jsx)("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"},children:(0,i.jsx)(d.Button,{variant:"secondary",onClick:t,disabled:x,children:(0,r.__)("Close","datamachine")})})]})}):null}function ce({flow:e,pipelineSteps:t,pipelineConfig:a}){const{refreshData:l,openModal:s,closeModal:c,activeModal:p,modalData:h}=o(),[m,x]=(0,n.useState)(null),[f,g]=(0,n.useState)(null);if(!e)return null;const y=(0,n.useCallback)(()=>{l()},[l]),w=(0,n.useCallback)(async e=>{try{const n=await(async e=>await u(`/flows/${e}`,{method:"DELETE"}))(e);n.success?l():alert(n.message||(0,r.__)("Failed to delete flow","datamachine"))}catch(e){console.error("Flow deletion error:",e),alert((0,r.__)("An error occurred while deleting the flow","datamachine"))}},[l]),C=(0,n.useCallback)(async e=>{try{const n=await(async e=>await u(`/flows/${e}/duplicate`,{method:"POST"}))(e);n.success?l():alert(n.message||(0,r.__)("Failed to duplicate flow","datamachine"))}catch(e){console.error("Flow duplication error:",e),alert((0,r.__)("An error occurred while duplicating the flow","datamachine"))}},[l]),S=(0,n.useCallback)(async e=>{try{const n=await(async e=>await u(`/flows/${e}/execute`,{method:"POST",data:{trigger_type:"manual"}}))(e);n.success?(alert((0,r.__)("Flow started successfully!","datamachine")),l()):alert(n.message||(0,r.__)("Failed to run flow","datamachine"))}catch(e){console.error("Flow execution error:",e),alert((0,r.__)("An error occurred while running the flow","datamachine"))}},[l]),k=(0,n.useCallback)(n=>{s(b,{flowId:n,flowName:e.flow_name,currentInterval:e.scheduling_config?.interval||"manual"})},[e.flow_name,e.scheduling_config,s]),T=(0,n.useCallback)(n=>{const a=e.flow_config?.[n]||{},i=a.pipeline_step_id,l=t.find(e=>e.pipeline_step_id===i),o={flowStepId:n,handlerSlug:a.handler_slug||"",stepType:l?.step_type||a.step_type,pipelineId:e.pipeline_id,flowId:e.flow_id,currentSettings:a.handler_config||{}};x(o),a.handler_slug?s(j,o):s(_,{stepType:o.stepType})},[e.flow_config,e.pipeline_id,e.flow_id,t,s]),N=(0,n.useCallback)(e=>{const n={...m,handlerSlug:e,currentSettings:{}};x(n),s(j,n)},[m,s]),B=(0,n.useCallback)(()=>{s(_,{stepType:m?.stepType})},[m,s]),A=(0,n.useCallback)((e,n)=>{g({handlerSlug:e,handlerInfo:n}),s(v)},[s]);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(d.Card,{className:"datamachine-flow-card datamachine-flow-instance-card",size:"large",children:(0,i.jsxs)(d.CardBody,{children:[(0,i.jsx)(M,{flowId:e.flow_id,flowName:e.flow_name,onNameChange:y,onDelete:w,onDuplicate:C,onRun:S,onSchedule:k}),(0,i.jsx)(d.CardDivider,{}),(0,i.jsx)($,{flowId:e.flow_id,flowConfig:e.flow_config||{},pipelineSteps:t,pipelineConfig:a,onStepConfigured:T}),(0,i.jsx)(d.CardDivider,{}),(0,i.jsx)(W,{schedulingConfig:e.scheduling_config||{}})]})}),p===b&&(0,i.jsx)(V,{isOpen:!0,onClose:c,...h,onSuccess:()=>{c(),l()}}),p===_&&(0,i.jsx)(X,{isOpen:!0,onClose:c,...h,onSelectHandler:N}),p===j&&(0,i.jsx)(Z,{isOpen:!0,onClose:c,...h,onSuccess:()=>{c(),l(),x(null)},onChangeHandler:B,onOAuthConnect:A}),p===v&&(0,i.jsx)(de,{isOpen:!0,onClose:c,handlerSlug:f?.handlerSlug,handlerInfo:f?.handlerInfo,onSuccess:()=>{c(),l(),g(null)}})]})}function pe({pipelineId:e,onAddFlow:n}){return(0,i.jsxs)("div",{className:"datamachine-empty-flow-card",style:{border:"2px dashed #dcdcde",borderRadius:"4px",padding:"40px 20px",textAlign:"center",backgroundColor:"#f9f9f9",minWidth:"300px",marginBottom:"20px"},children:[(0,i.jsx)("div",{style:{fontSize:"48px",color:"#c3c4c7",marginBottom:"16px"},children:"+"}),(0,i.jsx)(d.Button,{variant:"secondary",onClick:()=>n&&n(e),children:(0,r.__)("Add Flow","datamachine")})]})}function he({pipelineId:e,flows:t,pipelineSteps:a,pipelineConfig:l}){const{refreshData:s}=o(),d=(0,n.useCallback)(async e=>{try{const n=(0,r.__)("New Flow","datamachine"),t=await(async(e,n)=>await u("/flows",{method:"POST",data:{pipeline_id:e,flow_name:n}}))(e,n);t.success?s():alert(t.message||(0,r.__)("Failed to create flow","datamachine"))}catch(e){console.error("Flow creation error:",e),alert((0,r.__)("An error occurred while creating the flow","datamachine"))}},[s]);return t&&0!==t.length?(0,i.jsxs)("div",{className:"datamachine-flows-section",children:[(0,i.jsx)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:(0,i.jsxs)("h3",{style:{margin:0},children:[(0,r.__)("Flows","datamachine")," ",(0,i.jsxs)("span",{style:{color:"#757575",fontSize:"14px",fontWeight:"normal"},children:["(",t.length,")"]})]})}),(0,i.jsxs)("div",{className:"datamachine-flows-list",style:{display:"flex",flexDirection:"column",gap:"20px"},children:[t.map(e=>(0,i.jsx)(ce,{flow:e,pipelineSteps:a,pipelineConfig:l},e.flow_id)),(0,i.jsx)(pe,{pipelineId:e,onAddFlow:d})]})]}):(0,i.jsxs)("div",{className:"datamachine-flows-section datamachine-flows-section--empty",children:[(0,i.jsx)("h3",{style:{marginTop:0,marginBottom:"16px"},children:(0,r.__)("Flows","datamachine")}),(0,i.jsx)("p",{style:{color:"#757575",marginBottom:"16px"},children:(0,r.__)("No flows configured. Add your first flow to get started.","datamachine")}),(0,i.jsx)(pe,{pipelineId:e,onAddFlow:d})]})}function ue({pipeline:e,flows:t}){const{refreshData:a,openModal:l,closeModal:s,activeModal:c,modalData:p}=o();if(!e)return null;const h=(0,n.useCallback)(e=>{a()},[a]),m=(0,n.useCallback)(e=>{a()},[a]),x=(0,n.useCallback)(n=>{const t=(e.pipeline_steps||[]).length+1;l(g,{pipelineId:n,nextExecutionOrder:t})},[e.pipeline_steps,l]),f=(0,n.useCallback)(async n=>{try{const t=await(async(e,n)=>await u(`/pipelines/${e}/steps/${n}`,{method:"DELETE"}))(e.pipeline_id,n);t.success?a():alert(t.message||(0,r.__)("Failed to delete step","datamachine"))}catch(e){console.error("Step deletion error:",e),alert((0,r.__)("An error occurred while deleting the step","datamachine"))}},[e.pipeline_id,a]),_=(0,n.useCallback)(n=>{const t=e.pipeline_config?.[n.pipeline_step_id]||{};l(y,{pipelineId:e.pipeline_id,pipelineStepId:n.pipeline_step_id,stepType:n.step_type,currentConfig:t})},[e.pipeline_id,e.pipeline_config,l]);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(d.Card,{className:"datamachine-pipeline-card",size:"large",children:(0,i.jsxs)(d.CardBody,{children:[(0,i.jsx)(S,{pipelineId:e.pipeline_id,pipelineName:e.pipeline_name,onNameChange:h,onDelete:m}),(0,i.jsx)(d.CardDivider,{}),(0,i.jsx)(z,{pipelineId:e.pipeline_id,steps:e.pipeline_steps||[],pipelineConfig:e.pipeline_config||{},onStepAdded:x,onStepRemoved:f,onStepConfigured:_}),(0,i.jsx)(d.CardDivider,{}),(0,i.jsx)(F,{pipelineId:e.pipeline_id}),(0,i.jsx)(d.CardDivider,{}),(0,i.jsx)(he,{pipelineId:e.pipeline_id,flows:t,pipelineSteps:e.pipeline_steps||[],pipelineConfig:e.pipeline_config||{}})]})}),c===g&&(0,i.jsx)(U,{isOpen:!0,onClose:s,...p,onSuccess:()=>{s(),a()}}),c===y&&(0,i.jsx)(J,{isOpen:!0,onClose:s,...p,onSuccess:()=>{s(),a()}})]})}function me(){const{selectedPipelineId:e,setSelectedPipelineId:n}=o(),{pipelines:t,loading:a}=x();if(a||0===t.length)return null;const l=t.map(e=>({label:e.pipeline_name||(0,r.__)("Untitled Pipeline","datamachine"),value:e.pipeline_id}));return(0,i.jsx)("div",{className:"datamachine-pipeline-selector-wrapper",style:{marginBottom:"20px"},children:(0,i.jsx)(d.SelectControl,{label:(0,r.__)("Select Pipeline","datamachine"),value:e||l[0]?.value||"",options:l,onChange:e=>{n(e)},className:"datamachine-pipeline-selector"})})}function xe(){const{selectedPipelineId:e,setSelectedPipelineId:t,refreshTrigger:a,openModal:l,closeModal:s,activeModal:c,modalData:p,refreshData:h}=o(),{pipelines:m,loading:f,error:g}=x(e),{flows:_,loading:y,error:j}=(e=>{const[t,a]=(0,n.useState)([]),[i,l]=(0,n.useState)(!0),[s,o]=(0,n.useState)(null),[r,d]=(0,n.useState)(0),c=(0,n.useCallback)(async()=>{if(e){l(!0),o(null);try{const n=await(async e=>await u(`/flows?pipeline_id=${e}`))(e);n.success?a(n.data||[]):o(n.message||"Failed to fetch flows")}catch(e){console.error("useFlows error:",e),o(e.message||"An error occurred")}finally{l(!1)}}else l(!1)},[e,r]),p=(0,n.useCallback)(()=>{d(e=>e+1)},[]);return(0,n.useEffect)(()=>{c()},[c]),{flows:t,loading:i,error:s,refetch:p}})(e),[b,v]=(0,n.useState)(!1);(0,n.useEffect)(()=>{m.length>0&&!e&&t(m[0].pipeline_id)},[m,e,t]);const C=(0,n.useCallback)(async()=>{v(!0);try{const e=await(async()=>await u("/pipelines",{method:"POST",data:{pipeline_name:"New Pipeline"}}))();e.success&&e.data.pipeline_id&&(t(e.data.pipeline_id),h())}catch(e){console.error("Error creating pipeline:",e)}finally{v(!1)}},[t,h]);if(f||y)return(0,i.jsxs)("div",{className:"datamachine-pipelines-loading",children:[(0,i.jsx)(d.Spinner,{}),(0,i.jsx)("p",{children:(0,r.__)("Loading pipelines...","datamachine")})]});if(g||j)return(0,i.jsx)(d.Notice,{status:"error",isDismissible:!1,children:(0,i.jsx)("p",{children:g||j})});if(0===m.length)return(0,i.jsx)(d.Notice,{status:"info",isDismissible:!1,children:(0,i.jsx)("p",{children:(0,r.__)("No pipelines found. Create a pipeline to get started.","datamachine")})});const S=m.find(n=>n.pipeline_id===e)||m[0];return(0,i.jsxs)("div",{className:"datamachine-pipelines-react-app",children:[(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"20px"},children:[(0,i.jsx)(d.Button,{variant:"primary",onClick:C,disabled:b,isBusy:b,children:(0,r.__)("Add New Pipeline","datamachine")}),(0,i.jsx)(d.Button,{variant:"secondary",onClick:()=>l(w),children:(0,r.__)("Import / Export","datamachine")})]}),(0,i.jsx)(me,{}),(0,i.jsx)(ue,{pipeline:S,flows:_}),c===w&&(0,i.jsx)(ie,{isOpen:!0,onClose:s,pipelines:m,onSuccess:()=>{s(),h()}})]})}a()(()=>{const e=document.getElementById("datamachine-react-root");e?window.dataMachineConfig?(0,n.render)((0,i.jsx)(s,{children:(0,i.jsx)(xe,{})}),e):console.error("Data Machine: Configuration not found"):console.error("Data Machine: React root element not found")})})();