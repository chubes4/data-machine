(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var n in a)e.o(a,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:a[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,a=window.wp.element,n=window.wp.domReady;var l=e.n(n);const i=(0,a.createContext)();function o({children:e}){const[n,l]=(0,a.useState)(null),[o,r]=(0,a.useState)([]),[c,s]=(0,a.useState)([]),[d,p]=(0,a.useState)(0),[m,u]=(0,a.useState)(null),[f,h]=(0,a.useState)(null);(0,a.useEffect)(()=>{n&&localStorage.setItem("datamachine_selected_pipeline",n)},[n]),(0,a.useEffect)(()=>{const e=localStorage.getItem("datamachine_selected_pipeline");e&&!n&&l(e)},[]),(0,a.useEffect)(()=>{const e=new URL(window.location).searchParams.get("selected_pipeline_id");e&&l(e)},[]),(0,a.useEffect)(()=>{if(n){const e=new URL(window.location);e.searchParams.set("selected_pipeline_id",n),window.history.replaceState(null,null,e)}},[n]);const g=(0,a.useCallback)(()=>{p(e=>e+1)},[]),_=(0,a.useCallback)((e,t=null)=>{u(e),h(t)},[]),y=(0,a.useCallback)(()=>{u(null),h(null)},[]),x={selectedPipelineId:n,setSelectedPipelineId:l,pipelines:o,setPipelines:r,flows:c,setFlows:s,refreshData:g,refreshTrigger:d,activeModal:m,modalData:f,openModal:_,closeModal:y};return(0,t.createElement)(i.Provider,{value:x},e)}function r(){const e=(0,a.useContext)(i);if(!e)throw new Error("usePipelineContext must be used within PipelineProvider");return e}const c=window.wp.i18n,s=window.wp.components,d=window.wp.apiFetch;var p=e.n(d);const m=()=>{const e=window.dataMachineConfig||{};return{restNamespace:e.restNamespace||"datamachine/v1",restNonce:e.restNonce||""}},u=async(e,t={})=>{const a=m();try{const n=await p()({path:`/${a.restNamespace}${e}`,method:t.method||"GET",data:t.data||void 0,headers:{"X-WP-Nonce":a.restNonce}});return{success:!0,data:n,message:n.message||""}}catch(e){return console.error("API Request Error:",e),{success:!1,data:null,message:e.message||"An error occurred"}}},f=async(e,t,a,n,l,i=[])=>await u(`/pipelines/${e}/steps/${t}/config`,{method:"PUT",data:{ai_provider:n,ai_model:l,system_prompt:a,enabled_tools:i}}),h=(e=null)=>{const[t,n]=(0,a.useState)([]),[l,i]=(0,a.useState)(!0),[o,r]=(0,a.useState)(null),[c,s]=(0,a.useState)(0),d=(0,a.useCallback)(async()=>{i(!0),r(null);try{const t=await(async(e=null)=>{const t=e?`/pipelines/${e}`:"/pipelines";return await u(t)})(e);if(t.success){const e=Array.isArray(t.data)?t.data:[t.data];n(e)}else r(t.message||"Failed to fetch pipelines")}catch(e){console.error("usePipelines error:",e),r(e.message||"An error occurred")}finally{i(!1)}},[e,c]),p=(0,a.useCallback)(()=>{s(e=>e+1)},[]);return(0,a.useEffect)(()=>{d()},[d]),{pipelines:t,loading:l,error:o,refetch:p}},g=[{value:"manual",label:"Manual only"},{value:"hourly",label:"Every hour"},{value:"twicedaily",label:"Twice daily"},{value:"daily",label:"Daily"},{value:"weekly",label:"Weekly"}],_="step-selection",y="handler-selection",x="configure-step",E="handler-settings",b="flow-schedule",w="import-export",v="oauth",C=500;function S({pipelineId:e,pipelineName:n,onNameChange:l,onDelete:i}){const[o,r]=(0,a.useState)(n),d=(0,a.useRef)(null);(0,a.useEffect)(()=>{r(n)},[n]);const p=(0,a.useCallback)(async t=>{if(t&&t!==n)try{const a=await(async(e,t)=>await u(`/pipelines/${e}`,{method:"PATCH",data:{pipeline_name:t}}))(e,t);a.success&&l&&l(t)}catch(e){console.error("Pipeline title save failed:",e)}},[e,n,l]),m=(0,a.useCallback)(e=>{r(e),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{p(e)},C)},[p]),f=(0,a.useCallback)(async()=>{if(window.confirm((0,c.__)("Are you sure you want to delete this pipeline? This action cannot be undone.","data-machine")))try{const t=await(async e=>await u(`/pipelines/${e}`,{method:"DELETE"}))(e);t.success&&i&&i(e)}catch(e){console.error("Pipeline deletion error:",e)}},[e,i]);return(0,a.useEffect)(()=>()=>{d.current&&clearTimeout(d.current)},[]),(0,t.createElement)("div",{className:"datamachine-pipeline-header"},(0,t.createElement)("div",{style:{display:"flex",alignItems:"center",gap:"12px"}},(0,t.createElement)("div",{style:{flex:1}},(0,t.createElement)(s.TextControl,{value:o,onChange:m,placeholder:(0,c.__)("Pipeline name","data-machine"),className:"datamachine-pipeline-name-input",style:{fontSize:"20px",fontWeight:"600"}})),(0,t.createElement)(s.Button,{isDestructive:!0,variant:"secondary",onClick:f,icon:"trash",label:(0,c.__)("Delete Pipeline","data-machine")})))}const k=e=>{if(!e||"0000-00-00 00:00:00"===e)return(0,c.__)("Never","data-machine");try{const t=new Date(e),a=new Date-t,n=Math.floor(a/6e4),l=Math.floor(a/36e5),i=Math.floor(a/864e5);return n<1?(0,c.__)("Just now","data-machine"):n<60?`${n} ${(0,c.__)("minutes ago","data-machine")}`:l<24?`${l} ${(0,c.__)("hours ago","data-machine")}`:i<7?`${i} ${(0,c.__)("days ago","data-machine")}`:t.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(t){return console.error("Date formatting error:",t),e}},T=e=>e?e.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "):"",N=e=>({fetch:{icon:"â­³",color:"#0073aa",label:(0,c.__)("Fetch","data-machine")},ai:{icon:"âœ¨",color:"#826eb4",label:(0,c.__)("AI Process","data-machine")},publish:{icon:"âœ”",color:"#46b450",label:(0,c.__)("Publish","data-machine")},update:{icon:"â™»",color:"#f0b849",label:(0,c.__)("Update","data-machine")}}[e]||{icon:"â€¢",color:"#999",label:T(e)});function B({stepType:e,size:a=24}){const n=N(e);return(0,t.createElement)("span",{className:`datamachine-step-icon datamachine-step-icon--${e}`,style:{fontSize:`${a}px`,color:n.color,lineHeight:1,display:"inline-block"},title:n.label,"aria-label":n.label},n.icon)}function A({step:e,pipelineId:n,pipelineConfig:l,onDelete:i,onConfigure:o}){const r="ai"===e.step_type?l[e.pipeline_step_id]:null,[d,p]=(0,a.useState)(r?.system_prompt||""),[m,u]=(0,a.useState)(!1),[h,g]=(0,a.useState)(null),_=(0,a.useRef)(null);(0,a.useEffect)(()=>{r&&p(r.system_prompt||"")},[r]);const y=(0,a.useCallback)(async t=>{if(!r)return;const a=r.system_prompt||"";if(t!==a){u(!0),g(null);try{const l=await f(n,e.pipeline_step_id,t,r.ai_provider,r.ai_model);l.success||(g(l.message||(0,c.__)("Failed to update prompt","data-machine")),p(a))}catch(e){console.error("Prompt update error:",e),g(e.message||(0,c.__)("An error occurred","data-machine")),p(a)}finally{u(!1)}}},[n,e.pipeline_step_id,r]),x=(0,a.useCallback)(e=>{p(e),_.current&&clearTimeout(_.current),_.current=setTimeout(()=>{y(e)},C)},[y]),E=(0,a.useCallback)(()=>{window.confirm((0,c.__)("Are you sure you want to remove this step?","data-machine"))&&i&&i(e.pipeline_step_id)},[e.pipeline_step_id,i]);return(0,a.useEffect)(()=>()=>{_.current&&clearTimeout(_.current)},[]),(0,t.createElement)(s.Card,{className:`datamachine-pipeline-step-card datamachine-step-type--${e.step_type}`,size:"small"},(0,t.createElement)(s.CardBody,null,h&&(0,t.createElement)(s.Notice,{status:"error",isDismissible:!0,onRemove:()=>g(null)},h),(0,t.createElement)("div",{style:{marginBottom:"12px"}},(0,t.createElement)("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"}},(0,t.createElement)(B,{stepType:e.step_type,size:20}),(0,t.createElement)("strong",null,e.label||T(e.step_type)),(0,t.createElement)("span",{style:{color:"#757575",fontSize:"12px"}},"(Order: ",e.execution_order,")")),r&&(0,t.createElement)("div",{className:"datamachine-ai-config-display",style:{marginTop:"12px"}},(0,t.createElement)("div",{style:{fontSize:"12px",color:"#757575",marginBottom:"8px"}},(0,t.createElement)("strong",null,(0,c.__)("AI Provider:","data-machine"))," ",r.ai_provider||"Not configured"," | ",(0,t.createElement)("strong",null,(0,c.__)("Model:","data-machine"))," ",r.ai_model||"Not configured"),(0,t.createElement)(s.TextareaControl,{label:(0,c.__)("System Prompt","data-machine"),value:d,onChange:x,placeholder:(0,c.__)("Enter system prompt for AI processing...","data-machine"),rows:6,help:m?(0,c.__)("Saving...","data-machine"):null}))),(0,t.createElement)("div",{style:{display:"flex",gap:"8px",justifyContent:"flex-end"}},(0,t.createElement)(s.Button,{variant:"secondary",size:"small",onClick:()=>o&&o(e)},(0,c.__)("Configure","data-machine")),(0,t.createElement)(s.Button,{variant:"secondary",size:"small",isDestructive:!0,onClick:E},(0,c.__)("Delete","data-machine")))))}function I({pipelineId:e,onAddStep:a}){return(0,t.createElement)("div",{className:"datamachine-empty-step-card",style:{border:"2px dashed #dcdcde",borderRadius:"4px",padding:"40px 20px",textAlign:"center",backgroundColor:"#f9f9f9",minWidth:"200px"}},(0,t.createElement)("div",{style:{fontSize:"48px",color:"#c3c4c7",marginBottom:"16px"}},"+"),(0,t.createElement)(s.Button,{variant:"secondary",onClick:()=>a&&a(e)},(0,c.__)("Add Step","data-machine")))}function D(){return(0,t.createElement)("div",{className:"datamachine-data-flow-arrow",style:{display:"flex",alignItems:"center",padding:"0 10px"}},(0,t.createElement)("svg",{width:"40",height:"20",viewBox:"0 0 40 20",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true"},(0,t.createElement)("path",{d:"M0 10 L30 10 L25 5 M30 10 L25 15",stroke:"#8c8f94",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})))}function z({pipelineId:e,steps:n,pipelineConfig:l,onStepAdded:i,onStepRemoved:o,onStepConfigured:r}){const s=(0,a.useMemo)(()=>n&&Array.isArray(n)?[...n].sort((e,t)=>(e.execution_order||0)-(t.execution_order||0)):[],[n]),[d,p]=(0,a.useState)(null);return 0===s.length?(0,t.createElement)("div",{className:"datamachine-pipeline-steps-empty",style:{padding:"20px",textAlign:"center"}},(0,t.createElement)("p",{style:{color:"#757575",marginBottom:"16px"}},(0,c.__)("No steps configured. Add your first step to get started.","data-machine")),(0,t.createElement)(I,{pipelineId:e,onAddStep:i})):(0,t.createElement)("div",{className:"datamachine-pipeline-steps",style:{display:"flex",alignItems:"stretch",gap:"0",overflowX:"auto",padding:"20px 0"}},s.map((a,n)=>(0,t.createElement)("div",{key:a.pipeline_step_id,style:{display:"flex",alignItems:"stretch"},draggable:!0,onDragStart:()=>p(n),onDragOver:e=>e.preventDefault(),onDrop:()=>(async t=>{if(null===d||d===t)return void p(null);const a=[...s],[n]=a.splice(d,1);a.splice(t,0,n);try{await(async(e,t)=>{const a=t.map((e,t)=>({pipeline_step_id:e.pipeline_step_id,execution_order:t}));return await u(`/pipelines/${e}/steps/reorder`,{method:"PUT",data:{step_order:a}})})(e,a)}catch(e){console.error("Failed to reorder steps:",e)}p(null)})(n),className:d===n?"datamachine-step-dragging":""},(0,t.createElement)("div",{style:{flex:"0 0 auto",minWidth:"300px"}},(0,t.createElement)(A,{step:a,pipelineId:e,pipelineConfig:l,onDelete:o,onConfigure:r})),n<s.length-1&&(0,t.createElement)(D,null))),(0,t.createElement)(D,null),(0,t.createElement)("div",{style:{flex:"0 0 auto"}},(0,t.createElement)(I,{pipelineId:e,onAddStep:i})))}function P({onFileSelected:e,allowedTypes:n=["pdf","csv","txt","json"],maxSizeMB:l=10,disabled:i=!1,uploadText:o=null}){const[r,d]=(0,a.useState)(!1),[p,m]=(0,a.useState)(null),u=(0,a.useRef)(null),f=()=>n.map(e=>e.toUpperCase()).join(", "),h=t=>{const a=t.name.split(".").pop().toLowerCase();if(!n.includes(a))return void m((0,c.__)(`Please select a valid file. Allowed types: ${f()}`,"data-machine"));const i=1024*l*1024;t.size>i?m((0,c.__)(`File size exceeds ${l}MB limit.`,"data-machine")):e&&(e(t),m(null))},g=()=>{u.current&&u.current.click()},_=(0,c.__)("Drag and drop file here","data-machine");return(0,t.createElement)("div",null,(0,t.createElement)("div",{onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),i||d(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),d(!1)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDrop:e=>{if(e.preventDefault(),e.stopPropagation(),d(!1),i)return;const t=e.dataTransfer.files;t.length>0&&h(t[0])},style:{border:"2px dashed "+(r?"#0073aa":"#dcdcde"),borderRadius:"4px",padding:"40px 20px",textAlign:"center",background:r?"#f0f6fc":"#f9f9f9",transition:"all 0.2s",cursor:i?"not-allowed":"pointer",opacity:i?.6:1},onClick:i?void 0:g},(0,t.createElement)("div",{style:{marginBottom:"16px",fontSize:"48px",color:"#757575"}},"ðŸ“"),(0,t.createElement)("p",{style:{margin:"0 0 8px 0",fontSize:"16px",fontWeight:"500"}},o||_),(0,t.createElement)("p",{style:{margin:"0 0 12px 0",color:"#757575",fontSize:"13px"}},(0,c.__)(`Allowed: ${f()} (max ${l}MB)`,"data-machine")),(0,t.createElement)("p",{style:{margin:"0 0 16px 0",color:"#757575",fontSize:"14px"}},(0,c.__)("or","data-machine")),(0,t.createElement)(s.Button,{variant:"secondary",onClick:g,disabled:i},(0,c.__)("Browse Files","data-machine")),(0,t.createElement)("input",{ref:u,type:"file",accept:n.map(e=>`.${e}`).join(","),onChange:e=>{const t=e.target.files;t.length>0&&h(t[0])},style:{display:"none"},disabled:i})),p&&(0,t.createElement)("div",{style:{marginTop:"12px",padding:"8px 12px",background:"#fef7f7",border:"1px solid #dc3232",borderRadius:"4px",color:"#dc3232",fontSize:"13px"}},p))}function R({files:e=[],onDelete:n,isDeleting:l=!1}){const[i,o]=(0,a.useState)(null);return 0===e.length?(0,t.createElement)("div",{style:{padding:"40px 20px",textAlign:"center",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"}},(0,t.createElement)("p",{style:{margin:0,color:"#757575"}},(0,c.__)("No context files uploaded yet.","data-machine"))):(0,t.createElement)("div",{style:{border:"1px solid #dcdcde",borderRadius:"4px",maxHeight:"400px",overflowY:"auto"}},(0,t.createElement)("table",{style:{width:"100%",borderCollapse:"collapse"}},(0,t.createElement)("thead",null,(0,t.createElement)("tr",{style:{background:"#f9f9f9",borderBottom:"1px solid #dcdcde",position:"sticky",top:0,zIndex:1}},(0,t.createElement)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600"}},(0,c.__)("File Name","data-machine")),(0,t.createElement)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600",width:"100px"}},(0,c.__)("Size","data-machine")),(0,t.createElement)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600",width:"180px"}},(0,c.__)("Uploaded","data-machine")),(0,t.createElement)("th",{style:{padding:"12px 16px",textAlign:"center",fontWeight:"600",width:"100px"}},(0,c.__)("Actions","data-machine")))),(0,t.createElement)("tbody",null,e.map(e=>{const a=i===e.file_id;return(0,t.createElement)("tr",{key:e.file_id,style:{borderBottom:"1px solid #dcdcde"}},(0,t.createElement)("td",{style:{padding:"12px 16px",fontWeight:"500"}},e.file_name),(0,t.createElement)("td",{style:{padding:"12px 16px",color:"#757575"}},(e=>{if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]})(e.file_size)),(0,t.createElement)("td",{style:{padding:"12px 16px",color:"#757575",fontSize:"13px"}},(e=>{const t=new Date(e);return t.toLocaleDateString()+" "+t.toLocaleTimeString()})(e.uploaded_at)),(0,t.createElement)("td",{style:{padding:"12px 16px",textAlign:"center"}},(0,t.createElement)(s.Button,{variant:"link",onClick:()=>(async e=>{o(e),n&&await n(e),o(null)})(e.file_id),disabled:l||a,isBusy:a,style:{color:"#dc3232"}},a?(0,c.__)("Deleting...","data-machine"):(0,c.__)("Delete","data-machine"))))}))))}function F({pipelineId:e}){const[n,l]=(0,a.useState)([]),[i,o]=(0,a.useState)(!0),[r,d]=(0,a.useState)(!1),[p,f]=(0,a.useState)(!1),[h,g]=(0,a.useState)(null),[_,y]=(0,a.useState)(null),x=async()=>{o(!0),g(null);try{const t=await(async e=>await u(`/pipelines/${e}/context-files`))(e);t.success?l(t.data||[]):g(t.message||(0,c.__)("Failed to load context files","data-machine"))}catch(e){console.error("Load files error:",e),g(e.message||(0,c.__)("An error occurred while loading files","data-machine"))}finally{o(!1)}};return(0,a.useEffect)(()=>{e&&x()},[e]),(0,t.createElement)("div",{className:"datamachine-pipeline-context-files"},(0,t.createElement)("div",{style:{marginBottom:"16px"}},(0,t.createElement)("h3",{style:{margin:"0 0 8px 0",fontSize:"16px",fontWeight:"600"}},(0,c.__)("Context Files","data-machine")),(0,t.createElement)("p",{style:{margin:0,color:"#757575",fontSize:"13px"}},(0,c.__)("Upload files for AI context retrieval during pipeline execution.","data-machine"))),h&&(0,t.createElement)(s.Notice,{status:"error",isDismissible:!0,onRemove:()=>g(null)},(0,t.createElement)("p",null,h)),_&&(0,t.createElement)(s.Notice,{status:"success",isDismissible:!0,onRemove:()=>y(null)},(0,t.createElement)("p",null,_)),(0,t.createElement)("div",{style:{marginBottom:"24px"}},(0,t.createElement)(P,{onFileSelected:async t=>{d(!0),g(null),y(null);try{const a=await(async(e,t)=>{const a=m(),n=new FormData;n.append("file",t);try{const t=await fetch(`/wp-json/${a.restNamespace}/pipelines/${e}/context-files`,{method:"POST",headers:{"X-WP-Nonce":a.restNonce},body:n}),l=await t.json();if(!t.ok)throw new Error(l.message||"Upload failed");return{success:!0,data:l,message:l.message||""}}catch(e){return console.error("Upload error:",e),{success:!1,data:null,message:e.message||"An error occurred during upload"}}})(e,t);a.success?(y((0,c.__)("File uploaded successfully!","data-machine")),await x()):g(a.message||(0,c.__)("Failed to upload file","data-machine"))}catch(e){console.error("Upload error:",e),g(e.message||(0,c.__)("An error occurred during upload","data-machine"))}finally{d(!1)}},allowedTypes:["pdf","csv","txt","json"],maxSizeMB:10,disabled:r||i,uploadText:r?(0,c.__)("Uploading...","data-machine"):null})),i?(0,t.createElement)("div",{style:{textAlign:"center",padding:"20px",color:"#757575"}},(0,c.__)("Loading files...","data-machine")):(0,t.createElement)(R,{files:n,onDelete:async t=>{f(!0),g(null),y(null);try{const a=await(async(e,t)=>await u(`/pipelines/${e}/context-files/${t}`,{method:"DELETE"}))(e,t);a.success?(y((0,c.__)("File deleted successfully!","data-machine")),await x()):g(a.message||(0,c.__)("Failed to delete file","data-machine"))}catch(e){console.error("Delete error:",e),g(e.message||(0,c.__)("An error occurred during deletion","data-machine"))}finally{f(!1)}},isDeleting:p}))}function M({flowId:e,flowName:n,onNameChange:l,onDelete:i,onDuplicate:o,onRun:r,onSchedule:d}){const[p,m]=(0,a.useState)(n),f=(0,a.useRef)(null);(0,a.useEffect)(()=>{m(n)},[n]);const h=(0,a.useCallback)(async t=>{if(t&&t!==n)try{const a=await(async(e,t)=>await u(`/flows/${e}`,{method:"PATCH",data:{flow_name:t}}))(e,t);a.success&&l&&l(e,t)}catch(e){console.error("Flow title save failed:",e)}},[e,n,l]),g=(0,a.useCallback)(e=>{m(e),f.current&&clearTimeout(f.current),f.current=setTimeout(()=>{h(e)},C)},[h]),_=(0,a.useCallback)(()=>{window.confirm((0,c.__)("Are you sure you want to delete this flow?","data-machine"))&&i&&i(e)},[e,i]);return(0,a.useEffect)(()=>()=>{f.current&&clearTimeout(f.current)},[]),(0,t.createElement)("div",{className:"datamachine-flow-header"},(0,t.createElement)("div",{style:{display:"flex",alignItems:"center",gap:"12px",marginBottom:"16px"}},(0,t.createElement)("div",{style:{flex:1}},(0,t.createElement)(s.TextControl,{value:p,onChange:g,placeholder:(0,c.__)("Flow name...","data-machine"),style:{fontSize:"16px",fontWeight:"500"}})),(0,t.createElement)("div",{className:"datamachine-flow-actions",style:{display:"flex",gap:"8px"}},(0,t.createElement)(s.Button,{variant:"primary",onClick:()=>r&&r(e)},(0,c.__)("Run Now","data-machine")),(0,t.createElement)(s.Button,{variant:"secondary",onClick:()=>d&&d(e)},(0,c.__)("Schedule","data-machine")),(0,t.createElement)(s.Button,{variant:"secondary",onClick:()=>o&&o(e)},(0,c.__)("Duplicate","data-machine")),(0,t.createElement)(s.Button,{variant:"secondary",isDestructive:!0,onClick:_,icon:"trash"}))))}function O({handlerSlug:e,handlerConfig:a,stepType:n,onConfigure:l}){if(!e)return(0,t.createElement)("div",{className:"datamachine-flow-step-handler datamachine-flow-step-handler--empty",style:{padding:"12px",backgroundColor:"#fff3cd",border:"1px solid #ffc107",borderRadius:"4px",marginTop:"12px"}},(0,t.createElement)("p",{style:{margin:"0 0 8px 0",fontSize:"12px",color:"#856404"}},(0,c.__)("No handler configured","data-machine")),(0,t.createElement)(s.Button,{variant:"secondary",size:"small",onClick:l},(0,c.__)("Configure Handler","data-machine")));const i=a&&Object.keys(a).length>0;return(0,t.createElement)("div",{className:"datamachine-flow-step-handler",style:{marginTop:"12px"}},(0,t.createElement)("div",{className:"datamachine-handler-tag",style:{display:"inline-block",padding:"4px 12px",backgroundColor:"#0073aa",color:"#ffffff",borderRadius:"3px",fontSize:"11px",fontWeight:"500",marginBottom:"8px"}},T(e)),i&&(0,t.createElement)("div",{className:"datamachine-handler-settings-display",style:{padding:"8px 12px",backgroundColor:"#f6f7f7",border:"1px solid #dcdcde",borderRadius:"4px",fontSize:"12px",marginBottom:"8px"}},Object.entries(a).map(([e,a])=>(0,t.createElement)("div",{key:e,style:{marginBottom:"4px"}},(0,t.createElement)("strong",null,T(e),":")," ","object"==typeof a?JSON.stringify(a):String(a)))),(0,t.createElement)(s.Button,{variant:"secondary",size:"small",onClick:l},(0,c.__)("Configure","data-machine")))}function $({flowId:e,flowStepId:n,flowStepConfig:l,pipelineStep:i,pipelineConfig:o,onConfigure:r}){const d="ai"===i.step_type,p=d?o[i.pipeline_step_id]:null,[m,f]=(0,a.useState)(l.user_message||""),[h,g]=(0,a.useState)(!1),[_,y]=(0,a.useState)(null),x=(0,a.useRef)(null);(0,a.useEffect)(()=>{f(l.user_message||"")},[l.user_message]);const E=(0,a.useCallback)(async t=>{if(!d)return;const a=l.user_message||"";if(t!==a){g(!0),y(null);try{const l=await(async(e,t,a)=>await u(`/flows/${e}/steps/${t}/message`,{method:"PUT",data:{user_message:a}}))(e,n,t);l.success||(y(l.message||(0,c.__)("Failed to update user message","data-machine")),f(a))}catch(e){console.error("User message update error:",e),y(e.message||(0,c.__)("An error occurred","data-machine")),f(a)}finally{g(!1)}}},[e,n,l.user_message,d]),b=(0,a.useCallback)(e=>{f(e),x.current&&clearTimeout(x.current),x.current=setTimeout(()=>{E(e)},C)},[E]);return(0,a.useEffect)(()=>()=>{x.current&&clearTimeout(x.current)},[]),(0,t.createElement)(s.Card,{className:`datamachine-flow-step-card datamachine-step-type--${i.step_type}`,size:"small"},(0,t.createElement)(s.CardBody,null,_&&(0,t.createElement)(s.Notice,{status:"error",isDismissible:!0,onRemove:()=>y(null)},_),(0,t.createElement)("div",{style:{marginBottom:"12px"}},(0,t.createElement)("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"}},(0,t.createElement)(B,{stepType:i.step_type,size:20}),(0,t.createElement)("strong",null,i.label||T(i.step_type)),(0,t.createElement)("span",{style:{color:"#757575",fontSize:"12px"}},"(Order: ",l.execution_order,")")),d&&p&&(0,t.createElement)("div",{className:"datamachine-ai-config-display",style:{marginTop:"12px"}},(0,t.createElement)("div",{style:{fontSize:"12px",color:"#757575",marginBottom:"8px"}},(0,t.createElement)("strong",null,(0,c.__)("AI Provider:","data-machine"))," ",p.ai_provider||"Not configured"," | ",(0,t.createElement)("strong",null,(0,c.__)("Model:","data-machine"))," ",p.ai_model||"Not configured"),(0,t.createElement)(s.TextareaControl,{label:(0,c.__)("User Message","data-machine"),value:m,onChange:b,placeholder:(0,c.__)("Enter user message for AI processing...","data-machine"),rows:4,help:h?(0,c.__)("Saving...","data-machine"):null})),(0,t.createElement)(O,{handlerSlug:l.handler_slug,handlerConfig:l.handler_config||{},stepType:i.step_type,onConfigure:()=>r&&r(n)}))))}function W({flowId:e,flowConfig:n,pipelineSteps:l,pipelineConfig:i,onStepConfigured:o}){const r=(0,a.useMemo)(()=>n&&l&&Array.isArray(l)?Object.entries(n).map(([e,t])=>({flowStepId:e,...t})).sort((e,t)=>(e.execution_order||0)-(t.execution_order||0)).map(e=>{const t=l.find(t=>t.pipeline_step_id===e.pipeline_step_id);return{flowStepId:e.flowStepId,flowStepConfig:e,pipelineStep:t||{pipeline_step_id:e.pipeline_step_id,step_type:e.step_type,label:"Unknown Step"}}}):[],[n,l]);return 0===r.length?(0,t.createElement)("div",{className:"datamachine-flow-steps-empty",style:{padding:"20px",textAlign:"center",backgroundColor:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"}},(0,t.createElement)("p",{style:{color:"#757575",margin:0}},(0,c.__)("No steps configured for this flow.","data-machine"))):(0,t.createElement)("div",{className:"datamachine-flow-steps",style:{display:"flex",alignItems:"stretch",gap:"0",overflowX:"auto",padding:"20px 0"}},r.map((a,n)=>(0,t.createElement)("div",{key:a.flowStepId,style:{display:"flex",alignItems:"stretch"}},(0,t.createElement)("div",{style:{flex:"0 0 auto",minWidth:"300px"}},(0,t.createElement)($,{flowId:e,flowStepId:a.flowStepId,flowStepConfig:a.flowStepConfig,pipelineStep:a.pipelineStep,pipelineConfig:i,onConfigure:o})),n<r.length-1&&(0,t.createElement)(D,null))))}function j({schedulingConfig:e}){const{interval:a,last_run_at:n,next_run_time:l}=e||{},i=a&&"manual"!==a?a:(0,c.__)("Manual","data-machine");return(0,t.createElement)("div",{className:"datamachine-flow-footer",style:{display:"flex",gap:"20px",padding:"12px 16px",backgroundColor:"#f9f9f9",borderTop:"1px solid #dcdcde",fontSize:"12px",color:"#757575"}},(0,t.createElement)("div",{className:"datamachine-flow-meta-item"},(0,t.createElement)("strong",null,(0,c.__)("Schedule:","data-machine"))," ",i),(0,t.createElement)("div",{className:"datamachine-flow-meta-item"},(0,t.createElement)("strong",null,(0,c.__)("Last Run:","data-machine"))," ",k(n)),a&&"manual"!==a&&(0,t.createElement)("div",{className:"datamachine-flow-meta-item"},(0,t.createElement)("strong",null,(0,c.__)("Next Run:","data-machine"))," ",k(l)))}function U({isOpen:e,onClose:n,pipelineId:l,nextExecutionOrder:i,onSuccess:o}){const[r,d]=(0,a.useState)(!1),[p,m]=(0,a.useState)(null);if(!e)return null;const f=window.dataMachineConfig?.stepTypes||{},h=window.dataMachineConfig?.handlers||{};return(0,t.createElement)(s.Modal,{title:(0,c.__)("Add Pipeline Step","data-machine"),onRequestClose:n,className:"datamachine-modal datamachine-step-selection-modal",style:{maxWidth:"600px"}},(0,t.createElement)("div",{className:"datamachine-modal-content"},p&&(0,t.createElement)("div",{className:"notice notice-error",style:{marginBottom:"16px"}},(0,t.createElement)("p",null,p)),(0,t.createElement)("p",{style:{marginBottom:"20px",color:"#757575"}},(0,c.__)("Select the type of step you want to add to your pipeline:","data-machine")),(0,t.createElement)("div",{className:"datamachine-step-type-grid",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"16px"}},Object.entries(f).map(([e,a])=>{const s=N(e),p=(e=>Object.values(h).filter(t=>t.type===e).length)(e);return(0,t.createElement)("button",{key:e,type:"button",className:"datamachine-step-type-card",onClick:()=>(async e=>{d(!0),m(null);try{const t=await(async(e,t,a)=>await u(`/pipelines/${e}/steps`,{method:"POST",data:{step_type:t,execution_order:a,label:`${t.charAt(0).toUpperCase()+t.slice(1)} Step`}}))(l,e,i);t.success?(o&&o(),n()):m(t.message||(0,c.__)("Failed to add step","data-machine"))}catch(e){console.error("Step addition error:",e),m(e.message||(0,c.__)("An error occurred","data-machine"))}finally{d(!1)}})(e),disabled:r,style:{padding:"20px",border:"2px solid #dcdcde",borderRadius:"4px",background:"#ffffff",cursor:"pointer",textAlign:"left",transition:"all 0.2s",display:"flex",flexDirection:"column",gap:"8px"},onMouseEnter:e=>{e.currentTarget.style.borderColor=s.color,e.currentTarget.style.background="#f9f9f9"},onMouseLeave:e=>{e.currentTarget.style.borderColor="#dcdcde",e.currentTarget.style.background="#ffffff"}},(0,t.createElement)("div",{style:{display:"flex",alignItems:"center",gap:"8px"}},(0,t.createElement)(B,{stepType:e,size:24}),(0,t.createElement)("strong",{style:{fontSize:"16px"}},a.label||T(e))),(0,t.createElement)("p",{style:{margin:0,fontSize:"13px",color:"#757575"}},a.description||""),"ai"!==e&&p>0&&(0,t.createElement)("span",{style:{fontSize:"12px",color:"#757575"}},p," ",1===p?(0,c.__)("handler","data-machine"):(0,c.__)("handlers","data-machine")," ",(0,c.__)("available","data-machine")))})),(0,t.createElement)("div",{style:{marginTop:"24px",padding:"16px",background:"#f9f9f9",borderRadius:"4px"}},(0,t.createElement)("p",{style:{margin:0,fontSize:"12px",color:"#757575"}},(0,t.createElement)("strong",null,(0,c.__)("Tip:","data-machine"))," ",(0,c.__)("Steps execute in order. You can configure each step after adding it.","data-machine"))),(0,t.createElement)("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:"20px",paddingTop:"20px",borderTop:"1px solid #dcdcde"}},(0,t.createElement)(s.Button,{variant:"secondary",onClick:n,disabled:r},(0,c.__)("Cancel","data-machine")))))}function L({toolId:e,label:a,description:n,checked:l,configured:i,onChange:o,disabled:r=!1}){return(0,t.createElement)("div",{style:{padding:"12px",border:"1px solid "+(l?"#0073aa":"#dcdcde"),borderRadius:"4px",background:l?"#f0f6fc":"#ffffff",transition:"all 0.2s"}},(0,t.createElement)("div",{style:{display:"flex",alignItems:"flex-start",gap:"8px"}},(0,t.createElement)(s.CheckboxControl,{checked:l,onChange:o,disabled:r,__nextHasNoMarginBottom:!0}),(0,t.createElement)("div",{style:{flex:1}},(0,t.createElement)("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"4px"}},(0,t.createElement)("span",{style:{fontWeight:"500",fontSize:"14px"}},a),l&&(0,t.createElement)("span",{style:{fontSize:"16px",lineHeight:"1"},title:i?"Configured":"Configuration required"},i?"âœ…":"âš ï¸")),n&&(0,t.createElement)("p",{style:{margin:0,fontSize:"12px",color:"#757575"}},n))))}function H({unconfiguredTools:e=[]}){return 0===e.length?null:(0,t.createElement)("div",{style:{marginTop:"12px",padding:"12px",background:"#fff8e5",border:"1px solid #f0b849",borderRadius:"4px",display:"flex",alignItems:"flex-start",gap:"8px"}},(0,t.createElement)("span",{style:{color:"#f0b849",fontSize:"18px",lineHeight:"1"}},"âš ï¸"),(0,t.createElement)("div",{style:{flex:1}},(0,t.createElement)("p",{style:{margin:"0 0 4px 0",fontWeight:"500",fontSize:"13px"}},(0,c.__)("Configuration Required","data-machine")),(0,t.createElement)("p",{style:{margin:0,fontSize:"12px",color:"#757575"}},(0,c.__)("The following tools require configuration before use:","data-machine")),(0,t.createElement)("ul",{style:{margin:"8px 0 0 20px",fontSize:"12px",color:"#757575"}},e.map((e,a)=>(0,t.createElement)("li",{key:a},e)))))}function q({selectedTools:e=[],onSelectionChange:n}){const[l,i]=(0,a.useState)([]),[o,r]=(0,a.useState)([]);return(0,a.useEffect)(()=>{const e=window.dataMachineConfig?.aiTools||{},t=Object.entries(e).map(([e,t])=>({toolId:e,label:t.label||e,description:t.description||"",configured:t.configured||!1}));i(t)},[]),(0,a.useEffect)(()=>{const t=l.filter(t=>e.includes(t.toolId)&&!t.configured).map(e=>e.label);r(t)},[e,l]),0===l.length?null:(0,t.createElement)("div",{style:{marginTop:"16px"}},(0,t.createElement)("label",{style:{display:"block",marginBottom:"8px",fontWeight:"500",fontSize:"14px"}},(0,c.__)("AI Tools","data-machine")),(0,t.createElement)("p",{style:{margin:"0 0 12px 0",fontSize:"12px",color:"#757575"}},(0,c.__)("Select the tools you want to enable for this AI step:","data-machine")),(0,t.createElement)("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},l.map(a=>(0,t.createElement)(L,{key:a.toolId,toolId:a.toolId,label:a.label,description:a.description,checked:e.includes(a.toolId),configured:a.configured,onChange:()=>(t=>{const a=e.includes(t)?e.filter(e=>e!==t):[...e,t];n&&n(a)})(a.toolId)}))),(0,t.createElement)(H,{unconfiguredTools:o}))}function V({isOpen:e,onClose:n,pipelineId:l,pipelineStepId:i,stepType:o,currentConfig:r,onSuccess:d}){const[p,m]=(0,a.useState)(r?.ai_provider||""),[u,h]=(0,a.useState)(r?.ai_model||""),[g,_]=(0,a.useState)(r?.system_prompt||""),[y,x]=(0,a.useState)(r?.enabled_tools||[]),[E,b]=(0,a.useState)(!1),[w,v]=(0,a.useState)(null);if((0,a.useEffect)(()=>{e&&(m(r?.ai_provider||""),h(r?.ai_model||""),_(r?.system_prompt||""),x(r?.enabled_tools||[]),v(null))},[e,r]),!e)return null;const C=window.dataMachineConfig?.aiProviders||{},S=(0,a.useMemo)(()=>{const e=[{value:"",label:(0,c.__)("Select Provider...","data-machine")}];return Object.entries(C).forEach(([t,a])=>{e.push({value:t,label:a.label||t})}),e},[C]),k=(0,a.useMemo)(()=>{if(!p||!C[p])return[{value:"",label:(0,c.__)("Select provider first...","data-machine")}];const e=[{value:"",label:(0,c.__)("Select Model...","data-machine")}],t=C[p];return t.models&&Array.isArray(t.models)&&t.models.forEach(t=>{e.push({value:t.id,label:t.name||t.id})}),e},[p,C]),T=p!==(r?.ai_provider||"")||u!==(r?.ai_model||"")||g!==(r?.system_prompt||"")||JSON.stringify(y)!==JSON.stringify(r?.enabled_tools||[]);return(0,t.createElement)(s.Modal,{title:(0,c.__)("Configure AI Step","data-machine"),onRequestClose:n,className:"datamachine-modal datamachine-configure-step-modal",style:{maxWidth:"600px"}},(0,t.createElement)("div",{className:"datamachine-modal-content"},w&&(0,t.createElement)("div",{className:"notice notice-error",style:{marginBottom:"16px"}},(0,t.createElement)("p",null,w)),(0,t.createElement)(s.SelectControl,{label:(0,c.__)("AI Provider","data-machine"),value:p,options:S,onChange:e=>{m(e),h("")},help:(0,c.__)("Choose the AI provider for this step.","data-machine")}),(0,t.createElement)(s.SelectControl,{label:(0,c.__)("AI Model","data-machine"),value:u,options:k,onChange:h,disabled:!p,help:(0,c.__)("Choose the AI model to use.","data-machine")}),(0,t.createElement)(q,{selectedTools:y,onSelectionChange:x}),(0,t.createElement)(s.TextareaControl,{label:(0,c.__)("System Prompt","data-machine"),value:g,onChange:_,placeholder:(0,c.__)("Enter system prompt for AI processing...","data-machine"),rows:8,help:(0,c.__)("Optional: Provide instructions for the AI to follow during processing.","data-machine")}),(0,t.createElement)("div",{style:{marginTop:"16px",padding:"12px",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"}},(0,t.createElement)("p",{style:{margin:0,fontSize:"12px",color:"#757575"}},(0,t.createElement)("strong",null,(0,c.__)("Note:","data-machine"))," ",(0,c.__)("The system prompt is shared across all flows using this pipeline. To add flow-specific instructions, use the user message field in the flow step card.","data-machine"))),(0,t.createElement)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"}},(0,t.createElement)(s.Button,{variant:"secondary",onClick:n,disabled:E},(0,c.__)("Cancel","data-machine")),(0,t.createElement)(s.Button,{variant:"primary",onClick:async()=>{if(p)if(u){b(!0),v(null);try{const e=await f(l,i,g,p,u,y);e.success?(d&&d(),n()):v(e.message||(0,c.__)("Failed to update configuration","data-machine"))}catch(e){console.error("Configuration update error:",e),v(e.message||(0,c.__)("An error occurred","data-machine"))}finally{b(!1)}}else v((0,c.__)("Please select an AI model","data-machine"));else v((0,c.__)("Please select an AI provider","data-machine"))},disabled:E||!T||!p||!u,isBusy:E},E?(0,c.__)("Saving...","data-machine"):(0,c.__)("Save Configuration","data-machine")))))}function Y({isOpen:e,onClose:n,flowId:l,flowName:i,currentInterval:o,onSuccess:r}){const[d,p]=(0,a.useState)(o||"manual"),[m,f]=(0,a.useState)(!1),[h,_]=(0,a.useState)(null);if(!e)return null;const y=d!==(o||"manual");return(0,t.createElement)(s.Modal,{title:(0,c.__)("Schedule Flow","data-machine"),onRequestClose:n,className:"datamachine-modal datamachine-flow-schedule-modal",style:{maxWidth:"500px"}},(0,t.createElement)("div",{className:"datamachine-modal-content"},h&&(0,t.createElement)("div",{className:"notice notice-error",style:{marginBottom:"16px"}},(0,t.createElement)("p",null,h)),(0,t.createElement)("div",{style:{marginBottom:"20px"}},(0,t.createElement)("strong",null,(0,c.__)("Flow:","data-machine"))," ",i),(0,t.createElement)(s.SelectControl,{label:(0,c.__)("Schedule Interval","data-machine"),value:d,options:g,onChange:e=>p(e),help:(0,c.__)("Choose how often this flow should run automatically.","data-machine")}),"manual"===d&&(0,t.createElement)("div",{style:{marginTop:"16px",padding:"12px",background:"#f0f6fc",border:"1px solid #0073aa",borderRadius:"4px"}},(0,t.createElement)("p",{style:{margin:0,fontSize:"13px",color:"#0073aa"}},(0,t.createElement)("strong",null,(0,c.__)("Manual Mode:","data-machine"))," ",(0,c.__)('Flow will only run when triggered manually via the "Run Now" button.',"data-machine"))),"manual"!==d&&(0,t.createElement)("div",{style:{marginTop:"16px",padding:"12px",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"}},(0,t.createElement)("p",{style:{margin:0,fontSize:"13px",color:"#757575"}},(0,t.createElement)("strong",null,(0,c.__)("Automatic Scheduling:","data-machine"))," ",(0,c.__)("Flow will run automatically based on the selected interval. You can still trigger it manually anytime.","data-machine"))),(0,t.createElement)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"}},(0,t.createElement)(s.Button,{variant:"secondary",onClick:n,disabled:m},(0,c.__)("Cancel","data-machine")),(0,t.createElement)(s.Button,{variant:"primary",onClick:async()=>{f(!0),_(null);try{const e=await(async(e,t)=>await u(`/flows/${e}/schedule`,{method:"PUT",data:t}))(l,{interval:d});e.success?(r&&r(),n()):_(e.message||(0,c.__)("Failed to update schedule","data-machine"))}catch(e){console.error("Schedule update error:",e),_(e.message||(0,c.__)("An error occurred","data-machine"))}finally{f(!1)}},disabled:m||!y,isBusy:m},m?(0,c.__)("Saving...","data-machine"):(0,c.__)("Save Schedule","data-machine")))))}function J({isOpen:e,onClose:a,stepType:n,onSelectHandler:l}){if(!e)return null;const i=window.dataMachineConfig?.handlers||{},o=Object.entries(i).filter(([e,t])=>t.type===n);return(0,t.createElement)(s.Modal,{title:(0,c.__)("Select Handler","data-machine"),onRequestClose:a,className:"datamachine-modal datamachine-handler-selection-modal",style:{maxWidth:"600px"}},(0,t.createElement)("div",{className:"datamachine-modal-content"},(0,t.createElement)("p",{style:{marginBottom:"20px",color:"#757575"}},(0,c.__)("Choose the handler for this step:","data-machine")),0===o.length&&(0,t.createElement)("div",{style:{padding:"40px 20px",textAlign:"center",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"}},(0,t.createElement)("p",{style:{margin:0,color:"#757575"}},(0,c.__)("No handlers available for this step type.","data-machine"))),o.length>0&&(0,t.createElement)("div",{className:"datamachine-handler-grid",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"16px"}},o.map(([e,n])=>(0,t.createElement)("button",{key:e,type:"button",className:"datamachine-handler-card",onClick:()=>(l&&l(e),void a()),style:{padding:"20px",border:"2px solid #dcdcde",borderRadius:"4px",background:"#ffffff",cursor:"pointer",textAlign:"left",transition:"all 0.2s",display:"flex",flexDirection:"column",gap:"8px"},onMouseEnter:e=>{e.currentTarget.style.borderColor="#0073aa",e.currentTarget.style.background="#f9f9f9"},onMouseLeave:e=>{e.currentTarget.style.borderColor="#dcdcde",e.currentTarget.style.background="#ffffff"}},(0,t.createElement)("strong",{style:{fontSize:"16px"}},n.label||T(e)),(0,t.createElement)("p",{style:{margin:0,fontSize:"13px",color:"#757575"}},n.description||""),n.requires_auth&&(0,t.createElement)("span",{style:{display:"inline-block",padding:"2px 8px",background:"#f0b849",color:"#000",borderRadius:"3px",fontSize:"11px",fontWeight:"500"}},(0,c.__)("Requires Auth","data-machine"))))),(0,t.createElement)("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"}},(0,t.createElement)(s.Button,{variant:"secondary",onClick:a},(0,c.__)("Cancel","data-machine")))))}function X({onFileUploaded:e}){const[n,l]=(0,a.useState)(!1),[i,o]=(0,a.useState)(null),[r,d]=(0,a.useState)(null);return(0,t.createElement)("div",null,i&&(0,t.createElement)(s.Notice,{status:"error",isDismissible:!0,onRemove:()=>o(null)},(0,t.createElement)("p",null,i)),r&&(0,t.createElement)(s.Notice,{status:"success",isDismissible:!0,onRemove:()=>d(null)},(0,t.createElement)("p",null,r)),(0,t.createElement)(P,{onFileSelected:async t=>{l(!0),o(null),d(null);try{await new Promise(e=>setTimeout(e,1e3)),e&&e({file_name:t.name,file_size:t.size,status:"pending"}),d((0,c.__)("File uploaded successfully!","data-machine"))}catch(e){console.error("Upload error:",e),o(e.message||(0,c.__)("An error occurred during upload","data-machine"))}finally{l(!1)}},allowedTypes:["pdf","csv","txt","json","jpg","jpeg","png","gif"],maxSizeMB:10,disabled:n,uploadText:n?(0,c.__)("Uploading...","data-machine"):null}))}function G({files:e=[]}){return 0===e.length?(0,t.createElement)("div",{style:{padding:"40px 20px",textAlign:"center",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"}},(0,t.createElement)("p",{style:{margin:0,color:"#757575"}},(0,c.__)("No files uploaded yet.","data-machine"))):(0,t.createElement)("div",{style:{border:"1px solid #dcdcde",borderRadius:"4px",maxHeight:"300px",overflowY:"auto"}},(0,t.createElement)("table",{style:{width:"100%",borderCollapse:"collapse"}},(0,t.createElement)("thead",null,(0,t.createElement)("tr",{style:{background:"#f9f9f9",borderBottom:"1px solid #dcdcde",position:"sticky",top:0,zIndex:1}},(0,t.createElement)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600"}},(0,c.__)("File Name","data-machine")),(0,t.createElement)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600",width:"100px"}},(0,c.__)("Size","data-machine")),(0,t.createElement)("th",{style:{padding:"12px 16px",textAlign:"center",fontWeight:"600",width:"120px"}},(0,c.__)("Status","data-machine")))),(0,t.createElement)("tbody",null,e.map((e,a)=>(0,t.createElement)("tr",{key:a,style:{borderBottom:"1px solid #dcdcde"}},(0,t.createElement)("td",{style:{padding:"12px 16px",fontWeight:"500"}},e.file_name),(0,t.createElement)("td",{style:{padding:"12px 16px",color:"#757575"}},(e=>{if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]})(e.file_size)),(0,t.createElement)("td",{style:{padding:"12px 16px",textAlign:"center"}},(e=>{const a={processed:{label:(0,c.__)("Processed","data-machine"),color:"#46b450",icon:"âœ“"},pending:{label:(0,c.__)("Pending","data-machine"),color:"#f0b849",icon:"â—"}},n=a[e]||a.pending;return(0,t.createElement)("span",{style:{display:"inline-flex",alignItems:"center",gap:"4px",padding:"4px 8px",background:`${n.color}20`,color:n.color,borderRadius:"3px",fontSize:"11px",fontWeight:"500"}},(0,t.createElement)("span",null,n.icon),n.label)})(e.status)))))))}function K({checked:e,onChange:a}){return(0,t.createElement)("div",{style:{marginTop:"16px",padding:"12px",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"}},(0,t.createElement)(s.CheckboxControl,{label:(0,c.__)("Automatically delete files after processing","data-machine"),checked:e,onChange:a,help:(0,c.__)("Files will be removed from the handler after successful processing. Disable to keep files for multiple uses.","data-machine")}))}function Q({currentSettings:e={},onSettingsChange:n}){const[l,i]=(0,a.useState)(e.files||[]),[o,r]=(0,a.useState)(!1!==e.auto_cleanup);return(0,a.useEffect)(()=>{n&&n({files:l,auto_cleanup:o})},[l,o,n]),(0,t.createElement)("div",{className:"datamachine-files-handler-settings"},(0,t.createElement)("div",{style:{marginBottom:"16px"}},(0,t.createElement)("h4",{style:{margin:"0 0 8px 0",fontSize:"14px",fontWeight:"600"}},(0,c.__)("Upload Files","data-machine")),(0,t.createElement)("p",{style:{margin:"0 0 12px 0",fontSize:"12px",color:"#757575"}},(0,c.__)("Upload files to be processed by this flow. Each file will be processed individually.","data-machine"))),(0,t.createElement)(X,{onFileUploaded:e=>{i(t=>[...t,e])}}),(0,t.createElement)("div",{style:{marginTop:"24px",marginBottom:"16px"}},(0,t.createElement)("h4",{style:{margin:"0 0 8px 0",fontSize:"14px",fontWeight:"600"}},(0,c.__)("Uploaded Files","data-machine")),(0,t.createElement)("p",{style:{margin:"0 0 12px 0",fontSize:"12px",color:"#757575"}},(0,c.__)("Files will be processed in order when the flow runs.","data-machine"))),(0,t.createElement)(G,{files:l}),(0,t.createElement)(K,{checked:o,onChange:e=>{r(e)}}),(0,t.createElement)("div",{style:{marginTop:"16px",padding:"12px",background:"#f0f6fc",border:"1px solid #0073aa",borderRadius:"4px"}},(0,t.createElement)("p",{style:{margin:0,fontSize:"12px",color:"#0073aa"}},(0,t.createElement)("strong",null,(0,c.__)("Note:","data-machine"))," ",(0,c.__)("Files are stored specifically for this flow. Each uploaded file will create a separate processing job when the flow runs.","data-machine"))))}function Z({isOpen:e,onClose:n,flowStepId:l,handlerSlug:i,stepType:o,pipelineId:r,flowId:d,currentSettings:p,onSuccess:m,onChangeHandler:f,onOAuthConnect:h}){const[g,_]=(0,a.useState)(p||{}),[y,x]=(0,a.useState)(!1),[E,b]=(0,a.useState)(null);if((0,a.useEffect)(()=>{e&&(_(p||{}),b(null))},[e,p,i]),!e)return null;const w=(window.dataMachineConfig?.handlers||{})[i]||{},v=(e,t)=>{_(a=>({...a,[e]:t}))},C=(window.dataMachineConfig?.handlerSettings?.[i]||{}).fields||{};return(0,t.createElement)(s.Modal,{title:(0,c.__)("Configure Handler","data-machine"),onRequestClose:n,className:"datamachine-modal datamachine-handler-settings-modal",style:{maxWidth:"600px"}},(0,t.createElement)("div",{className:"datamachine-modal-content"},E&&(0,t.createElement)("div",{className:"notice notice-error",style:{marginBottom:"16px"}},(0,t.createElement)("p",null,E)),(0,t.createElement)("div",{style:{marginBottom:"20px",paddingBottom:"16px",borderBottom:"1px solid #dcdcde"}},(0,t.createElement)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},(0,t.createElement)("div",null,(0,t.createElement)("strong",null,(0,c.__)("Handler:","data-machine"))," ",w.label||T(i)),(0,t.createElement)(s.Button,{variant:"secondary",size:"small",onClick:f},(0,c.__)("Change Handler","data-machine"))),w.requires_auth&&(0,t.createElement)("div",{style:{marginTop:"12px"}},(0,t.createElement)(s.Button,{variant:"secondary",onClick:()=>{h&&h(i,w)}},(0,c.__)("Connect Account","data-machine")))),"files"===i?(0,t.createElement)(Q,{currentSettings:g,onSettingsChange:e=>_(t=>({...t,...e}))}):(0,t.createElement)(t.Fragment,null,0===Object.keys(C).length&&(0,t.createElement)("div",{style:{padding:"20px",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px",textAlign:"center"}},(0,t.createElement)("p",{style:{margin:0,color:"#757575"}},(0,c.__)("No configuration options available for this handler.","data-machine"))),Object.keys(C).length>0&&(0,t.createElement)("div",{className:"datamachine-handler-settings-fields"},Object.entries(C).map(([e,a])=>((e,a)=>{const n=g[e]||a.default||"";switch(a.type){case"text":default:return(0,t.createElement)(s.TextControl,{key:e,label:a.label||T(e),value:n,onChange:t=>v(e,t),help:a.description});case"textarea":return(0,t.createElement)(s.TextareaControl,{key:e,label:a.label||T(e),value:n,onChange:t=>v(e,t),help:a.description,rows:a.rows||4});case"select":const l=a.options||[];return(0,t.createElement)(s.SelectControl,{key:e,label:a.label||T(e),value:n,options:l,onChange:t=>v(e,t),help:a.description});case"checkbox":return(0,t.createElement)(s.CheckboxControl,{key:e,label:a.label||T(e),checked:!!n,onChange:t=>v(e,t),help:a.description})}})(e,a)))),(0,t.createElement)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"}},(0,t.createElement)(s.Button,{variant:"secondary",onClick:n,disabled:y},(0,c.__)("Cancel","data-machine")),(0,t.createElement)(s.Button,{variant:"primary",onClick:async()=>{x(!0),b(null);try{const e=await(async(e,t,a,n={})=>await u(`/flows/${e}/steps/${t}/handler`,{method:"PUT",data:{handler_slug:a,settings:n}}))(d,l,i,g);e.success?(m&&m(),n()):b(e.message||(0,c.__)("Failed to update handler settings","data-machine"))}catch(e){console.error("Handler settings update error:",e),b(e.message||(0,c.__)("An error occurred","data-machine"))}finally{x(!1)}},disabled:y,isBusy:y},y?(0,c.__)("Saving...","data-machine"):(0,c.__)("Save Settings","data-machine")))))}function ee({pipelines:e,selectedIds:a,onSelectionChange:n}){const l=e.length>0&&a.length===e.length;return(0,t.createElement)("div",{style:{border:"1px solid #dcdcde",borderRadius:"4px",maxHeight:"400px",overflowY:"auto"}},(0,t.createElement)("table",{style:{width:"100%",borderCollapse:"collapse"}},(0,t.createElement)("thead",null,(0,t.createElement)("tr",{style:{background:"#f9f9f9",borderBottom:"1px solid #dcdcde",position:"sticky",top:0,zIndex:1}},(0,t.createElement)("th",{style:{padding:"12px 16px",textAlign:"left",width:"40px"}},(0,t.createElement)(s.CheckboxControl,{checked:l,onChange:()=>{a.length===e.length?n([]):n(e.map(e=>e.pipeline_id))},__nextHasNoMarginBottom:!0})),(0,t.createElement)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600"}},(0,c.__)("Pipeline Name","data-machine")),(0,t.createElement)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600",width:"100px"}},(0,c.__)("Steps","data-machine")),(0,t.createElement)("th",{style:{padding:"12px 16px",textAlign:"left",fontWeight:"600",width:"100px"}},(0,c.__)("Flows","data-machine")))),(0,t.createElement)("tbody",null,0===e.length&&(0,t.createElement)("tr",null,(0,t.createElement)("td",{colSpan:"4",style:{padding:"40px 20px",textAlign:"center",color:"#757575"}},(0,c.__)("No pipelines available","data-machine"))),e.map(e=>{const l=e.pipeline_steps?.length||0,i=e.flows?.length||0,o=a.includes(e.pipeline_id);return(0,t.createElement)("tr",{key:e.pipeline_id,style:{borderBottom:"1px solid #dcdcde",background:o?"#f0f6fc":"transparent",transition:"background 0.2s"},onMouseEnter:e=>{o||(e.currentTarget.style.background="#f9f9f9")},onMouseLeave:e=>{o||(e.currentTarget.style.background="transparent")}},(0,t.createElement)("td",{style:{padding:"12px 16px"}},(0,t.createElement)(s.CheckboxControl,{checked:o,onChange:()=>(e=>{const t=a.includes(e)?a.filter(t=>t!==e):[...a,e];n(t)})(e.pipeline_id),__nextHasNoMarginBottom:!0})),(0,t.createElement)("td",{style:{padding:"12px 16px",fontWeight:"500"}},e.pipeline_name),(0,t.createElement)("td",{style:{padding:"12px 16px",color:"#757575"}},l),(0,t.createElement)("td",{style:{padding:"12px 16px",color:"#757575"}},i))}))))}function te({pipelines:e,onClose:n}){const[l,i]=(0,a.useState)([]),[o,r]=(0,a.useState)(!1),[d,p]=(0,a.useState)(null),[m,f]=(0,a.useState)(null);return(0,t.createElement)("div",{className:"datamachine-export-tab"},d&&(0,t.createElement)(s.Notice,{status:"error",isDismissible:!0,onRemove:()=>p(null)},(0,t.createElement)("p",null,d)),m&&(0,t.createElement)(s.Notice,{status:"success",isDismissible:!0,onRemove:()=>f(null)},(0,t.createElement)("p",null,m)),(0,t.createElement)("p",{style:{marginBottom:"20px",color:"#757575"}},(0,c.__)("Select the pipelines you want to export to CSV:","data-machine")),(0,t.createElement)(ee,{pipelines:e,selectedIds:l,onSelectionChange:i}),(0,t.createElement)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"}},(0,t.createElement)(s.Button,{variant:"secondary",onClick:n,disabled:o},(0,c.__)("Cancel","data-machine")),(0,t.createElement)(s.Button,{variant:"primary",onClick:async()=>{if(0!==l.length){r(!0),p(null),f(null);try{const e=await(async e=>await u("/pipelines/export",{method:"POST",data:{pipeline_ids:e}}))(l);if(e.success&&e.data?.csv_content){const t=new Blob([e.data.csv_content],{type:"text/csv"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download=`data-machine-pipelines-${Date.now()}.csv`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a),f((0,c.__)("Pipelines exported successfully!","data-machine")),i([])}else p(e.message||(0,c.__)("Failed to export pipelines","data-machine"))}catch(e){console.error("Export error:",e),p(e.message||(0,c.__)("An error occurred during export","data-machine"))}finally{r(!1)}}else p((0,c.__)("Please select at least one pipeline to export.","data-machine"))},disabled:o||0===l.length,isBusy:o},o?(0,c.__)("Exporting...","data-machine"):(0,c.__)("Export Selected","data-machine"))))}function ae({onFileSelected:e,fileName:n,disabled:l=!1}){const[i,o]=(0,a.useState)(!1),[r,d]=(0,a.useState)(null),p=(0,a.useRef)(null),m=t=>{if(!t.name.endsWith(".csv")&&"text/csv"!==t.type)return void d((0,c.__)("Please select a valid CSV file.","data-machine"));if(t.size>10485760)return void d((0,c.__)("File size exceeds 10MB limit.","data-machine"));const a=new FileReader;a.onload=a=>{const n=a.target.result;e&&(e(n,t.name),d(null))},a.onerror=()=>{d((0,c.__)("Failed to read file.","data-machine"))},a.readAsText(t)},u=()=>{p.current&&p.current.click()};return(0,t.createElement)("div",null,(0,t.createElement)("div",{onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),l||o(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),o(!1)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDrop:e=>{if(e.preventDefault(),e.stopPropagation(),o(!1),l)return;const t=e.dataTransfer.files;t.length>0&&m(t[0])},style:{border:"2px dashed "+(i?"#0073aa":"#dcdcde"),borderRadius:"4px",padding:"40px 20px",textAlign:"center",background:i?"#f0f6fc":"#f9f9f9",transition:"all 0.2s",cursor:l?"not-allowed":"pointer",opacity:l?.6:1},onClick:l?void 0:u},(0,t.createElement)("div",{style:{marginBottom:"16px",fontSize:"48px",color:"#757575"}},"ðŸ“„"),(0,t.createElement)("p",{style:{margin:"0 0 12px 0",fontSize:"16px",fontWeight:"500"}},n?(0,c.__)("File selected","data-machine"):(0,c.__)("Drag and drop CSV file here","data-machine")),(0,t.createElement)("p",{style:{margin:"0 0 16px 0",color:"#757575",fontSize:"14px"}},(0,c.__)("or","data-machine")),(0,t.createElement)(s.Button,{variant:"secondary",onClick:u,disabled:l},(0,c.__)("Browse Files","data-machine")),(0,t.createElement)("input",{ref:p,type:"file",accept:".csv,text/csv",onChange:e=>{const t=e.target.files;t.length>0&&m(t[0])},style:{display:"none"},disabled:l})),r&&(0,t.createElement)("div",{style:{marginTop:"12px",padding:"8px 12px",background:"#fef7f7",border:"1px solid #dc3232",borderRadius:"4px",color:"#dc3232",fontSize:"13px"}},r))}function ne({onSuccess:e,onClose:n}){const[l,i]=(0,a.useState)(null),[o,r]=(0,a.useState)(""),[d,p]=(0,a.useState)(!1),[m,f]=(0,a.useState)(null),[h,g]=(0,a.useState)(null);return(0,t.createElement)("div",{className:"datamachine-import-tab"},m&&(0,t.createElement)(s.Notice,{status:"error",isDismissible:!0,onRemove:()=>f(null)},(0,t.createElement)("p",null,m)),h&&(0,t.createElement)(s.Notice,{status:"success",isDismissible:!0,onRemove:()=>g(null)},(0,t.createElement)("p",null,h)),(0,t.createElement)("p",{style:{marginBottom:"20px",color:"#757575"}},(0,c.__)("Upload a CSV file to import pipelines:","data-machine")),(0,t.createElement)(ae,{onFileSelected:(e,t)=>{i(e),r(t),f(null),g(null)},fileName:o,disabled:d}),o&&(0,t.createElement)("div",{style:{marginTop:"16px",display:"flex",alignItems:"center",gap:"12px"}},(0,t.createElement)("span",{style:{color:"#46b450",fontWeight:"500"}},(0,c.__)("Selected:","data-machine")," ",o),(0,t.createElement)(s.Button,{variant:"link",onClick:()=>{i(null),r(""),f(null),g(null)},disabled:d,style:{color:"#dc3232"}},(0,c.__)("Clear","data-machine"))),(0,t.createElement)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"}},(0,t.createElement)(s.Button,{variant:"secondary",onClick:n,disabled:d},(0,c.__)("Cancel","data-machine")),(0,t.createElement)(s.Button,{variant:"primary",onClick:async()=>{if(l){p(!0),f(null),g(null);try{const t=await(async e=>await u("/pipelines/import",{method:"POST",data:{csv_content:e}}))(l);if(t.success){const a=t.data?.created_count||0;g(a>0?(0,c.__)(`Successfully imported ${a} pipeline(s)!`,"data-machine"):(0,c.__)("Import completed!","data-machine")),i(null),r(""),setTimeout(()=>{e&&e()},1500)}else f(t.message||(0,c.__)("Failed to import pipelines","data-machine"))}catch(e){console.error("Import error:",e),f(e.message||(0,c.__)("An error occurred during import","data-machine"))}finally{p(!1)}}else f((0,c.__)("Please select a CSV file to import.","data-machine"))},disabled:d||!l,isBusy:d},d?(0,c.__)("Importing...","data-machine"):(0,c.__)("Import Pipelines","data-machine"))))}function le({isOpen:e,onClose:n,pipelines:l=[],onSuccess:i}){const[o,r]=(0,a.useState)("export");if(!e)return null;const d=[{name:"export",title:(0,c.__)("Export","data-machine"),className:"datamachine-import-export-tab"},{name:"import",title:(0,c.__)("Import","data-machine"),className:"datamachine-import-export-tab"}],p=()=>{i&&i(),n()};return(0,t.createElement)(s.Modal,{title:(0,c.__)("Import / Export Pipelines","data-machine"),onRequestClose:n,className:"datamachine-modal datamachine-import-export-modal",style:{maxWidth:"700px"}},(0,t.createElement)("div",{className:"datamachine-modal-content"},(0,t.createElement)(s.TabPanel,{className:"datamachine-import-export-tabs",activeClass:"is-active",tabs:d,onSelect:e=>r(e)},e=>(0,t.createElement)("div",{className:"datamachine-tab-content"},"export"===e.name&&(0,t.createElement)(te,{pipelines:l,onClose:n}),"import"===e.name&&(0,t.createElement)(ne,{onSuccess:p,onClose:n})))))}function ie({connected:e}){const a=e?{label:(0,c.__)("Connected","data-machine"),color:"#46b450",icon:"âœ“",background:"#e6f4ea"}:{label:(0,c.__)("Not Connected","data-machine"),color:"#dc3232",icon:"âœ—",background:"#fef7f7"};return(0,t.createElement)("div",{style:{display:"inline-flex",alignItems:"center",gap:"6px",padding:"6px 12px",background:a.background,border:`1px solid ${a.color}`,borderRadius:"4px",fontSize:"13px",fontWeight:"500"}},(0,t.createElement)("span",{style:{color:a.color,fontSize:"16px",lineHeight:"1"}},a.icon),(0,t.createElement)("span",{style:{color:a.color}},a.label))}function oe({account:e}){if(!e||0===Object.keys(e).length)return null;const a=e.username||e.name||e.screen_name||null,n=e.email||null,l=e.id||e.user_id||null;return(0,t.createElement)("div",{style:{marginTop:"16px",padding:"12px",background:"#f9f9f9",border:"1px solid #dcdcde",borderRadius:"4px"}},(0,t.createElement)("h4",{style:{margin:"0 0 8px 0",fontSize:"13px",fontWeight:"600"}},(0,c.__)("Connected Account","data-machine")),(0,t.createElement)("div",{style:{fontSize:"12px",color:"#555"}},a&&(0,t.createElement)("div",{style:{marginBottom:"4px"}},(0,t.createElement)("strong",null,(0,c.__)("Username:","data-machine"))," ",a),n&&(0,t.createElement)("div",{style:{marginBottom:"4px"}},(0,t.createElement)("strong",null,(0,c.__)("Email:","data-machine"))," ",n),l&&(0,t.createElement)("div",{style:{marginBottom:"4px"}},(0,t.createElement)("strong",null,(0,c.__)("Account ID:","data-machine"))," ",l),Object.entries(e).map(([e,a])=>["username","name","screen_name","email","id","user_id"].includes(e)||"object"==typeof a||"function"==typeof a?null:(0,t.createElement)("div",{key:e,style:{marginBottom:"4px"}},(0,t.createElement)("strong",null,e,":")," ",String(a)))))}function re({config:e={},onChange:a,fields:n=[]}){const l=[{key:"api_key",label:(0,c.__)("API Key","data-machine"),type:"text",required:!0},{key:"api_secret",label:(0,c.__)("API Secret","data-machine"),type:"password",required:!0}],i=n.length>0?n:l;return(0,t.createElement)("div",{className:"datamachine-api-config-form"},(0,t.createElement)("p",{style:{marginBottom:"16px",fontSize:"13px",color:"#757575"}},(0,c.__)("Enter your API credentials:","data-machine")),i.map(n=>(0,t.createElement)(s.TextControl,{key:n.key,label:n.label,type:n.type||"text",value:e[n.key]||"",onChange:t=>((t,n)=>{a&&a({...e,[t]:n})})(n.key,t),placeholder:n.placeholder||"",help:n.help||"",required:n.required||!1})))}function ce({oauthUrl:e,onSuccess:n,onError:l,disabled:i=!1}){const o=(0,a.useRef)(null),r=(0,a.useRef)(null);return(0,a.useEffect)(()=>()=>{r.current&&window.removeEventListener("message",r.current),o.current&&!o.current.closed&&o.current.close()},[]),(0,t.createElement)(s.Button,{variant:"primary",onClick:()=>{o.current&&!o.current.closed&&o.current.close();const t=window.screen.width/2-300,a=window.screen.height/2-350;o.current=window.open(e,"oauth-window",`width=600,height=700,left=${t},top=${a},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`),r.current=e=>{[window.location.origin].includes(e.origin)&&e.data&&"oauth_callback"===e.data.type&&(o.current&&!o.current.closed&&o.current.close(),e.data.success?n&&n(e.data.account):l&&l(e.data.error||(0,c.__)("OAuth authentication failed","data-machine")),window.removeEventListener("message",r.current))},window.addEventListener("message",r.current),o.current&&!o.current.closed||l&&l((0,c.__)("Popup was blocked. Please allow popups for this site.","data-machine"))},disabled:i},(0,c.__)("Connect Account","data-machine"))}function se({isOpen:e,onClose:n,handlerSlug:l,handlerInfo:i={},onSuccess:o}){const[r,d]=(0,a.useState)(!1),[p,m]=(0,a.useState)(null),[u,f]=(0,a.useState)({}),[h,g]=(0,a.useState)(!1),[_,y]=(0,a.useState)(null),[x,E]=(0,a.useState)(null),b=i.auth_type||"oauth2",w=i.oauth_url||`/datamachine-auth/${l}/`;return(0,a.useEffect)(()=>{if(e){const e=null;e&&(d(!0),m(e))}},[e]),e?(0,t.createElement)(s.Modal,{title:(0,c.__)("OAuth Authentication","data-machine"),onRequestClose:n,className:"datamachine-modal datamachine-oauth-modal",style:{maxWidth:"600px"}},(0,t.createElement)("div",{className:"datamachine-modal-content"},_&&(0,t.createElement)(s.Notice,{status:"error",isDismissible:!0,onRemove:()=>y(null)},(0,t.createElement)("p",null,_)),x&&(0,t.createElement)(s.Notice,{status:"success",isDismissible:!0,onRemove:()=>E(null)},(0,t.createElement)("p",null,x)),(0,t.createElement)("div",{style:{marginBottom:"20px"}},(0,t.createElement)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"}},(0,t.createElement)("div",null,(0,t.createElement)("strong",null,(0,c.__)("Handler:","data-machine"))," ",i.label||l),(0,t.createElement)(ie,{connected:r})),(0,t.createElement)("p",{style:{margin:0,fontSize:"13px",color:"#757575"}},"oauth2"===b?(0,c.__)('Click "Connect Account" to authorize access via OAuth.',"data-machine"):(0,c.__)("Enter your API credentials to connect.","data-machine"))),!r&&(0,t.createElement)(t.Fragment,null,"oauth2"===b?(0,t.createElement)("div",{style:{marginBottom:"16px"}},(0,t.createElement)(ce,{oauthUrl:w,onSuccess:e=>{d(!0),m(e),E((0,c.__)("Account connected successfully!","data-machine")),y(null),o&&o()},onError:e=>{y(e),E(null)},disabled:h})):(0,t.createElement)(t.Fragment,null,(0,t.createElement)(re,{config:u,onChange:f,fields:i.auth_fields||[]}),(0,t.createElement)("div",{style:{marginTop:"16px"}},(0,t.createElement)(s.Button,{variant:"primary",onClick:async()=>{g(!0),y(null),E(null);try{await new Promise(e=>setTimeout(e,1e3)),d(!0),m({api_key:u.api_key}),E((0,c.__)("Credentials saved successfully!","data-machine")),o&&o()}catch(e){console.error("Save error:",e),y(e.message||(0,c.__)("Failed to save credentials","data-machine"))}finally{g(!1)}},disabled:h,isBusy:h},h?(0,c.__)("Saving...","data-machine"):(0,c.__)("Save Credentials","data-machine"))))),r&&(0,t.createElement)(t.Fragment,null,(0,t.createElement)(oe,{account:p}),(0,t.createElement)("div",{style:{marginTop:"16px"}},(0,t.createElement)(s.Button,{variant:"secondary",onClick:async()=>{if(confirm((0,c.__)("Are you sure you want to disconnect this account?","data-machine"))){g(!0),y(null),E(null);try{await new Promise(e=>setTimeout(e,1e3)),d(!1),m(null),f({}),E((0,c.__)("Account disconnected successfully!","data-machine"))}catch(e){console.error("Disconnect error:",e),y(e.message||(0,c.__)("Failed to disconnect account","data-machine"))}finally{g(!1)}}},disabled:h,isBusy:h,style:{color:"#dc3232"}},h?(0,c.__)("Disconnecting...","data-machine"):(0,c.__)("Disconnect Account","data-machine")))),(0,t.createElement)("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:"24px",paddingTop:"20px",borderTop:"1px solid #dcdcde"}},(0,t.createElement)(s.Button,{variant:"secondary",onClick:n,disabled:h},(0,c.__)("Close","data-machine"))))):null}function de({flow:e,pipelineSteps:n,pipelineConfig:l}){const{refreshData:i,openModal:o,closeModal:d,activeModal:p,modalData:m}=r(),[f,h]=(0,a.useState)(null),[g,_]=(0,a.useState)(null);if(!e)return null;const x=(0,a.useCallback)(()=>{i()},[i]),w=(0,a.useCallback)(async e=>{try{const t=await(async e=>await u(`/flows/${e}`,{method:"DELETE"}))(e);t.success?i():alert(t.message||(0,c.__)("Failed to delete flow","data-machine"))}catch(e){console.error("Flow deletion error:",e),alert((0,c.__)("An error occurred while deleting the flow","data-machine"))}},[i]),C=(0,a.useCallback)(async e=>{try{const t=await(async e=>await u(`/flows/${e}/duplicate`,{method:"POST"}))(e);t.success?i():alert(t.message||(0,c.__)("Failed to duplicate flow","data-machine"))}catch(e){console.error("Flow duplication error:",e),alert((0,c.__)("An error occurred while duplicating the flow","data-machine"))}},[i]),S=(0,a.useCallback)(async e=>{try{const t=await(async e=>await u(`/flows/${e}/execute`,{method:"POST",data:{trigger_type:"manual"}}))(e);t.success?(alert((0,c.__)("Flow started successfully!","data-machine")),i()):alert(t.message||(0,c.__)("Failed to run flow","data-machine"))}catch(e){console.error("Flow execution error:",e),alert((0,c.__)("An error occurred while running the flow","data-machine"))}},[i]),k=(0,a.useCallback)(t=>{o(b,{flowId:t,flowName:e.flow_name,currentInterval:e.scheduling_config?.interval||"manual"})},[e.flow_name,e.scheduling_config,o]),T=(0,a.useCallback)(t=>{const a=e.flow_config?.[t]||{},l=a.pipeline_step_id,i=n.find(e=>e.pipeline_step_id===l),r={flowStepId:t,handlerSlug:a.handler_slug||"",stepType:i?.step_type||a.step_type,pipelineId:e.pipeline_id,flowId:e.flow_id,currentSettings:a.handler_config||{}};h(r),a.handler_slug?o(E,r):o(y,{stepType:r.stepType})},[e.flow_config,e.pipeline_id,e.flow_id,n,o]),N=(0,a.useCallback)(e=>{const t={...f,handlerSlug:e,currentSettings:{}};h(t),o(E,t)},[f,o]),B=(0,a.useCallback)(()=>{o(y,{stepType:f?.stepType})},[f,o]),A=(0,a.useCallback)((e,t)=>{_({handlerSlug:e,handlerInfo:t}),o(v)},[o]);return(0,t.createElement)(t.Fragment,null,(0,t.createElement)(s.Card,{className:"datamachine-flow-card datamachine-flow-instance-card",size:"large"},(0,t.createElement)(s.CardBody,null,(0,t.createElement)(M,{flowId:e.flow_id,flowName:e.flow_name,onNameChange:x,onDelete:w,onDuplicate:C,onRun:S,onSchedule:k}),(0,t.createElement)(s.CardDivider,null),(0,t.createElement)(W,{flowId:e.flow_id,flowConfig:e.flow_config||{},pipelineSteps:n,pipelineConfig:l,onStepConfigured:T}),(0,t.createElement)(s.CardDivider,null),(0,t.createElement)(j,{schedulingConfig:e.scheduling_config||{}}))),p===b&&(0,t.createElement)(Y,{isOpen:!0,onClose:d,...m,onSuccess:()=>{d(),i()}}),p===y&&(0,t.createElement)(J,{isOpen:!0,onClose:d,...m,onSelectHandler:N}),p===E&&(0,t.createElement)(Z,{isOpen:!0,onClose:d,...m,onSuccess:()=>{d(),i(),h(null)},onChangeHandler:B,onOAuthConnect:A}),p===v&&(0,t.createElement)(se,{isOpen:!0,onClose:d,handlerSlug:g?.handlerSlug,handlerInfo:g?.handlerInfo,onSuccess:()=>{d(),i(),_(null)}}))}function pe({pipelineId:e,onAddFlow:a}){return(0,t.createElement)("div",{className:"datamachine-empty-flow-card",style:{border:"2px dashed #dcdcde",borderRadius:"4px",padding:"40px 20px",textAlign:"center",backgroundColor:"#f9f9f9",minWidth:"300px",marginBottom:"20px"}},(0,t.createElement)("div",{style:{fontSize:"48px",color:"#c3c4c7",marginBottom:"16px"}},"+"),(0,t.createElement)(s.Button,{variant:"secondary",onClick:()=>a&&a(e)},(0,c.__)("Add Flow","data-machine")))}function me({pipelineId:e,flows:n,pipelineSteps:l,pipelineConfig:i}){const{refreshData:o}=r(),s=(0,a.useCallback)(async e=>{try{const t=(0,c.__)("New Flow","data-machine"),a=await(async(e,t)=>await u("/flows",{method:"POST",data:{pipeline_id:e,flow_name:t}}))(e,t);a.success?o():alert(a.message||(0,c.__)("Failed to create flow","data-machine"))}catch(e){console.error("Flow creation error:",e),alert((0,c.__)("An error occurred while creating the flow","data-machine"))}},[o]);return n&&0!==n.length?(0,t.createElement)("div",{className:"datamachine-flows-section"},(0,t.createElement)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"}},(0,t.createElement)("h3",{style:{margin:0}},(0,c.__)("Flows","data-machine")," ",(0,t.createElement)("span",{style:{color:"#757575",fontSize:"14px",fontWeight:"normal"}},"(",n.length,")"))),(0,t.createElement)("div",{className:"datamachine-flows-list",style:{display:"flex",flexDirection:"column",gap:"20px"}},n.map(e=>(0,t.createElement)(de,{key:e.flow_id,flow:e,pipelineSteps:l,pipelineConfig:i})),(0,t.createElement)(pe,{pipelineId:e,onAddFlow:s}))):(0,t.createElement)("div",{className:"datamachine-flows-section datamachine-flows-section--empty"},(0,t.createElement)("h3",{style:{marginTop:0,marginBottom:"16px"}},(0,c.__)("Flows","data-machine")),(0,t.createElement)("p",{style:{color:"#757575",marginBottom:"16px"}},(0,c.__)("No flows configured. Add your first flow to get started.","data-machine")),(0,t.createElement)(pe,{pipelineId:e,onAddFlow:s}))}function ue({pipeline:e,flows:n}){const{refreshData:l,openModal:i,closeModal:o,activeModal:d,modalData:p}=r();if(!e)return null;const m=(0,a.useCallback)(e=>{l()},[l]),f=(0,a.useCallback)(e=>{l()},[l]),h=(0,a.useCallback)(t=>{const a=(e.pipeline_steps||[]).length+1;i(_,{pipelineId:t,nextExecutionOrder:a})},[e.pipeline_steps,i]),g=(0,a.useCallback)(async t=>{try{const a=await(async(e,t)=>await u(`/pipelines/${e}/steps/${t}`,{method:"DELETE"}))(e.pipeline_id,t);a.success?l():alert(a.message||(0,c.__)("Failed to delete step","data-machine"))}catch(e){console.error("Step deletion error:",e),alert((0,c.__)("An error occurred while deleting the step","data-machine"))}},[e.pipeline_id,l]),y=(0,a.useCallback)(t=>{const a=e.pipeline_config?.[t.pipeline_step_id]||{};i(x,{pipelineId:e.pipeline_id,pipelineStepId:t.pipeline_step_id,stepType:t.step_type,currentConfig:a})},[e.pipeline_id,e.pipeline_config,i]);return(0,t.createElement)(t.Fragment,null,(0,t.createElement)(s.Card,{className:"datamachine-pipeline-card",size:"large"},(0,t.createElement)(s.CardBody,null,(0,t.createElement)(S,{pipelineId:e.pipeline_id,pipelineName:e.pipeline_name,onNameChange:m,onDelete:f}),(0,t.createElement)(s.CardDivider,null),(0,t.createElement)(z,{pipelineId:e.pipeline_id,steps:e.pipeline_steps||[],pipelineConfig:e.pipeline_config||{},onStepAdded:h,onStepRemoved:g,onStepConfigured:y}),(0,t.createElement)(s.CardDivider,null),(0,t.createElement)(F,{pipelineId:e.pipeline_id}),(0,t.createElement)(s.CardDivider,null),(0,t.createElement)(me,{pipelineId:e.pipeline_id,flows:n,pipelineSteps:e.pipeline_steps||[],pipelineConfig:e.pipeline_config||{}}))),d===_&&(0,t.createElement)(U,{isOpen:!0,onClose:o,...p,onSuccess:()=>{o(),l()}}),d===x&&(0,t.createElement)(V,{isOpen:!0,onClose:o,...p,onSuccess:()=>{o(),l()}}))}function fe(){const{selectedPipelineId:e,setSelectedPipelineId:a}=r(),{pipelines:n,loading:l}=h();if(l||0===n.length)return null;const i=n.map(e=>({label:e.pipeline_name||(0,c.__)("Untitled Pipeline","data-machine"),value:e.pipeline_id}));return(0,t.createElement)("div",{className:"datamachine-pipeline-selector-wrapper",style:{marginBottom:"20px"}},(0,t.createElement)(s.SelectControl,{label:(0,c.__)("Select Pipeline","data-machine"),value:e||i[0]?.value||"",options:i,onChange:e=>{a(e)},className:"datamachine-pipeline-selector"}))}function he(){const{selectedPipelineId:e,setSelectedPipelineId:n,refreshTrigger:l,openModal:i,closeModal:o,activeModal:d,modalData:p,refreshData:m}=r(),{pipelines:f,loading:g,error:_}=h(e),{flows:y,loading:x,error:E}=(e=>{const[t,n]=(0,a.useState)([]),[l,i]=(0,a.useState)(!0),[o,r]=(0,a.useState)(null),[c,s]=(0,a.useState)(0),d=(0,a.useCallback)(async()=>{if(e){i(!0),r(null);try{const t=await(async e=>await u(`/flows?pipeline_id=${e}`))(e);t.success?n(t.data||[]):r(t.message||"Failed to fetch flows")}catch(e){console.error("useFlows error:",e),r(e.message||"An error occurred")}finally{i(!1)}}else i(!1)},[e,c]),p=(0,a.useCallback)(()=>{s(e=>e+1)},[]);return(0,a.useEffect)(()=>{d()},[d]),{flows:t,loading:l,error:o,refetch:p}})(e),[b,v]=(0,a.useState)(!1);(0,a.useEffect)(()=>{f.length>0&&!e&&n(f[0].pipeline_id)},[f,e,n]);const C=(0,a.useCallback)(async()=>{v(!0);try{const e=await(async()=>await u("/pipelines",{method:"POST",data:{pipeline_name:"New Pipeline"}}))();e.success&&e.data.pipeline_id&&(n(e.data.pipeline_id),m())}catch(e){console.error("Error creating pipeline:",e)}finally{v(!1)}},[n,m]);if(g||x)return(0,t.createElement)("div",{className:"datamachine-pipelines-loading"},(0,t.createElement)(s.Spinner,null),(0,t.createElement)("p",null,(0,c.__)("Loading pipelines...","data-machine")));if(_||E)return(0,t.createElement)(s.Notice,{status:"error",isDismissible:!1},(0,t.createElement)("p",null,_||E));if(0===f.length)return(0,t.createElement)(s.Notice,{status:"info",isDismissible:!1},(0,t.createElement)("p",null,(0,c.__)("No pipelines found. Create a pipeline to get started.","data-machine")));const S=f.find(t=>t.pipeline_id===e)||f[0];return(0,t.createElement)("div",{className:"datamachine-pipelines-react-app"},(0,t.createElement)("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"20px"}},(0,t.createElement)(s.Button,{variant:"primary",onClick:C,disabled:b,isBusy:b},(0,c.__)("Add New Pipeline","data-machine")),(0,t.createElement)(s.Button,{variant:"secondary",onClick:()=>i(w)},(0,c.__)("Import / Export","data-machine"))),(0,t.createElement)(fe,null),(0,t.createElement)(ue,{pipeline:S,flows:y}),d===w&&(0,t.createElement)(le,{isOpen:!0,onClose:o,pipelines:f,onSuccess:()=>{o(),m()}}))}l()(()=>{const e=document.getElementById("datamachine-react-root");e?window.dataMachineConfig?(0,a.render)((0,t.createElement)(o,null,(0,t.createElement)(he,null)),e):console.error("Data Machine: Configuration not found"):console.error("Data Machine: React root element not found")})})();