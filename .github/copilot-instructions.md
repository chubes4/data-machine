## Data Machine Copilot Guide
- **Orientation** Skim `datamachine/docs/overview.md`, `docs/architecture.md`, and `CLAUDE.md`; `datamachine.php` checks PHP/WP versions, loads Composer + Action Scheduler, and hooks `run_datamachine()` on `plugins_loaded`.
- **Pipeline hierarchy** Pipelines → Flows → Jobs; flows clone pipeline steps + scheduling, jobs store execution + engine_data (`inc/Core/Database/{Pipelines,Flows,Jobs,ProcessedItems}` filters document schema & helpers).
- **Engine loop** `inc/Engine/Actions/DataMachineActions.php` drives `datamachine_run_flow_now` → `datamachine_execute_step` → `datamachine_schedule_next_step`; background runs depend on `vendor/woocommerce/action-scheduler`.
- **Autoload contracts** `composer.json` auto-loads every `*Filters.php`; new services must expose filters/actions so `run_datamachine()` can register them automatically.
- **Database access** Resolve repositories via `apply_filters('datamachine_db', [])`; classes in `inc/Core/Database/**` assume sanitized input and manage table lifecycle (see activation hook in `datamachine.php`).
- **ID discipline** Keep `pipeline_step_id` UUIDs immutable, derive flow IDs with `datamachine_generate_flow_step_id()`, and split IDs via helpers under `inc/Core/Steps` instead of manual parsing.
- **Data packet contract** Build AI-visible payloads with `datamachine_data_packet` (`inc/Engine/Filters/DataPacket.php`); persist URLs/media separately through `datamachine_engine_data` (`inc/Engine/Filters/EngineData.php`) and read them before publish/update work.
- **Dedup & filtering** Fetch handlers should return `['processed_items'=>...]`, fire `do_action('datamachine_mark_item_processed', ...)`, and reuse `datamachine_timeframe_limit` / `datamachine_keyword_search_match` from `inc/Engine/Filters/Handlers.php`.
- **Directive stack** AI directives register in fixed order (PluginCore → GlobalSystemPrompt → PipelineSystem → ToolDefinitions → SiteContext) across `inc/Core/Steps/AI/Directives` and `inc/Engine/AI/Directives`; chat directives live under `inc/Api/Chat`.
- **Conversation & tools** `inc/Engine/AI/ConversationManager.php` (AIStepConversationManager) and `inc/Core/Steps/AI/AIStepToolParameters.php` manage turn history plus flat tool parameters; handler tools only surface when the next step’s handler slug matches.
- **Tool gating** Honor three gates: global tool toggles (`datamachine_get_enabled_general_tools()`), per-step modal selections, and runtime `apply_filters('datamachine_tool_configured', ...)`; global tools reside in `inc/Engine/AI/Tools/*.php`.
- **Handler registration** Use `datamachine_handlers`, `datamachine_auth_providers`, and `chubes_ai_tools` filters; every handler definition needs `type`, `label`, `description`, `requires_auth`, and a `handle_tool_call` implementation aligned with `inc/Core/Steps/Publish/Handlers/**`.
- **WordPress publisher** `inc/Core/Steps/Publish/Handlers/WordPress` delegates to `FeaturedImageHandler`, `TaxonomyHandler`, and `SourceUrlHandler`; system defaults (Settings → Data Machine) override handler config, so read settings before mutating posts.
- **Update steps** `inc/Core/Steps/Update/Handlers/WordPress` no-ops without `source_url` in engine data; ensure upstream fetch handlers or tools (Local Search, WordPress Post Reader) populate it.
- **REST surface** Endpoint classes in `inc/Api/*.php` self-register inside `run_datamachine()`; enforce `manage_options`, return `{success,data,message}`, and emit errors through `do_action('datamachine_log','error',...)`.
- **React admin** Pipelines UI code sits in `inc/Core/Admin/Pages/Pipelines/assets/react`; reuse hooks like `usePipelines`/`useFlows` and the nonce-aware `assets/react/utils/api.js` wrapper instead of rolling custom fetch logic.
- **AutoSave workflow** Trigger `do_action('datamachine_auto_save', $pipeline_id)` to persist pipelines, flows, schedules, and clear caches—never update those tables directly.
- **Cache management** Call the actions from `inc/Engine/Actions/Cache.php` (`datamachine_clear_pipeline_cache`, `datamachine_clear_flow_steps_cache`, `datamachine_clear_all_cache`, etc.) instead of deleting transients manually.
- **Logging & debugging** Use `do_action('datamachine_log', $level, $message, $context)` for diagnostics; activation sets up `wp-content/uploads/datamachine-logs` and Monolog wiring lives in `inc/Engine/Filters/Logger.php`.
- **Developer workflow** `composer install` (with Yoast polyfills) sets PHP deps, `npm run start` runs the wp-scripts dev server, `npm run build` outputs production assets, and `composer test` / `test:unit` / `test:integration` run PHPUnit (tests are light but wired).
- **Release packaging** `./build.sh` installs prod deps, runs `npm run build`, respects `.buildignore`, zips to `dist/datamachine.zip`, then restores dev deps—verify required/excluded file lists before distributing.
- **Action Scheduler** `datamachine.php` loads `vendor/woocommerce/action-scheduler` when missing; schedule-aware features assume this bootstrap completed before queueing work.
- **Cross-plugin contracts** Sibling repos (`datamachine-*`) depend on shared hooks; document signature changes in `MIGRATION-PLAN.md`, stick to `datamachine_` / `datamachine-` prefixes, and avoid touching legacy `dm_` identifiers.
