## Data Machine Copilot Guide
- **Orientation** Skim `datamachine/docs/overview.md`, `docs/architecture.md`, and root `CLAUDE.md`; `datamachine.php` guards PHP/WP versions, loads Composer + Action Scheduler, then hooks `run_datamachine()` on `plugins_loaded` to register every service.
- **Pipeline Stack** Pipelines → Flows → Jobs; flow steps mirror pipeline steps + scheduling, jobs persist execution + `engine_data` via `inc/Core/Database/{Pipelines,Flows,Jobs,ProcessedItems}` repositories resolved through `apply_filters('datamachine_db', [])`.
- **Engine Loop** `inc/Engine/Actions/DataMachineActions.php` drives `datamachine_run_flow_now` → `datamachine_execute_step` → `datamachine_schedule_next_step`; background execution requires `vendor/woocommerce/action-scheduler` to be loaded.
- **Autoload Contracts** `composer.json` auto-loads every `*Filters.php`; new features must expose hooks so `run_datamachine()` (and activation) can pull them in automatically.
- **IDs & Step Helpers** Treat pipeline step UUIDs as immutable, derive flow step IDs via `datamachine_generate_flow_step_id()`, and use helpers in `inc/Core/Steps` instead of manual parsing when cloning/scheduling.
- **Data Separation** Build AI-visible payloads with `datamachine_data_packet` (`inc/Engine/Filters/DataPacket.php`); persist URLs/media through `datamachine_engine_data` (`inc/Engine/Filters/EngineData.php`) and fetch them before publish/update handlers mutate content.
- **Dedup & Filtering** Fetch handlers must return `['processed_items'=>...]`, fire `do_action('datamachine_mark_item_processed', ...)`, and reuse `datamachine_timeframe_limit` / `datamachine_keyword_search_match` filters from `inc/Engine/Filters/Handlers.php` to stay consistent.
- **Directive Stack** RequestBuilder applies directives in order (Global System Prompt → Site Context → Pipeline Core/System/Context → Tool Definitions → Agent-specific extras); chat-only directives live in `inc/Api/Chat`.
- **Universal Engine** Shared AI layer at `inc/Engine/AI/` (AIConversationLoop, ConversationManager, ToolExecutor, ToolParameters, RequestBuilder, ToolResultFinder) powers both pipeline and chat agents; don’t bypass these when adding AI features.
- **Tool Parameters** `ToolParameters::buildParameters()` builds general tool payloads while `buildForHandlerTool()` merges handler config + engine data for publish/update tools—call the right helper so source URLs and media survive the jump.
- **Tool Gating** Tools pass three gates: global toggles (`datamachine_get_enabled_general_tools()`), per-step modal selections, and runtime `apply_filters('datamachine_tool_configured', ...)`; global tools live under `inc/Engine/AI/Tools/*.php`, handler tools register via `chubes_ai_tools`.
- **Handler Registration** Use `datamachine_handlers`, `datamachine_auth_providers`, and `chubes_ai_tools` filters; each definition needs `type`, `label`, `description`, `requires_auth`, and a `handle_tool_call` aligned with patterns in `inc/Core/Steps/Publish/Handlers/**` or Update equivalents.
- **WordPress Publisher** The WP publish handler delegates to `FeaturedImageHandler`, `TaxonomyHandler`, and `SourceUrlHandler`; settings from Settings → Data Machine override handler config, so consult defaults before writing posts.
- **Update Steps** `inc/Core/Steps/Update/Handlers/WordPress` hard-require `source_url` in engine data; ensure fetch handlers or tools like Local Search / WordPress Post Reader populate it before scheduling updates.
- **REST + React** Admin pages talk exclusively to classes in `inc/Api/**` (16 endpoints plus Chat); the React pipelines app under `inc/Core/Admin/Pages/Pipelines/assets/react` should continue using shared hooks (`usePipelines`, `useFlows`, etc.) and the nonce-aware `assets/react/utils/api.js` wrapper instead of ad-hoc fetch.
- **AutoSave & Scheduling** `do_action('datamachine_auto_save', $pipeline_id)` handles pipeline persistence, flow syncing, and cache invalidation; never mutate `wp_datamachine_*` tables directly or desync execution_order.
- **Cache Management** Prefer actions in `inc/Engine/Actions/Cache.php` (`datamachine_clear_pipeline_cache`, `datamachine_clear_flow_steps_cache`, `datamachine_clear_all_cache`, etc.) over raw transient deletions so pattern-based invalidation remains reliable.
- **Files & Dedup Storage** Flow files live in flow-specific UUID folders with automatic cleanup; dedup tables expect sanitized identifiers and should be touched via repository filters only.
- **Logging & Debugging** Use `do_action('datamachine_log', $level, $message, $context)`; activation provisions `/wp-content/uploads/datamachine-logs`, and Monolog wiring plus log level filters reside in `inc/Engine/Filters/Logger.php`.
- **Developer Workflow** `composer install` (Yoast polyfills enabled) pulls PHP deps, `npm run start` launches wp-scripts dev server for React assets, `npm run build` creates production bundles, and PHPUnit targets exist via `composer test`, `test:unit`, `test:integration`, `test:coverage`.
- **Release Packaging** `./build.sh` enforces `.buildignore`, installs prod Composer deps, runs `npm run build`, verifies required files, zips to `dist/datamachine.zip`, then restores dev deps—don’t ship without running it end-to-end.
- **Action Scheduler & Jobs** `datamachine.php` loads `vendor/woocommerce/action-scheduler` when absent; scheduled flows/log cleanup assume this bootstrap completed before queueing.
- **Cross-Plugin Contracts** Sibling repos (`datamachine-*`) rely on shared hooks documented in `MIGRATION-PLAN.md`; keep the `datamachine_` / `datamachine-` prefixes, announce signature changes, and never reintroduce legacy `dm_` identifiers.
