## Data Machine Copilot Guide
- **Start here** Skim `docs/overview.md`, `docs/architecture.md`, and `CLAUDE.md`; `datamachine.php` bootstraps core services once `datamachine_check_requirements()` succeeds.
- **Autoload pattern** `composer.json` maps `DataMachine\Core\` and `DataMachine\Engine\` to `inc/`; any `*Filters.php` file registers hooks on load, so new services belong in that pattern and require no manual includes.
- **Pipeline lifecycle** Pipelines (templates) → flows (configured instances) → jobs (executions via Action Scheduler under `inc/Engine/Actions`); the execution loop is `datamachine_run_flow_now` → `datamachine_execute_step` → `datamachine_schedule_next_step`.
- **Identifier helpers** Step IDs stay in UUID form at pipeline level; use `datamachine_generate_flow_step_id` / `datamachine_split_*` helpers for `{pipeline_step_id}_{flow_id}` values instead of string manipulation.
- **Database access** Retrieve repositories through `apply_filters('datamachine_db', [])`; concrete services live in `inc/Core/Database/**` and manage the `wp_datamachine_*` tables.
- **Fetch handler contract** Return `['processed_items' => [['data' => ..., 'metadata' => ...], …]]`, mark dedupe state with `datamachine_mark_item_processed`, and reuse `datamachine_timeframe_limit` + `datamachine_keyword_search_match` from `inc/Engine/Filters/Handlers.php`.
- **Data separation** Keep AI-visible packets clean via `datamachine_data_packet`; store source_url/image_url with `datamachine_engine_data` and read them inside publish/update handlers rather than embedding URLs in packets.
- **AI directives** System prompts stack at priorities 10→50 (PluginCore, GlobalSystem, PipelineSystem, ToolDefinitions, SiteContext); `AIStepConversationManager` tracks turns and `AIStepToolParameters` builds flat tool payloads.
- **Tool enablement** Tools only execute when globally enabled, selected in the pipeline modal, and `datamachine_tool_configured` confirms credentials—mirror that three-layer check before exposing new capabilities.
- **Handler registration** Register handlers, auth providers, and tools via filters (`datamachine_handlers`, `datamachine_auth_providers`, `ai_tools`) from dedicated namespace files; follow existing array shape for label, description, and `requires_auth` metadata.
- **WordPress publish modules** `inc/Core/Steps/Publish/Handlers/WordPress` delegates to `FeaturedImageHandler`, `TaxonomyHandler`, and `SourceUrlHandler`; respect the config hierarchy where system defaults override per-step settings.
- **Update workflows** Update steps expect a stored `source_url`; ensure upstream fetch/tools populate engine data or the update handler will no-op.
- **REST surface** REST routes live in `inc/Api/*.php` and self-register during `run_data_machine()`; use the existing `->register()` structure and `manage_options` capability checks when adding endpoints.
- **Ephemeral workflows** Execute workflows without database persistence via `POST /datamachine/v1/execute` with `workflow` parameter; supports immediate/delayed execution but not recurring—use database flows for scheduling.
- **Caching** Mutations must clear caches through `datamachine_clear_*` actions in `inc/Engine/Actions/Cache.php`; never touch transients directly.
- **Logging** Emit diagnostics with `do_action('datamachine_log', $level, $message, $context_array)` so Monolog + rotation stay centralized.
- **OAuth & storage** Route new providers through `datamachine_auth_providers`, persist secrets with `datamachine_store_oauth_account` / `_keys`, and use `/datamachine-auth/{provider}/` URLs.
- **Prefix migration** Code uses `datamachine_` prefix throughout (filters, actions, functions, cache keys, options, transients); database table names pending Phase 3 migration.
- **Admin UX** Modify admin assets in `inc/Core/Admin/Pages/Pipelines/assets` (not `dist/`), and lean on the universal handler settings template + `datamachine_get_handler_settings_display` filter for customization.
- **Scheduler assumptions** Vendor Action Scheduler (`vendor/woocommerce/action-scheduler`) must be loaded before scheduling helpers in `inc/Core/Steps/**`; check for queue availability in long-running jobs.
- **Tests & builds** Run `composer install` for setup, `composer test` / `composer test:unit` for PHPUnit (WordPress polyfills included), and `./build.sh` for release zips—build script reinstalls dev deps automatically.
- **Ecosystem impact** Extensions in sibling repos consume these filters; coordinate breaking changes and update migration guidance in `MIGRATION-PLAN.md` when altering hook signatures.
- **Migration awareness** Phase 2 migration (dm_ → datamachine_) complete for all code components; Phase 3 database table migration complete (wp_datamachine_* tables).
- **React architecture** Pipelines page uses complete React implementation (6,591 lines) with Context API, custom hooks, and zero jQuery—follow this pattern for new admin interfaces.
- **Engine data pattern** Fetch handlers store source_url/image_url via `datamachine_engine_data(null, $job_id, $source_url, $image_url)`; handlers retrieve via `apply_filters('datamachine_engine_data', [], $job_id)` for clean separation.
- **Tool-first AI** All publish handlers implement `handle_tool_call()` for agentic execution; use `AIStepToolParameters::buildForHandlerTool()` for unified parameter building with engine data merging.
- **Centralized filters** Shared functionality lives in `inc/Engine/Filters/Handlers.php`: `datamachine_timeframe_limit`, `datamachine_keyword_search_match`, `datamachine_data_packet`—extend these for consistency.
- **AutoSave system** Complete pipeline persistence via `datamachine_auto_save` action handles all data, flow synchronization, and cache invalidation—never manually save partial pipeline state.
- **Universal handler settings** Use `inc/Core/Admin/Pages/Pipelines/templates/modal/handler-settings.php` template with `datamachine_enabled_settings` filter for consistent UI; handlers with `requires_auth: true` get automatic auth detection.
- **React patterns** Follow `usePipelines`/`useFlows` hooks pattern with `apiFetch` wrapper in `assets/react/utils/api.js`; use Context API for global state management and `PipelineContext` for app-wide coordination.
- **Conversation management** Use `AIStepConversationManager` methods: `formatToolCallMessage()` with turn tracking, `updateDataPacketMessages()` for JSON synchronization, `validateToolCall()` for duplicate detection—maintain chronological message ordering.
